<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
        <title>Michal Zimmermann - Articles by Michal Zimmermann</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="/feed.xml" type="application/rss+xml" rel="alternate" title="Michal Zimmermann Full RSS Feed" />
        <link rel="stylesheet" href="/theme/webassets-external/fee07050f67182ee94565df0306e2583_foundation.min.css">
        <link rel="stylesheet" href="/theme/webassets-external/c8d3bd219f818a16149faa6dc85ada3b_pygment.css">
        <link rel="stylesheet" href="/theme/webassets-external/f19e9253fe1e12d62d57b9087abc5f7a_screen.css">
</head>

<body id="index" class="home">
    <nav class="top-bar card-1" data-topbar role="navigation">
        <ul class="title-area">
            <li class="name">
                <h1><a href="/posts">Home</a></h1>
            </li>
     <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone -->
            <li class="toggle-topbar menu-icon"><a href="#"><span></span></a></li>
        </ul>
        <section class="top-bar-section">
    <!-- Right Nav Section -->
            <ul class="right">
                <li><a href="/categories">Categories</a></li>
                <li><a href="/tags">Tags</a></li>
                <li><a href="/feed.xml">RSS feed</a></li>
            </ul>
        </section>
    </nav>
        <div class="row">
          <div class="large-12 columns header">
            <h1><a href="/posts">Michal Zimmermann</a> <small>Pieces of knowledge from the world of GIS.</small></h1>
          </div>
        </div>
        <div class="row">
            <div class="large-12 columns">
<h2>Articles by Michal Zimmermann</h2>

    <div class="panel card card-1">
        <div class="post-name">
            <h1><a href="/posts/2016/introducing-blind-maps-project/" rel="bookmark" title="Permalink to Introducing Blind Maps Project">Introducing Blind Maps&nbsp;Project</a></h1>
            <small>Written on Nov 2, 2016
        and marked as
        <a href="/tag/javascript.html">javascript</a>,         <a href="/tag/leaflet.html">leaflet</a>        | <a href="/category/web-maps.html">web maps</a>
        </small>
        <section>
            <p>I&#8217;d like to introduce you to my little pet project, which might just as well be awarded <em>the first pet project I&#8217;ve ever completed</em>, called <a href="https://www.zimmi.cz/blind-maps">Blind maps</a>.</p>
<p>It&#8217;s a very simple, yet useful web application built on top of the great <a href="../../tag/leaflet.html">Leaflet</a> library meant to help you get to know our world a bit better. As the name suggests, the app shows you, well&hellip; a blind map, and you try to fill as many features as you&nbsp;can.</p>
<div class="text-center"><img src="/assets/introducing-blind-maps-project/map.png" /></div>

<p>The app is ready and can be&nbsp;used:</p>
<ul>
<li>online at <a href="https://www.zimmi.cz/blind-maps/">Blind maps</a> with the map of your choice (if&nbsp;available)</li>
<li>offline, downloaded to your computer and filled with whatever data you&nbsp;want</li>
</ul>
<p>What I find great about this project is the ease of adding new dataset. For starters, I filled it with data coming from <a href="naturalearthdata.com">Natural Earth</a>:</p>
<ul>
<li><span class="caps">CONUS</span>&nbsp;states</li>
<li>European&nbsp;states</li>
<li>World&nbsp;capitals</li>
</ul>
<p>If you wish, feel free to send me a pull request with GeoJSON data, I&#8217;ll be happy to have more datasets available! The process is described at the <a href="https://www.zimmi.cz/blind-maps">project homepage</a>.</p>
<p>As you notice at the project homepage, there are two versions of the game&nbsp;available:</p>
<ul>
<li>one lets you find map features by their&nbsp;names</li>
<li>the other one lets you type name highlighted feature (much&nbsp;tougher)</li>
</ul>
<p>Have&nbsp;fun!</p>
        </section>
        </div>
    </div>

    <div class="panel card card-1">
        <div class="post-name">
            <h1><a href="/posts/2016/degrees-to-decimal-with-javascript-reworked/" rel="bookmark" title="Permalink to Degrees To Decimal With Javascript Reworked">Degrees To Decimal With Javascript&nbsp;Reworked</a></h1>
            <small>Written on Oct 28, 2016
        and marked as
        <a href="/tag/javascript.html">javascript</a>        | <a href="/category/development.html">development</a>
        </small>
        <section>
            <p>Two years ago I was pretty happy with <a href="https://www.zimmi.cz/posts/2014/degrees-to-decimal-with-javascript/">this little piece of code to transform degrees to the decimal value</a>. Yesterday, I found a neater way to do the&nbsp;same:</p>
<div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nx">deg</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">];</span>

<span class="kd">function</span> <span class="nx">degToDec</span><span class="p">(</span><span class="nx">prev</span><span class="p">,</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">curIndex</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">prev</span> <span class="o">+</span> <span class="nx">cur</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nx">curIndex</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">deg</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">degToDec</span><span class="p">);</span>
</pre></div>


<p>Once you have an input array, that&#8217;s pretty much it. Love&nbsp;JavaScript.</p>
        </section>
        </div>
    </div>

    <div class="panel card card-1">
        <div class="post-name">
            <h1><a href="/posts/2016/ogrinfo-output-formatting/" rel="bookmark" title="Permalink to Ogrinfo Output Formatting">Ogrinfo Output&nbsp;Formatting</a></h1>
            <small>Written on Oct 21, 2016
        and marked as
        <a href="/tag/gdal.html">gdal</a>        | <a href="/category/automation.html">automation</a>
        </small>
        <section>
            <p>Today my workmate asked if there was a way to see an attribute table other than importing spatial data into a PostGIS database. I told him about <span class="caps">QGIS</span> and while talking about other <span class="caps">GIS</span> stuff, I started thinking about <em>pipes</em> and how awesome it would be to actually format the output of the <code>ogrinfo</code> command.</p>
<p>Here it is. It is just a much longer way to do <code>ogr2ogr -f "CSV" dest source</code>, but sometimes you just have to experiment a&nbsp;bit.</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="nv">FILE</span><span class="o">=</span><span class="nv">$1</span>

<span class="k">function</span> columns <span class="o">{</span>
    ogrinfo <span class="nv">$FILE</span> -al -so <span class="p">|</span> <span class="se">\</span>
    sed <span class="s1">&#39;/Column/,$!d&#39;</span> <span class="p">|</span> <span class="se">\</span>
    sed <span class="s1">&#39;/Geometry Column/d&#39;</span> <span class="p">|</span> <span class="se">\</span>
    sed -e <span class="s1">&#39;s/Column =/\:/g&#39;</span> <span class="p">|</span> <span class="se">\</span>
    awk -F: <span class="s1">&#39;{print $1}&#39;</span> <span class="p">|</span> <span class="se">\</span>
    awk -v <span class="nv">RS</span><span class="o">=</span> -v <span class="nv">OFS</span><span class="o">=</span><span class="s2">&quot;|&quot;</span> <span class="s1">&#39;{$1 = $1} 1&#39;</span>
<span class="o">}</span>

<span class="k">function</span> data <span class="o">{</span>
   ogrinfo <span class="nv">$FILE</span> -al <span class="p">|</span> <span class="se">\</span>
   sed <span class="s1">&#39;/OGRFeature/,$!d&#39;</span> <span class="p">|</span> <span class="se">\</span>
   sed <span class="s1">&#39;/POLYGON\|LINESTRING\|POINT/ d&#39;</span> <span class="p">|</span> <span class="se">\</span>
   sed -e <span class="s1">&#39;s/OGRFeature\(.*\)\://g&#39;</span> <span class="p">|</span> <span class="se">\</span>
   sed -e <span class="s1">&#39;s/.*\s*\(.*\)\s*=\s*//g&#39;</span> <span class="p">|</span> <span class="se">\</span>
   awk -v <span class="nv">RS</span><span class="o">=</span> -v <span class="nv">OFS</span><span class="o">=</span><span class="s2">&quot;|&quot;</span> <span class="s1">&#39;{$1 = $1} 1&#39;</span>
<span class="o">}</span>

<span class="o">{</span> columns<span class="p">;</span> data<span class="p">;</span> <span class="o">}</span>
</pre></div>


<p>The result can be piped to other <code>bash</code> functions, such as <code>less</code> or <code>more</code>. I call it <code>ogrinfotable</code>.</p>
        </section>
        </div>
    </div>

    <div class="panel card card-1">
        <div class="post-name">
            <h1><a href="/posts/2016/postgis-custom-function-to-create-wind-rose/" rel="bookmark" title="Permalink to PostGIS Custom Function to Create Wind Rose">PostGIS Custom Function to Create Wind&nbsp;Rose</a></h1>
            <small>Written on Sep 1, 2016
        and marked as
        <a href="/tag/postgis.html">postgis</a>,         <a href="/tag/postgresql.html">postgresql</a>,         <a href="/tag/sql.html">sql</a>        | <a href="/category/sql.html">SQL</a>
        </small>
        <section>
            <p>I&#8217;ve come across the <a href="http://gis.stackexchange.com/questions/208797/draw-wind-rose-with-qgis-from-postgis/">beautiful <span class="caps">GIS</span> StackExchange question</a> recently, asking how to draw a <a href="https://en.wikipedia.org/wiki/Wind_rose">wind rose</a> within&nbsp;PostGIS.</p>
<div class="text-center">
<img src="http://i.stack.imgur.com/0xAMU.png">
</div>

<p>It&#8217;s pretty easy to accomplish this with a custom <span class="caps">PLPGSQL</span> procedure below, that takes line geometry, number of sections and radius of the inner circle as&nbsp;parameters.</p>
<!-- codeblock -->

<div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="n">ST_WindRose</span><span class="p">(</span>
    <span class="n">line</span> <span class="n">geometry</span><span class="p">,</span>
    <span class="n">directions</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">radius</span> <span class="nb">numeric</span>
<span class="p">)</span>
<span class="k">RETURNS</span> <span class="k">TABLE</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">geom</span> <span class="n">geometry</span><span class="p">(</span><span class="n">LINESTRING</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">AS</span> <span class="err">$</span><span class="n">ST_WindRose$</span>
<span class="k">BEGIN</span>
    <span class="k">IF</span> <span class="n">directions</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">THEN</span>
        <span class="n">RAISE</span> <span class="k">EXCEPTION</span> <span class="s1">&#39;Odd number of directions found, please provide even number of directions instead.&#39;</span><span class="p">;</span>
    <span class="k">END</span> <span class="k">IF</span><span class="p">;</span>

<span class="k">IF</span> <span class="n">radius</span> <span class="o">&gt;</span> <span class="n">ST_Length</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">THEN</span>
    <span class="n">RAISE</span> <span class="k">EXCEPTION</span> <span class="s1">&#39;Inner circle radius is bigger than the wind rose diameter, please make it smaller.&#39;</span><span class="p">;</span>
<span class="k">END</span> <span class="k">IF</span><span class="p">;</span>

<span class="k">RETURN</span> <span class="n">QUERY</span>
<span class="k">WITH</span> <span class="n">rose</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">ST_Rotate</span><span class="p">(</span><span class="n">_line</span><span class="p">,</span> <span class="n">radians</span><span class="p">(</span><span class="mi">360</span><span class="p">)</span> <span class="o">/</span> <span class="n">directions</span> <span class="o">*</span> <span class="n">dirs</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ST_Centroid</span><span class="p">(</span><span class="n">_line</span><span class="p">))</span> <span class="n">_line</span>
    <span class="k">FROM</span> <span class="p">(</span>
        <span class="k">SELECT</span> <span class="n">line</span> <span class="n">_line</span>
    <span class="p">)</span> <span class="n">a</span>
    <span class="k">CROSS</span> <span class="k">JOIN</span> <span class="p">(</span>
        <span class="k">SELECT</span> <span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">directions</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="n">id</span>
    <span class="p">)</span> <span class="n">dirs</span>
<span class="p">)</span>
<span class="k">SELECT</span>
    <span class="n">row_number</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">()::</span><span class="nb">integer</span> <span class="n">id</span><span class="p">,</span>
    <span class="n">_line</span> <span class="n">geom</span>
<span class="k">FROM</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">_line</span> <span class="k">FROM</span> <span class="n">rose</span>
    <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="k">SELECT</span> <span class="n">ST_ExteriorRing</span><span class="p">(</span><span class="n">ST_Buffer</span><span class="p">(</span><span class="n">ST_Centroid</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">radius</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="c1">-- inner circle</span>
    <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="k">SELECT</span> <span class="n">ST_ExteriorRing</span><span class="p">(</span><span class="n">ST_Buffer</span><span class="p">(</span><span class="n">ST_Centroid</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">ST_Length</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="c1">-- outer circle</span>
<span class="p">)</span> <span class="n">a</span><span class="p">;</span>
<span class="k">END</span>
<span class="err">$</span><span class="n">ST_WindRose$</span>
<span class="k">LANGUAGE</span> <span class="n">PLPGSQL</span><span class="p">;</span>
</pre></div>


<p>Wind rose created with this function might look like the one&nbsp;below.</p>
<div class="text-center">
<img src="http://i.stack.imgur.com/4OD0J.png">
</div>

<p>Run it as follows. The <code>line</code> parameter should be a simple straight line made of just two&nbsp;vertices.</p>
<!-- codeblock -->

<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">ST_WindRose</span><span class="p">(</span><span class="n">ST_MakeLine</span><span class="p">(</span><span class="n">ST_MakePoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">ST_MakePoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="p">);</span>
</pre></div>
        </section>
        </div>
    </div>

    <div class="panel card card-1">
        <div class="post-name">
            <h1><a href="/posts/2016/postgis-custom-function-to-create-polygon-from-centroid/" rel="bookmark" title="Permalink to PostGIS Custom Function to Create Polygon from Centroid">PostGIS Custom Function to Create Polygon from&nbsp;Centroid</a></h1>
            <small>Written on Aug 28, 2016
        and marked as
        <a href="/tag/postgis.html">postgis</a>,         <a href="/tag/postgresql.html">postgresql</a>,         <a href="/tag/sql.html">sql</a>        | <a href="/category/sql.html">SQL</a>
        </small>
        <section>
            <p>Needed to create a polygon from a point defining its size in both axes, here&#8217;s a little syntax sugar to make life&nbsp;easier.</p>
<!-- codeblock -->

<div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="n">ST_PolygonFromCentroid</span><span class="p">(</span><span class="n">centroid</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">xsize</span> <span class="nb">numeric</span><span class="p">,</span> <span class="n">ysize</span> <span class="nb">numeric</span><span class="p">)</span>
<span class="k">RETURNS</span> <span class="n">geometry</span>
<span class="k">AS</span> <span class="err">$</span><span class="n">ST_PolygonFromCentroid$</span>
<span class="k">SELECT</span> <span class="n">ST_MakeEnvelope</span><span class="p">(</span>
    <span class="n">ST_X</span><span class="p">(</span><span class="n">ST_Translate</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="err">$</span><span class="mi">3</span><span class="p">)),</span>
    <span class="n">ST_Y</span><span class="p">(</span><span class="n">ST_Translate</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="err">$</span><span class="mi">3</span><span class="p">)),</span>
    <span class="n">ST_X</span><span class="p">(</span><span class="n">ST_Translate</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">)),</span>
    <span class="n">ST_Y</span><span class="p">(</span><span class="n">ST_Translate</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">))</span>
<span class="p">);</span>
<span class="err">$</span><span class="n">ST_PolygonFromCentroid$</span>
<span class="k">LANGUAGE</span> <span class="k">SQL</span><span class="p">;</span>
</pre></div>


<p>Run it&nbsp;as:</p>
<!-- codeblock -->

<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_PolygonFromCentroid</span><span class="p">(</span><span class="n">ST_SetSRID</span><span class="p">(</span><span class="n">ST_MakePoint</span><span class="p">(</span><span class="mi">13</span><span class="p">.</span><span class="mi">912</span><span class="p">,</span><span class="mi">50</span><span class="p">.</span><span class="mi">633</span><span class="p">),</span><span class="mi">4326</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
        </section>
        </div>
    </div>

    <div class="panel card card-1">
        <div class="post-name">
            <h1><a href="/posts/2016/finding-polygons-lying-across-other-polygons-with-postgis/" rel="bookmark" title="Permalink to Finding Polygons Lying across Other Polygons with PostGIS">Finding Polygons Lying across Other Polygons with&nbsp;PostGIS</a></h1>
            <small>Written on Aug 5, 2016
        and marked as
        <a href="/tag/postgis.html">postgis</a>,         <a href="/tag/postgresql.html">postgresql</a>,         <a href="/tag/sql.html">sql</a>        | <a href="/category/sql.html">SQL</a>
        </small>
        <section>
            <p>Doing overlays (<code>ST_Intersection()</code>) in PostGIS based on spatial relationships (<code>ST_Intersects()</code>, <code>ST_Contains()</code>, &hellip;) is so easy it is not something you get particularly excited&nbsp;about.</p>
<p>Today I faced a bit more interesting task: <strong>given two polygon layers, get me all the polygons from layer A such that they lie across the polygons from layer B and&hellip; a picture worth a thousand words,&nbsp;right?</strong></p>
<div class="text-center"><img src="/assets/finding-polygons-lying-across-other-polygons-with-postgis/polygons.svg" /></div>

<p>I hope you got the idea, it is fairly&nbsp;simple:</p>
<ol>
<li>Intersect A (red, blue) with B&nbsp;(green)</li>
<li>Subtract the result of previous from layer&nbsp;A</li>
<li>Combine results from steps 1 and&nbsp;2</li>
<li>Keep polygon only if its id occurs more than twice (that means it went straight through the layer&nbsp;B)</li>
<li>Profit!</li>
</ol>
<!-- codeblock -->

<div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="n">overlays</span> <span class="k">AS</span> <span class="p">(</span>
<span class="cm">/* nothing fancy here */</span>
    <span class="k">SELECT</span>
        <span class="n">A</span><span class="p">.</span><span class="n">ogc_fid</span> <span class="n">a_id</span><span class="p">,</span>
        <span class="n">B</span><span class="p">.</span><span class="n">ogc_fid</span> <span class="n">b_id</span><span class="p">,</span>
        <span class="n">ST_Intersection</span><span class="p">(</span><span class="n">A</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">B</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="n">geom</span><span class="p">,</span>
        <span class="n">ST_Area</span><span class="p">(</span><span class="n">ST_Intersection</span><span class="p">(</span><span class="n">A</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">B</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="n">area_shared</span>
    <span class="k">FROM</span> <span class="n">A</span>
    <span class="k">JOIN</span> <span class="n">B</span> <span class="k">ON</span> <span class="p">(</span><span class="n">ST_Intersects</span><span class="p">(</span><span class="n">A</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">B</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="p">),</span>
<span class="n">diffs</span> <span class="k">AS</span> <span class="p">(</span>
<span class="cm">/* note this is a 1:1 relationship in ST_Difference */</span>
<span class="cm">/* a little hack is needed to prevent PostGIS from returning its usual difference mess */</span>
    <span class="k">SELECT</span>
        <span class="n">o</span><span class="p">.</span><span class="n">a_id</span><span class="p">,</span>
        <span class="n">o</span><span class="p">.</span><span class="n">b_id</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ST_Dump</span><span class="p">(</span><span class="n">ST_Difference</span><span class="p">(</span><span class="n">ST_Buffer</span><span class="p">(</span><span class="n">A</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="mi">0001</span><span class="p">),</span> <span class="n">o</span><span class="p">.</span><span class="n">geom</span><span class="p">))).</span><span class="n">geom</span><span class="p">,</span> <span class="c1">-- ugly hack</span>
        <span class="n">o</span><span class="p">.</span><span class="n">area_shared</span>
    <span class="k">FROM</span> <span class="n">overlays</span> <span class="n">o</span>
    <span class="k">JOIN</span> <span class="n">A</span> <span class="k">ON</span> <span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="n">A</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
<span class="p">),</span>

<span class="n">merged</span> <span class="k">AS</span> <span class="p">(</span>
<span class="cm">/* put those two result sets together */</span>
    <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">overlays</span>
    <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">diffs</span>
<span class="p">),</span>

<span class="n">merged_reduced</span> <span class="k">AS</span> <span class="p">(</span>
<span class="cm">/* get only those A polygons that consist of three parts at least for each intersection with B polygon */</span>
  <span class="k">SELECT</span>
    <span class="n">m</span><span class="p">.</span><span class="o">*</span>
  <span class="k">FROM</span> <span class="n">merged</span> <span class="n">m</span>
  <span class="k">JOIN</span> <span class="p">(</span>
    <span class="k">SELECT</span>
      <span class="n">a_id</span><span class="p">,</span>
      <span class="n">b_id</span>
    <span class="k">FROM</span> <span class="n">merged</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">a_id</span><span class="p">,</span> <span class="n">b_id</span>
    <span class="k">HAVING</span> <span class="k">COUNT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span>
  <span class="p">)</span> <span class="n">a</span> <span class="k">ON</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">a_id</span> <span class="k">AND</span> <span class="n">a</span><span class="p">.</span><span class="n">b_id</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">b_id</span><span class="p">)</span>
<span class="p">)</span>
<span class="cm">/* do as you wish with the result */</span>
<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">merged_reduced</span><span class="p">;</span>
</pre></div>


<p>In my case, centerlines of layer B were also included and their length inside each intersection was used to divide the area of the smallest part with. It was fun,&nbsp;actually.</p>
        </section>
        </div>
    </div>

    <div class="panel card card-1">
        <div class="post-name">
            <h1><a href="/posts/2016/dead-simple-random-points-in-polygons-with-postgis/" rel="bookmark" title="Permalink to Dead Simple Random Points in Polygons with PostGIS">Dead Simple Random Points in Polygons with&nbsp;PostGIS</a></h1>
            <small>Written on Aug 3, 2016
        and marked as
        <a href="/tag/postgis.html">postgis</a>,         <a href="/tag/postgresql.html">postgresql</a>,         <a href="/tag/sql.html">sql</a>        | <a href="/category/sql.html">SQL</a>
        </small>
        <section>
            <p>Since PostgreSQL 9.3 there has been a handy little keyword called <code>LATERAL</code>, which - combined with <code>JOIN</code> - might rock your <span class="caps">GIS</span> world in a second. To keep it simple, a <code>LATERAL JOIN</code> enables a subquery in the <code>FROM</code> part of a query to reference columns from preceding expressions in the <code>FROM</code> list. What the&nbsp;heck?</p>
<p>Imagine that not so unusual request to <strong>generate random points in polygons</strong> (something I needed to do today). Do it automatically without your favorite piece of desktop <span class="caps">GIS</span>&nbsp;software.</p>
<p>It is pretty easy using <code>LATERAL JOIN</code>:</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
    <span class="n">b</span><span class="p">.</span><span class="o">*</span>
<span class="k">FROM</span> <span class="p">(</span>
    <span class="k">VALUES</span><span class="p">(</span>
        <span class="mi">1</span><span class="p">,</span>
        <span class="n">ST_SetSRID</span><span class="p">(</span>
            <span class="n">ST_GeomFromText</span><span class="p">(</span>
                <span class="s1">&#39;POLYGON((0 0, -1 0, -1 -1, 0 -1, 0 0))&#39;</span>
            <span class="p">),</span>
        <span class="mi">4326</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="k">VALUES</span><span class="p">(</span>
        <span class="mi">2</span><span class="p">,</span>
        <span class="n">ST_SetSRID</span><span class="p">(</span>
            <span class="n">ST_GeomFromText</span><span class="p">(</span>
                <span class="s1">&#39;POLYGON((0 0, 1 0, 1 1, 0 1, 0 0))&#39;</span>
            <span class="p">),</span>
        <span class="mi">4326</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span> <span class="n">a</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="k">LATERAL</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">ST_SetSRID</span><span class="p">(</span><span class="n">ST_MakePoint</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">y</span><span class="p">),</span> <span class="mi">4326</span><span class="p">)</span> <span class="n">geom</span>
    <span class="k">FROM</span> <span class="p">(</span>
        <span class="k">SELECT</span>
            <span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">ST_XMax</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="o">-</span> <span class="n">ST_XMin</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span> <span class="o">+</span> <span class="n">ST_XMin</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="n">x</span><span class="p">,</span>
            <span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">ST_YMax</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="o">-</span> <span class="n">ST_YMin</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span> <span class="o">+</span> <span class="n">ST_YMin</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="n">y</span>
        <span class="k">FROM</span> <span class="n">generate_series</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">200</span><span class="p">)</span>
    <span class="p">)</span> <span class="n">tmp</span>
<span class="p">)</span> <span class="n">b</span><span class="p">;</span>
</pre></div>


<p>What actually happened over there? If you want to put points inside polygons, you need&#8230; polygons. We will do just fine with two of them created inside this&nbsp;query:</p>
<div class="highlight"><pre><span></span><span class="k">VALUES</span><span class="p">(</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="n">ST_SetSRID</span><span class="p">(</span>
        <span class="n">ST_GeomFromText</span><span class="p">(</span>
            <span class="s1">&#39;POLYGON((0 0, -1 0, -1 -1, 0 -1, 0 0))&#39;</span>
        <span class="p">),</span>
    <span class="mi">4326</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">UNION</span> <span class="k">ALL</span>
<span class="k">VALUES</span><span class="p">(</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="n">ST_SetSRID</span><span class="p">(</span>
        <span class="n">ST_GeomFromText</span><span class="p">(</span>
            <span class="s1">&#39;POLYGON((0 0, 1 0, 1 1, 0 1, 0 0))&#39;</span>
        <span class="p">),</span>
    <span class="mi">4326</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>


<p>All the magic happens inside the <code>LATERAL JOIN</code> part of the&nbsp;query:</p>
<div class="highlight"><pre><span></span><span class="k">CROSS</span> <span class="k">JOIN</span> <span class="k">LATERAL</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">ST_SetSRID</span><span class="p">(</span><span class="n">ST_MakePoint</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">y</span><span class="p">),</span> <span class="mi">4326</span><span class="p">)</span> <span class="n">geom</span>
    <span class="k">FROM</span> <span class="p">(</span>
        <span class="k">SELECT</span>
            <span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">ST_XMax</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="o">-</span> <span class="n">ST_XMin</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span> <span class="o">+</span> <span class="n">ST_XMin</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="n">x</span><span class="p">,</span>
            <span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">ST_YMax</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="o">-</span> <span class="n">ST_YMin</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span> <span class="o">+</span> <span class="n">ST_YMin</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="n">y</span>
        <span class="k">FROM</span> <span class="n">generate_series</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">200</span><span class="p">)</span>
    <span class="p">)</span> <span class="n">tmp</span>
<span class="p">)</span> <span class="n">b</span><span class="p">;</span>
</pre></div>


<p>The inner <code>SELECT</code> calculates random points based on the extent of the polygon. Note it directly calls <code>a.geom</code>, a value that comes from the previous <code>SELECT</code>! The <code>LATERAL JOIN</code> part is thus run for every row of the previous <code>SELECT</code> statement inside <code>FROM</code> part of the query. This means it will return 201 points for each of the two polygons (run the query inside <span class="caps">QGIS</span> to see the&nbsp;result).</p>
<p>Note all the points fall inside the polygons by accident, because they are <strong>square</strong>. Otherwise a <code>ST_Contains</code> or <code>ST_Within</code> should be used inside the outermost <code>WHERE</code> query to filter outliers. This part could use some&nbsp;tweaking.</p>
        </section>
        </div>
    </div>

    <div class="panel card card-1">
        <div class="post-name">
            <h1><a href="/posts/2016/syncing-two-postgresql-databases-faster/" rel="bookmark" title="Permalink to Syncing Two PostgreSQL Databases Faster">Syncing Two PostgreSQL Databases&nbsp;Faster</a></h1>
            <small>Written on Jul 17, 2016
        and marked as
        <a href="/tag/postgresql.html">postgresql</a>,         <a href="/tag/bash.html">bash</a>        | <a href="/category/sql.html">SQL</a>
        </small>
        <section>
            <p>Imagine you run two database machines hosting structurally the same databases on two separate servers and you need to transfer data from one to another. Not very often, let&#8217;s say once a month. Your tables aren&#8217;t small nor huge, let&#8217;s say millions rows in&nbsp;general.</p>
<p>You&#8217;re going to use <code>pg_dump</code> and pipe it to <code>psql</code>, but the indices on your tables will slow you down a&nbsp;lot.</p>
<p>That&#8217;s why you&#8217;ll want to drop all indices and constraints (<code>drop_indices_constraints.sql</code>):</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="s1">&#39;ALTER TABLE &#39;</span> <span class="o">||</span>
    <span class="n">tc</span><span class="p">.</span><span class="n">table_schema</span> <span class="o">||</span>
    <span class="s1">&#39;.&#39;</span> <span class="o">||</span>
    <span class="n">tc</span><span class="p">.</span><span class="k">table_name</span> <span class="o">||</span>
    <span class="s1">&#39; DROP CONSTRAINT &#39;</span> <span class="o">||</span>
    <span class="n">tc</span><span class="p">.</span><span class="k">constraint_name</span>  <span class="o">||</span>
    <span class="s1">&#39;;&#39;</span>
<span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">table_constraints</span> <span class="n">tc</span>
<span class="k">JOIN</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">constraint_column_usage</span> <span class="n">ccu</span> <span class="k">ON</span> <span class="p">(</span><span class="n">tc</span><span class="p">.</span><span class="k">constraint_catalog</span> <span class="o">=</span> <span class="n">ccu</span><span class="p">.</span><span class="k">constraint_catalog</span> <span class="k">AND</span> <span class="n">tc</span><span class="p">.</span><span class="k">constraint_schema</span> <span class="o">=</span> <span class="n">ccu</span><span class="p">.</span><span class="k">constraint_schema</span> <span class="k">AND</span> <span class="n">tc</span><span class="p">.</span><span class="k">constraint_name</span> <span class="o">=</span> <span class="n">ccu</span><span class="p">.</span><span class="k">constraint_name</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="n">tc</span><span class="p">.</span><span class="n">table_schema</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">unnest</span><span class="p">(</span><span class="n">string_to_array</span><span class="p">(:</span><span class="s1">&#39;schemas&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">)))</span>
<span class="k">UNION</span> <span class="k">ALL</span>
<span class="k">SELECT</span>
    <span class="s1">&#39;DROP INDEX IF EXISTS &#39;</span> <span class="o">||</span> <span class="n">schemaname</span> <span class="o">||</span> <span class="s1">&#39;.&#39;</span> <span class="o">||</span> <span class="n">indexname</span> <span class="o">||</span> <span class="s1">&#39;;&#39;</span>
<span class="k">FROM</span> <span class="n">pg_indexes</span>
<span class="k">WHERE</span> <span class="n">schemaname</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">unnest</span><span class="p">(</span><span class="n">string_to_array</span><span class="p">(:</span><span class="s1">&#39;schemas&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">)));</span>
</pre></div>


<p>Then you will transfer the&nbsp;data:</p>
<div class="highlight"><pre><span></span>pg_dump -a -t <span class="s2">&quot;schema1.*&quot;</span> -t <span class="s2">&quot;schema2.*&quot;</span> -O -d <span class="nb">source</span> -v <span class="p">|</span> psql -h localhost -d target
</pre></div>


<p>And restore the already dropped indices and constraints (<code>create_indices_constraints.sql</code>):</p>
<div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="k">constraints</span> <span class="k">AS</span> <span class="p">(</span>
<span class="k">SELECT</span> <span class="s1">&#39;ALTER TABLE &#39;</span> <span class="o">||</span>
    <span class="n">tc</span><span class="p">.</span><span class="n">table_schema</span> <span class="o">||</span>
    <span class="s1">&#39;.&#39;</span> <span class="o">||</span>
    <span class="n">tc</span><span class="p">.</span><span class="k">table_name</span> <span class="o">||</span>
    <span class="s1">&#39; ADD CONSTRAINT &#39;</span> <span class="o">||</span>
    <span class="n">tc</span><span class="p">.</span><span class="k">constraint_name</span> <span class="o">||</span>
    <span class="s1">&#39; &#39;</span> <span class="o">||</span>
    <span class="n">tc</span><span class="p">.</span><span class="n">constraint_type</span> <span class="o">||</span>
    <span class="s1">&#39;(&#39;</span> <span class="o">||</span>
    <span class="n">string_agg</span><span class="p">(</span><span class="n">ccu</span><span class="p">.</span><span class="k">column_name</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="o">||</span> <span class="c1">-- column order should be taken into account here</span>
    <span class="s1">&#39;);&#39;</span> <span class="n">def</span><span class="p">,</span>
    <span class="n">tc</span><span class="p">.</span><span class="n">table_schema</span><span class="p">,</span>
    <span class="n">tc</span><span class="p">.</span><span class="k">table_name</span><span class="p">,</span>
    <span class="n">tc</span><span class="p">.</span><span class="k">constraint_name</span>
<span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">table_constraints</span> <span class="n">tc</span>
<span class="k">JOIN</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">constraint_column_usage</span> <span class="n">ccu</span> <span class="k">ON</span> <span class="p">(</span><span class="n">tc</span><span class="p">.</span><span class="k">constraint_catalog</span> <span class="o">=</span> <span class="n">ccu</span><span class="p">.</span><span class="k">constraint_catalog</span> <span class="k">AND</span> <span class="n">tc</span><span class="p">.</span><span class="k">constraint_schema</span> <span class="o">=</span> <span class="n">ccu</span><span class="p">.</span><span class="k">constraint_schema</span> <span class="k">AND</span> <span class="n">tc</span><span class="p">.</span><span class="k">constraint_name</span> <span class="o">=</span> <span class="n">ccu</span><span class="p">.</span><span class="k">constraint_name</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="n">tc</span><span class="p">.</span><span class="n">table_schema</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">unnest</span><span class="p">(</span><span class="n">string_to_array</span><span class="p">(:</span><span class="s1">&#39;schemas&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">)))</span>
    <span class="k">AND</span> <span class="n">tc</span><span class="p">.</span><span class="n">constraint_type</span> <span class="o">=</span> <span class="s1">&#39;PRIMARY KEY&#39;</span>
<span class="k">GROUP</span> <span class="k">BY</span>
    <span class="n">tc</span><span class="p">.</span><span class="n">table_schema</span><span class="p">,</span>
    <span class="n">tc</span><span class="p">.</span><span class="k">table_name</span><span class="p">,</span>
    <span class="n">tc</span><span class="p">.</span><span class="k">constraint_name</span><span class="p">,</span>
    <span class="n">tc</span><span class="p">.</span><span class="n">constraint_type</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="n">def</span> <span class="k">FROM</span> <span class="k">constraints</span>
<span class="k">UNION</span> <span class="k">ALL</span>
<span class="k">SELECT</span> <span class="n">indexdef</span> <span class="o">||</span> <span class="s1">&#39;;&#39;</span>
<span class="k">FROM</span> <span class="n">pg_indexes</span>
<span class="k">WHERE</span> <span class="n">schemaname</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">unnest</span><span class="p">(</span><span class="n">string_to_array</span><span class="p">(:</span><span class="s1">&#39;schemas&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">)))</span> 
<span class="k">AND</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="mi">1</span> <span class="k">FROM</span>
    <span class="k">constraints</span> <span class="k">c</span>
    <span class="k">WHERE</span> <span class="n">pg_indexes</span><span class="p">.</span><span class="n">schemaname</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">table_schema</span>
        <span class="k">AND</span> <span class="n">pg_indexes</span><span class="p">.</span><span class="n">tablename</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="k">table_name</span>
        <span class="k">AND</span> <span class="n">pg_indexes</span><span class="p">.</span><span class="n">indexname</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="k">constraint_name</span>
<span class="p">);</span>
</pre></div>


<h2>Few&nbsp;sidenotes</h2>
<ol>
<li>Run the second piece of code first. If you forget, run that code on the source&nbsp;database.</li>
<li>Notice the <code>:schemas</code>. Variable assignment is one of the <code>psql</code> features I really&nbsp;like.</li>
<li>Notice <code>DROP INDEX IF EXISTS</code> and the <span class="caps">CTE</span> used in the drop code - that&#8217;s due to the fact that dropping the constraint obviously drops the underlying index as well and you don&#8217;t want to dropping something that doesn&#8217;t exist or creating something that exists&nbsp;already.</li>
</ol>
<p>The bash script proposal might look as&nbsp;follows:</p>
<div class="highlight"><pre><span></span><span class="c1"># store indices and constraint definitions</span>
psql -qAt -d target -v <span class="nv">schemas</span><span class="o">=</span><span class="s1">&#39;schema1&#39;</span>,<span class="s1">&#39;schema2&#39;</span> -f create_indices_constraints.sql &gt; create.sql

<span class="c1"># drop indices and constraints</span>
psql -qAt -d target -v <span class="nv">schemas</span><span class="o">=</span><span class="s1">&#39;schema1&#39;</span>,<span class="s1">&#39;schema2&#39;</span> -f drop_indices_constraints.sql <span class="p">|</span> psql -d target

​# load data
pg_dump -a -t <span class="s2">&quot;schema1.*&quot;</span> -t <span class="s2">&quot;schema2.*&quot;</span> -O -d <span class="nb">source</span> -v <span class="p">|</span> psql -h localhost -d target

<span class="c1">#renew indices and constraints</span>
psql -qAt -d target -f create.sql
​
</pre></div>
        </section>
        </div>
    </div>

    <div class="panel card card-1">
        <div class="post-name">
            <h1><a href="/posts/2016/testing-postgresql-ogr-fdw/" rel="bookmark" title="Permalink to Testing PostgreSQL OGR FDW">Testing PostgreSQL <span class="caps">OGR</span> <span class="caps">FDW</span></a></h1>
            <small>Written on Jul 1, 2016
        and marked as
        <a href="/tag/postgresql.html">postgresql</a>,         <a href="/tag/gdal.html">gdal</a>        | <a href="/category/sql.html">SQL</a>
        </small>
        <section>
            <p><a href="https://wiki.postgresql.org/wiki/Foreign_data_wrappers">PostgreSQL foreign data wrappers</a> are used to connect PostgreSQL database to different datasources, e.g. other <span class="caps">SQL</span> databases, <span class="caps">CSV</span> files, <span class="caps">XLS</span>&nbsp;spreadsheets&times;</p>
<p>The one I&#8217;ve been interested in for several months is <a href="https://github.com/pramsey/pgsql-ogr-fdw">Paul Ramsey&#8217;s <span class="caps">OGR</span> <span class="caps">FDW</span></a> - it gives you access to <span class="caps">OGR</span> supported spatial formats directly from your database. <em>No more shapefiles lying&nbsp;around?</em></p>
<p>Each foreign data wrapper should have three basic&nbsp;components:</p>
<ul>
<li>foreign server&nbsp;object</li>
<li>foreign user mapping - not necessary if you&#8217;re not connecting to other&nbsp;database</li>
<li>foreign&nbsp;table(s)</li>
</ul>
<p>I got some data about <a href="http://www.dibavod.cz/download.php?id_souboru=1413">rivers</a> and <a href="http://www.dibavod.cz/download.php?id_souboru=1416">dams</a> from <a href="http://www.dibavod.cz"><span class="caps">DIBAVOD</span></a> open datasets to play&nbsp;with.</p>
<p>First define the foreign server&nbsp;object:</p>
<div class="highlight"><pre><span></span>CREATE SERVER dibavod
FOREIGN DATA WRAPPER ogr_fdw
OPTIONS (
    datasource &#39;/downloads/dibavod&#39;,
    format &#39;ESRI Shapefile&#39;,
    config_options &#39;SHAPE_ENCODING=CP1250&#39;
);
</pre></div>


<p>Note the <span class="caps">OGR</span> specific driver configuration options are available inside <code>config_options</code>. In case of <span class="caps">ESRI</span> Shapefiles, the <code>datasource</code> is the directory your files reside&nbsp;in.</p>
<p>Let&#8217;s create PostgreSQL tables (use <code>ogrinfo</code> or Paul&#8217;s <code>ogr_fdw_info</code> to list the&nbsp;columns):</p>
<div class="highlight"><pre><span></span>CREATE FOREIGN TABLE rivers (
    fid integer,
    utokj_id numeric,
    utokjn_id numeric,
    utokjn_f numeric,
    prprop_z integer,
    ex_jh integer,
    pozn text,
    shape_leng numeric,
    naz_tok text,
    idvt integer,
    tok_id numeric,
    shape_len numeric,
    geom geometry(LINESTRING, 5514)
)
SERVER dibavod
OPTIONS (layer &#39;A02_Vodni_tok_JU&#39;);

CREATE FOREIGN TABLE dams (
    fid integer,
    objectid integer,
    naz_na text,
    nadr_gid numeric,
    kota_hladi numeric,
    hloubka numeric,
    zatop_ploc numeric,
    objem numeric,
    kota_hraz numeric,
    kota_preli numeric,
    kota_vypus numeric,
    plocha_m2 numeric,
    shape_area numeric,
    shape_len numeric,
    geom geometry(MULTIPOLYGON, 5514)
)
SERVER dibavod
OPTIONS (LAYER &#39;A05_Vodni_nadrze&#39;);
</pre></div>


<p>Note the <code>fid</code> column - required for <strong>write access</strong> to underlying&nbsp;datasource.</p>
<p>Things to&nbsp;remember:</p>
<ul>
<li>foreign tables mean no constraints nor&nbsp;indices</li>
<li>no indices mean spatial queries are terribly slow compared to&nbsp;PostGIS</li>
<li>I like the idea of <code>CREATE UNLOGGED TABLE dams2 AS SELECT * FROM dams</code>, not sure what to use it for&nbsp;though</li>
</ul>
        </section>
        </div>
    </div>

    <div class="panel card card-1">
        <div class="post-name">
            <h1><a href="/posts/2016/a-month-of-commuting-on-my-own/" rel="bookmark" title="Permalink to A Month of Commuting on My Own">A Month of Commuting on My&nbsp;Own</a></h1>
            <small>Written on Apr 9, 2016
        and marked as
        <a href="/tag/spatial.html">spatial</a>,         <a href="/tag/visualization.html">visualization</a>        | <a href="/category/space.html">space</a>
        </small>
        <section>
            <p>I&#8217;ve been sort of living in Brno for the last 7 years (college included). It&#8217;s quite a hilly city, with lots of cars, very good public transportation system and ever-improving cycling infrastructure. All these years I was using trams, buses and trolleybuses to get myself from one place to&nbsp;another. </p>
<p>These are all great,&nbsp;because:</p>
<ul>
<li>you can read while you&nbsp;ride</li>
<li>you are generally faster than car during rush&nbsp;hour</li>
<li>you don&#8217;t waste your time trying to park your&nbsp;car</li>
</ul>
<p>These all suck,&nbsp;because:</p>
<ul>
<li>public transportation is quite expensive in&nbsp;Brno</li>
<li>people stink in&nbsp;summer</li>
<li>some people stink in winter as&nbsp;well</li>
<li>you usually have to change several lines to actually get where you&nbsp;want</li>
<li>they&#8217;re&nbsp;crowded</li>
</ul>
<p>My period card expired on March 8 and I decided not to renew it. Why? See the list above. As I don&#8217;t have a car and I work at the far end of the city, I can either ride a bike or run to work. Ask me how it&#8217;s been for the first month? Not bad at&nbsp;all.</p>
<div class="text-center"><a href="/assets/a-month-of-commuting-on-my-own/training_calendar.png"><img src="/assets/a-month-of-commuting-on-my-own/training_calendar_small.png" title="Strava training log" class="img-rounded"></a><p><strong>Figure:</strong> March Strava&nbsp;log.</p></div>

<div class="text-center"><a href="/assets/a-month-of-commuting-on-my-own/training_calendar2.png"><img src="/assets/a-month-of-commuting-on-my-own/training_calendar_small2.png" title="Strava training log" class="img-rounded"></a><p><strong>Figure:</strong> April Strava&nbsp;log.</p></div>

<h2>What&#8217;s so great about&nbsp;commuting?</h2>
<p>Not so long ago <em>I considered commuting a waste of time</em>. It took me 40-50 minutes to get to work and about the same to get back home. That&#8217;s 1-2 hours not being productive, not doing anything at all actually, just changing&nbsp;places.</p>
<p>That&#8217;s a <em>terrible mistake</em> to do. It&#8217;s much better to see this time as an <strong>opportunity</strong> to do that little extra for yourself - walk, run, ride. Even though it takes me a bit longer than public transport (showering and dressing included), it leaves me with totally different state of mind in the end - it just starts me up (hello Rolling&nbsp;Stones).</p>
<p>You can go for a ride right from work. That&#8217;s&nbsp;priceless.</p>
<p>As a by-product I started to care more about what I eat and when I eat it. I actually spend time cooking so I get enough food during the day. Something I didn&#8217;t do before, because you can always buy something sweet before the bus comes,&nbsp;right?</p>
<div class="text-center"><a href="/assets/a-month-of-commuting-on-my-own/map.pdf"><embed style="width:100%; height:250px" src="/assets/a-month-of-commuting-on-my-own/map.pdf" title="Daily commute in Brno" class="img-rounded" type="application/pdf"></a><p><strong>Figure:</strong> Daily commute in Brno: bike in pink, run in green. <a href="/assets/a-month-of-commuting-on-my-own/map.pdf">See the full&nbsp;version.</a></p></div>

<h2>What&#8217;s not so great about&nbsp;commuting?</h2>
<p><strong>Weather</strong>, especially in spring and autumn, often sucks. Sometimes I come to work soaking wet, nothing a hot shower wouldn&#8217;t fix though. Someone still needs to clean the&nbsp;bike&hellip;</p>
<p><strong>Traffic</strong> sucks in the evening. I get up before six, leave home before half past six, thus avoid heavy traffic. Riding a bike home in the evening is threatening sometimes and a bit of mutual respect between pedestrians, cyclists and drivers would&nbsp;do.</p>
<p><strong>Cycling paths</strong> sometimes end right before the big crossroads. Often drivers use parts of the network as parking lanes, which puts you in danger&nbsp;suddenly.</p>
<p><strong>Other cyclists, skaters, people walking their dogs, little kids</strong> usually don&#8217;t care about you at all. You better don&#8217;t get distracted if you want to get home safe and&nbsp;sound.</p>
<p><strong>Books are hard to read</strong> on the&nbsp;bike.</p>
<h2>Does it tell you something about your&nbsp;city?</h2>
<p>I guess the city you see on foot or from atop a saddle is completely different than the one seen from a bus or a&nbsp;car. </p>
<p>Is it rather car or bike friendly? Do you feel at risk riding a bike or running? Is it faster to run/ride or drive? Does your city actually want you to leave your car at home at all, or has it been designed for&nbsp;cars?</p>
<p>River seems to be blessing when your city has one (unless flood strikes, different story). <a href="https://goo.gl/maps/T6wMLSCFzZU2">If done right</a>, its shores might become one of the most beautiful parts of the city. Something Brno needs to catch up with other&nbsp;cities.</p>
<p>I hope one day I&#8217;ll get up and see Brno changing in front of me. <a href="http://www.fastcoexist.com/3058685/paris-is-redesigning-its-major-intersections-for-pedestrians-not-cars">Just like Paris is right now.</a> We all die in the end, so why not to take a walk before we&nbsp;do?</p>
        </section>
        </div>
    </div>

<div class="pagination row">
    <div class="large-6 columns">
    </div>
    <div class="large-6 columns">
            <a href="/author/michal-zimmermann2.html" class="button card card-1">Next page &raquo;</a>
    </div>
    <!-- <p class="paginator">
            <a href="/author/michal-zimmermann2.html" class="button card card-1">Next page &raquo;</a>
    </p> -->
</div>            </div>
        </div>
        <div class="row">
            <div class="large-12 columns footer">
                <footer>
                    <address>
                    Written by <a href="http://www.zimmi.cz">Michal Zimmermann</a>.
                    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                    which takes great advantage of <a href="http://python.org">Python</a>.
                    </address><!-- /#about -->
                </footer><!-- /#contentinfo -->
            </div>
        </div>
<script src="/theme/webassets-external/91ae19a44b6fd6f56de2d3a3a1e2f680_jquery.js"></script>
<script src="/theme/webassets-external/1f857912fbcb91b33a7fbeafdecefa84_foundation.min.js"></script>
<script>
$(document).foundation();
</script>
</body>
</html>