<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
        <title>Michal Zimmermann | tag: python</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed" rel="stylesheet">
        <link href="https://www.zimmi.cz/posts/atom.xml" type="application/atom+xml" rel="alternate" title="Michal Zimmermann Full Atom Feed" />
        <link href="https://www.zimmi.cz/posts/feed.xml" type="application/rss+xml" rel="alternate" title="Michal Zimmermann Full RSS Feed" />
        <link rel="stylesheet" href="https://www.zimmi.cz/posts/theme/css/style.min.css?9c0b0056">
</head>
<body>
    <nav role="navigation">
        <ul>
            <li><a href="https://www.zimmi.cz/posts/categories">Categories</a></li>
            <li><a href="https://www.zimmi.cz/posts/tags">Tags</a></li>
            <li><a href="https://www.zimmi.cz/posts/feed.xml">Subscribe to RSS feed</a></li>
        </ul>
    </nav>
    <header>
        <h1><a href="/posts">Michal Zimmermann<small>Pieces of knowledge from the world of GIS.</small></a></h1>
    </header>
    <main>
<h2 class="text-center">Articles tagged with python tag</h2>

<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/qgis-plugin-development-getting-started/" rel="bookmark" title="Permalink to QGIS Plugin Development: Getting Started"><span class="caps">QGIS</span> Plugin Development: Getting&nbsp;Started</a></h1>
    <aside><span>Oct 26, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/python.html">python</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/qgis.html">QGIS</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/qgis.html">QGIS</a></span>
    </aside>
    <p><span class="caps">QGIS</span> 2.1x is a brilliant tool for Python-based automation in form of custom scripts or even plugins. The first steps towards writing the custom code might be a bit difficult, as you need to grasp quite complex Python <span class="caps">API</span>. The <em><span class="caps">QGIS</span> Plugin Development</em> series (see the list of other parts at the end of this article) targets pitfalls and traps I&#8217;ve met while learning to use it&nbsp;myself.</p>
<p>The outcome of the series is going to be <strong>a fully functional custom plugin</strong> capable of writing attribute values from a source layer nearest neighbour to a target layer based on their spatial&nbsp;proximity.</p>
<p>In this part, I&#8217;ll mention the basics a.k.a. what is good to know before you&nbsp;start.</p>
<h2>Documentation</h2>
<p>Different <span class="caps">QGIS</span> versions come with different Python <span class="caps">API</span>. The documentation is to be found at <a href="http://qgis.org">https://qgis.org</a>, the latest being <a href="http://qgis.org/api/2.18/">version 2.18</a>. Note that if you come directly to <a href="http://qgis.org/api/">http://qgis.org/api/</a>, you&#8217;ll see the current master&nbsp;docs.</p>
<p>Alternatively, you can <code>apt install qgis-api-doc</code> on your Ubuntu-based system and run <code>python -m SimpleHTTPServer [port]</code> inside <code>/usr/share/qgis/doc/api</code>. You&#8217;ll find the documentation at <a href="http://localhost:8000">http://localhost:8000</a> (if you don&#8217;t provide port number) and it will be available even when you&#8217;re&nbsp;offline.</p>
<h2>Basic <span class="caps">API</span> objects&nbsp;structure</h2>
<p>Before launching <span class="caps">QGIS</span>, take a look at what&#8217;s available inside <span class="caps">API</span>:</p>
<ul>
<li><strong>qgis.core</strong> package brings all the basic objects like QgsMapLayer, QgsDataSourceURI, QgsFeature&nbsp;etc</li>
<li><strong>qgis.gui</strong> package brings <span class="caps">GUI</span> elements that can be used within <span class="caps">QGIS</span> like QgsMessageBar or QgsInterface (very important <span class="caps">API</span> element, exposed to all custom&nbsp;plugins)</li>
<li><strong>qgis.analysis</strong>, <strong>qgis.networkanalysis</strong>, <strong>qgis.server</strong>, and <strong>qgis.testing</strong> packages that won&#8217;t be covered in the&nbsp;series</li>
<li><strong>qgis.utils</strong> module that comes with <code>iface</code> exposed (very handy within <span class="caps">QGIS</span> Python&nbsp;console)</li>
</ul>
<h2><span class="caps">QGIS</span> Python&nbsp;Console</h2>
<p>Using Python console is the easiest way to automate your <span class="caps">QGIS</span> workflow. It can be accessed via pressing <code>Ctrl + Alt + P</code> or navigating to <code>Plugins -&gt; Python Console</code>. Note the above mentioned <code>iface</code> from <strong>qgis.utils</strong> module is exposed by default within the console, letting you interact with <span class="caps">QGIS</span> <span class="caps">GUI</span>. Try out the following&nbsp;examples.</p>
<div class="highlight"><pre><span></span><span class="n">iface</span><span class="o">.</span><span class="n">mapCanvas</span><span class="p">()</span><span class="o">.</span><span class="n">scale</span><span class="p">()</span> <span class="c1"># returns the current map scale</span>
<span class="n">iface</span><span class="o">.</span><span class="n">mapCanvas</span><span class="p">()</span><span class="o">.</span><span class="n">zoomScale</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># zoom to scale of 1:100</span>
<span class="n">iface</span><span class="o">.</span><span class="n">activeLayer</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="c1"># get the active layer name</span>
<span class="n">iface</span><span class="o">.</span><span class="n">activeLayer</span><span class="p">()</span><span class="o">.</span><span class="n">startEditing</span><span class="p">()</span> <span class="c1"># toggle editting</span>
</pre></div>


<p>That was a very brief introduction to <span class="caps">QGIS</span> <span class="caps">API</span>, the next part will walk you through the console more&nbsp;thoroughly.</p>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/serving-mapbox-vector-tiles-with-postgis-nginx-and-python-backend/" rel="bookmark" title="Permalink to Serving Mapbox Vector Tiles with PostGIS, Nginx and Python Backend">Serving Mapbox Vector Tiles with PostGIS, Nginx and Python&nbsp;Backend</a></h1>
    <aside><span>Oct 23, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/postgis.html">postgis</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/python.html">python</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/sql.html">SQL</a></span>
    </aside>
    <p><a href="({filename}../2017/postgis-as-a-mapbox-vector-tiles-generator.md)">Since version 2.4.0, PostGIS can serve <span class="caps">MVT</span></a> data directly. <span class="caps">MVT</span> returning queries put heavy workload on the database though. On top of that, each of the query has to be run again every time a client demands the data. This leaves us with plenty of room to optimize the&nbsp;process.</p>
<div class="text-center"><img src="/posts/assets/serving-mapbox-vector-tiles-with-postgis-nginx-and-python-backend/election.gif"/></div>

<p>During the last week, while working on the Czech legislative election data visualization, I&#8217;ve struggled with the server becoming unresponsive far too often due to the issues mentioned&nbsp;above.</p>
<div class="text-center"><img src="/posts/assets/serving-mapbox-vector-tiles-with-postgis-nginx-and-python-backend/schema.png"/></div>

<p>According to the schema, the first client to come to the&nbsp;server:</p>
<ul>
<li>goes through filesystem unstopped, because there are no cached files&nbsp;yet,</li>
<li>continues to the Flask backend and asks for a file at <code>{z}/{x}/{y}</code>,</li>
<li>Flask backend asks the database to return the <span class="caps">MVT</span> for the given&nbsp;tile,</li>
<li>Flask backend writes the response to the filesystem and sends it to the&nbsp;client.</li>
</ul>
<p>Other clients get tiles directly from the filesystem, leaving the database at&nbsp;ease.</p>
<h2>Nginx</h2>
<p>Nginx is fairly simple to set up, once you know what you&#8217;re doing. The <code>/volby-2017/municipality/</code> location serves static <span class="caps">MVT</span> from the given alias directory. If not found, the request is passed to <code>@postgis</code> location, that asks the Flask backend for the&nbsp;response.</p>
<div class="highlight"><pre><span></span>server election <span class="o">{</span>
    location /volby-2017/municipality <span class="o">{</span>
            <span class="nb">alias</span> /opt/volby-cz-2017/server/cache/<span class="p">;</span>
            try_files <span class="nv">$uri</span> @postgis<span class="p">;</span>
    <span class="o">}</span>

    location @postgis <span class="o">{</span>
            include uwsgi_params<span class="p">;</span>
            uwsgi_pass <span class="m">127</span>.0.0.1:5000<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2>Flask&nbsp;backend</h2>
<script src="https://gist.github.com/zimmicz/46485676e1cf3d6566f0aaa7f93f055b.js"></script>

<h2>Generating static <span class="caps">MVT</span> in&nbsp;advance</h2>
<p>If you&#8217;re going to serve static tiles that don&#8217;t change often, it might be a good idea to use PostGIS to create files in advance and serve them with&nbsp;Nginx.</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">tiles</span> <span class="p">(</span>
    <span class="n">x</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">y</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">z</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">west</span> <span class="nb">numeric</span><span class="p">,</span>
    <span class="n">south</span> <span class="nb">numeric</span><span class="p">,</span>
    <span class="n">east</span> <span class="nb">numeric</span><span class="p">,</span>
    <span class="n">north</span> <span class="nb">numeric</span><span class="p">,</span>
    <span class="n">geom</span> <span class="n">geometry</span><span class="p">(</span><span class="n">POLYGON</span><span class="p">,</span> <span class="mi">3857</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>


<p>Using <a href="https://github.com/mapbox/mercantile">mercantile</a>, you can create the <code>tiles</code> table holding the bounding boxes of the tiles you need. PostGIS them inserts the actual <span class="caps">MVT</span> into the <code>mvt</code> table.</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TEMPORARY</span> <span class="k">TABLE</span> <span class="n">tmp_tiles</span> <span class="k">AS</span>
    <span class="k">SELECT</span>
        <span class="n">muni</span><span class="p">.</span><span class="n">muni_id</span><span class="p">,</span>
        <span class="n">prc</span><span class="p">.</span><span class="k">data</span><span class="p">,</span>
        <span class="n">ST_AsMVTGeom</span><span class="p">(</span>
            <span class="n">muni</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span>
            <span class="n">TileBBox</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span> <span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">3857</span><span class="p">),</span>
            <span class="mi">4096</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="k">false</span>
        <span class="p">)</span> <span class="n">geom</span><span class="p">,</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">y</span><span class="p">,</span>
        <span class="n">z</span>
    <span class="k">FROM</span> <span class="n">muni</span>
    <span class="k">JOIN</span> <span class="p">(</span>
        <span class="k">SELECT</span>
            <span class="n">x</span><span class="p">,</span>
            <span class="n">y</span><span class="p">,</span>
            <span class="n">z</span><span class="p">,</span>
            <span class="n">geom</span>
        <span class="k">FROM</span> <span class="n">tiles</span>
    <span class="p">)</span> <span class="n">bbox</span> <span class="k">ON</span> <span class="p">(</span><span class="n">ST_Intersects</span><span class="p">(</span><span class="n">muni</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">bbox</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span>
    <span class="k">JOIN</span> <span class="n">party_results_cur</span> <span class="n">prc</span> <span class="k">ON</span> <span class="p">(</span><span class="n">muni</span><span class="p">.</span><span class="n">muni_id</span> <span class="o">=</span> <span class="n">prc</span><span class="p">.</span><span class="n">muni_id</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">mvt</span> <span class="p">(</span><span class="n">mvt</span> <span class="n">bytea</span><span class="p">,</span> <span class="n">x</span> <span class="nb">integer</span><span class="p">,</span> <span class="n">y</span> <span class="nb">integer</span><span class="p">,</span> <span class="n">z</span> <span class="nb">integer</span><span class="p">);</span>
<span class="k">DO</span>
<span class="err">$$</span>
<span class="k">DECLARE</span> <span class="n">r</span> <span class="n">record</span><span class="p">;</span>
<span class="k">BEGIN</span>
<span class="k">FOR</span> <span class="n">r</span> <span class="k">in</span> <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="k">FROM</span> <span class="n">tmp_tiles</span> <span class="n">LOOP</span>
    <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">mvt</span>
    <span class="k">SELECT</span> <span class="n">ST_AsMVT</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="s1">&#39;municipality&#39;</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="s1">&#39;geom&#39;</span><span class="p">),</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">z</span>
    <span class="k">FROM</span> <span class="p">(</span>
        <span class="k">SELECT</span>
            <span class="n">muni_id</span><span class="p">,</span>
            <span class="k">data</span><span class="p">,</span>
            <span class="n">geom</span>
        <span class="k">FROM</span> <span class="n">tmp_tiles</span>
        <span class="k">WHERE</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="p">)</span> <span class="n">q</span><span class="p">;</span>
    <span class="n">RAISE</span> <span class="n">INFO</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
<span class="k">END</span> <span class="n">LOOP</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$$</span><span class="p">;</span>
</pre></div>


<p>Once filled, the table rows can be written to the filesystem with the simple piece of Python&nbsp;code.</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">text</span>

<span class="n">CACHE_PATH</span><span class="o">=</span><span class="s2">&quot;cache/&quot;</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;postgresql:///&#39;</span><span class="p">)</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="n">sql</span><span class="o">=</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT mvt, x, y, z FROM mvt&quot;</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="n">cachefile</span> <span class="o">=</span> <span class="s2">&quot;{}/{}/{}/{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CACHE_PATH</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">print</span><span class="p">(</span><span class="n">cachefile</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;{}/{}/{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CACHE_PATH</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;{}/{}/{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CACHE_PATH</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cachefile</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>


<h2>Conclusion</h2>
<p>PostGIS is a brilliant tool for generating Mapbox vector tiles. Combined with Python powered static file generator and Nginx, it seems to become the only tool needed to get you&nbsp;going.</p>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/postgresql-development-history-revealed-with-postgresql/" rel="bookmark" title="Permalink to PostgreSQL Development History Revealed with PostgreSQL">PostgreSQL Development History Revealed with&nbsp;PostgreSQL</a></h1>
    <aside><span>Aug 9, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/postgresql.html">postgresql</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/python.html">python</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/sql.html">SQL</a></span>
    </aside>
    <p>I spend a lot of time reading <a href="https://www.postgresql.org/docs/manuals/">PostgreSQL docs</a>. It occurred to me just a few weeks ago that those versioned manuals are great opportunity to get an insight into PostgreSQL development history. Using PostgreSQL, of&nbsp;course.</p>
<h2><span class="caps">TOP</span> 5 functions with the most verbose docs in each&nbsp;version</h2>
<div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="k">version</span><span class="p">,</span>
    <span class="n">string_agg</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39; | &#39;</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">letter_count</span> <span class="k">DESC</span><span class="p">)</span>
<span class="k">FROM</span> <span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="k">version</span><span class="p">,</span>
        <span class="n">func</span><span class="p">,</span>
        <span class="n">letter_count</span><span class="p">,</span>
        <span class="n">row_number</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="k">version</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">letter_count</span> <span class="k">DESC</span><span class="p">)</span>
    <span class="k">FROM</span> <span class="n">postgresql_development</span><span class="p">.</span><span class="k">data</span>
<span class="p">)</span> <span class="n">a</span>
<span class="k">WHERE</span> <span class="n">row_number</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">=</span> <span class="mi">10</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">version</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">version</span> <span class="k">DESC</span>
</pre></div>


<p>Seems like a huge comeback for <code>CREATE TABLE</code>.</p>
<table>
<thead>
<tr>
<th><span class="caps">VERSION</span></th>
<th>1st</th>
<th>2nd</th>
<th>3rd</th>
<th>4th</th>
<th>5th</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.0</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>9.6</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>9.5</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>9.4</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>9.3</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">DEFAULT</span> <span class="caps">PRIVILEGES</span></td>
</tr>
<tr>
<td>9.2</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">DEFAULT</span> <span class="caps">PRIVILEGES</span></td>
</tr>
<tr>
<td>9.1</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">DEFAULT</span> <span class="caps">PRIVILEGES</span></td>
</tr>
<tr>
<td>9.0</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">DEFAULT</span> <span class="caps">PRIVILEGES</span></td>
</tr>
<tr>
<td>8.4</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>8.3</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">COMMENT</span></td>
</tr>
<tr>
<td>8.2</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>8.1</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>8</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
</tr>
<tr>
<td>7.4</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>7.3</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
</tr>
<tr>
<td>7.2</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span> <span class="caps">INTO</span></td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TYPE</span></td>
</tr>
<tr>
<td>7.1</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span> <span class="caps">INTO</span></td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TYPE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
</tr>
<tr>
<td>7.0</td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">SELECT</span> <span class="caps">INTO</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TYPE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">COMMENT</span></td>
</tr>
</tbody>
</table>
<h2>Number of functions available in each&nbsp;version</h2>
<div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="k">version</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="n">func</span><span class="p">),</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">letter_count</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">postgresql_development</span><span class="p">.</span><span class="k">data</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">version</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">version</span><span class="p">;</span>
</pre></div>


<div class="text-center"><img src="/posts/assets/postgresql-development-history-revealed-with-postgresql/plot1.png"/></div>

<h2>The most verbose docs in each&nbsp;version</h2>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">ON</span> <span class="p">(</span><span class="k">version</span><span class="p">)</span>
    <span class="k">version</span><span class="p">,</span>
    <span class="n">func</span><span class="p">,</span>
    <span class="n">letter_count</span>
<span class="k">FROM</span> <span class="n">postgresql_development</span><span class="p">.</span><span class="k">data</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">version</span><span class="p">,</span> <span class="n">letter_count</span> <span class="k">DESC</span><span class="p">;</span>
</pre></div>


<p>Poor <code>REVOKE</code>, the defeated&nbsp;champion.</p>
<div class="text-center">
    <table style="margin-left:auto; margin-right: auto">
    <thead>
    <tr>
    <th><span class="caps"><span class="caps">VERSION</span></span></th>
    <th><span class="caps"><span class="caps">FUNCTION</span></span></th>
    <th><span class="caps"><span class="caps">LETTER</span></span> <span class="caps"><span class="caps">COUNT</span></span></th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td>10</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>3142</td>
    </tr>
    <tr>
    <td>9.6</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.5</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.4</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.3</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.2</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.1</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2508</td>
    </tr>
    <tr>
    <td>9</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2502</td>
    </tr>
    <tr>
    <td>8.4</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2105</td>
    </tr>
    <tr>
    <td>8.3</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>1485</td>
    </tr>
    <tr>
    <td>8.2</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>1527</td>
    </tr>
    <tr>
    <td>8.1</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>1312</td>
    </tr>
    <tr>
    <td>8</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>1251</td>
    </tr>
    <tr>
    <td>7.4</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>1075</td>
    </tr>
    <tr>
    <td>7.3</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>929</td>
    </tr>
    <tr>
    <td>7.2</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>929</td>
    </tr>
    <tr>
    <td>7.1</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>871</td>
    </tr>
    <tr>
    <td>7</td>
    <td><span class="caps"><span class="caps">SELECT</span></span></td>
    <td>450</td>
    </tr>
    </tbody>
    </table>
</div>

<h2><span class="caps">CREATE</span> <span class="caps">TABLE</span> docs&nbsp;evolution</h2>
<div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="k">version</span><span class="p">,</span>
    <span class="n">letter_count</span>
<span class="k">FROM</span> <span class="n">postgresql_development</span><span class="p">.</span><span class="k">data</span>
<span class="k">WHERE</span> <span class="n">func</span> <span class="o">=</span> <span class="s1">&#39;CREATE TABLE&#39;</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">func</span><span class="p">,</span> <span class="k">version</span><span class="p">;</span>
</pre></div>


<p>Something&#8217;s going on in an upcoming 10.0&nbsp;version.</p>
<div class="text-center"><img src="/posts/assets/postgresql-development-history-revealed-with-postgresql/plot2.png"/></div>

<p>All the data was obtained with the following Python script and processed inside the PostgreSQL database. Plots done with <a href="http://bokeh.pydata.org/en/latest/">Bokeh</a>, though I probably wouldn&#8217;t use it again, the docs site is absurdly sluggish and the info is just all over the&nbsp;place.</p>
<script src="https://gist.github.com/zimmicz/f69a5ce5d3cf3a220e171553c35e0391.js"></script>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2015/liftago-open-dataset-infographics/" rel="bookmark" title="Permalink to Liftago Open Dataset Infographics">Liftago Open Dataset&nbsp;Infographics</a></h1>
    <aside><span>Dec 21, 2015</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/python.html">python</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/postgis.html">postgis</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/svg.html">svg</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/visualization.html">visualization</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/data.html">data</a></span>
    </aside>
    <p><a href="https://www.liftago.com/cs">Liftago</a> (the Czech analogy of Uber) has recently <a href="http://try.liftago.com/info-wants-to-be-free/">released a sample of its data</a> covering four weeks of driver/pasenger&nbsp;interactions.</p>
<p>Have a look at my infographics created with PostGIS, Inkscape, Python and&nbsp;pygal.</p>
<p class="text-center"><a href="https://www.zimmi.cz/posts/assets/liftago-open-dataset-infographics/liftago.pdf"><img title="Liftago infographics" src="https://www.zimmi.cz/posts/assets/liftago-open-dataset-infographics/liftago.png" class="img-responsive centered"></a></p>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2015/automated-map-creation-with-qgis-postgis-python-svg-and-imagemagick/" rel="bookmark" title="Permalink to Automated Map Creation With QGIS, PostGIS, Python, SVG and ImageMagick">Automated Map Creation With <span class="caps">QGIS</span>, PostGIS, Python, <span class="caps">SVG</span> and&nbsp;ImageMagick</a></h1>
    <aside><span>Aug 9, 2015</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/qgis.html">qgis</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/postgis.html">postgis</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/python.html">python</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/svg.html">svg</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/linux.html">linux</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/automation.html">automation</a></span>
    </aside>
    <p>As mentioned in <a href="https://www.zimmi.cz/posts/2015/qgis-tips-for-collaborative-mapping/"><span class="caps">QGIS</span> Tips For Collaborative Mapping</a> we&#8217;re in the middle of crop evaluation project at <a href="http://www.clevermaps.cz/">CleverMaps</a>.</p>
<p>With the <span class="caps">QGIS</span> workflow up and running, I&#8217;ve been focused on different <span class="caps">QGIS</span> related task: <strong>automatic map generation</strong> for land blocks that meet certain conditions. The logic behind identifying such land blocks is as&nbsp;follows:</p>
<ul>
<li>if the original area and the measured one differ more than 0.5 %&nbsp;or</li>
<li>number of declared crops differs from number of crops identified&nbsp;or</li>
<li>at least one parcel in the land block was given a certain error&nbsp;code</li>
</ul>
<p>Let&#8217;s assume that with several lines of <span class="caps">SQL</span> code we can store these mentioned above in a table called <code>land_blocks</code> with geometries being the result of calling <code>ST_Union()</code> over parcels for each land&nbsp;block.</p>
<h2>Map&nbsp;composition</h2>
<p>Every map should feature following&nbsp;layers:</p>
<ul>
<li>land blocks (remember the <code>land_blocks</code> table?) - labeled with <span class="caps">ID</span>, yellowish borders, no&nbsp;fill</li>
<li>land parcels - that&#8217;s my source layer - labeled with letters, blue borders, no&nbsp;fill</li>
<li>other&nbsp;layers</li>
<li><span class="caps">HR</span>, <span class="caps">VHR</span>, <span class="caps">NIR</span> imagery, orthophoto - served via <span class="caps">WMS</span></li>
</ul>
<p>Labels should be visible only for the featured land block (both for the land parcels and the land block itself. The whole map scales dynamically, showing small land blocks zoomed in and the large ones zoomed&nbsp;out.</p>
<p class='text-center'><a id="desired-map" title="Desired map" href="/posts/assets/automated-map-creation-with-qgis-postgis-python-svg-and-imagemagick/map.jpg"><img title="Desired map" src="/posts/assets/automated-map-creation-with-qgis-postgis-python-svg-and-imagemagick/map.jpg" width=70% class="img-responsive centered"></a></p>

<p>Every map features additional&nbsp;items:</p>
<ul>
<li>dynamic list of subsidies farmer asks for - showing both measured and declared&nbsp;area</li>
<li>dynamic list of land parcels with their areas and error&nbsp;codes</li>
<li>scalebar</li>
<li>map&nbsp;key</li>
<li>logos</li>
</ul>
<h2>Atlas&nbsp;creation</h2>
<p>Now with requirements defined, let&#8217;s create some maps. It&#8217;s incredibly easy to generate a series of maps with <span class="caps">QGIS</span> atlas&nbsp;options.</p>
<h3>Atlas generation&nbsp;settings</h3>
<p><strong>Coverage layer</strong> is presumably the only thing you really need - as the name suggests, it covers your area of interest. One map will be created for each feature in this layer, unless you decide to use some <strong>filtering</strong> - which I&nbsp;did.</p>
<p><strong>Output filenames</strong> can be tweaked to your needs, here&#8217;s what such a function might look like. If there is a slash in the land block <span class="caps">ID</span> (<span class="caps">XXXXXXX</span>/Y), the filename is set to <code>USER-ID_XXXXXXX-00Y_M_00</code>, <code>USER-ID_XXXXXXX-000_M_00</code> otherwise.</p>
<div class="highlight"><pre><span></span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">strpos</span><span class="p">(</span><span class="n">attribute</span><span class="p">(</span><span class="err">$</span><span class="n">atlasfeature</span><span class="p">,</span> <span class="s1">&#39;kod_pb&#39;</span><span class="p">),</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">THEN</span>
        <span class="n">ji</span> <span class="o">||</span> <span class="s1">&#39;_&#39;</span> <span class="o">||</span>
        <span class="n">substr</span><span class="p">(</span>
            <span class="n">attribute</span><span class="p">(</span><span class="err">$</span><span class="n">atlasfeature</span><span class="p">,</span> <span class="s1">&#39;kod_pb&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">strpos</span><span class="p">(</span><span class="n">attribute</span><span class="p">(</span><span class="err">$</span><span class="n">atlasfeature</span><span class="p">,</span> <span class="s1">&#39;kod_pb&#39;</span><span class="p">),</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span> <span class="c1">-- slash position</span>
        <span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;-&#39;</span> <span class="o">||</span>
        <span class="n">lpad</span><span class="p">(</span>
            <span class="n">substr</span><span class="p">(</span>
                <span class="n">attribute</span><span class="p">(</span><span class="err">$</span><span class="n">atlasfeature</span><span class="p">,</span> <span class="s1">&#39;kod_pb&#39;</span><span class="p">),</span>
                <span class="n">strpos</span><span class="p">(</span><span class="n">attribute</span><span class="p">(</span><span class="err">$</span><span class="n">atlasfeature</span><span class="p">,</span> <span class="s1">&#39;kod_pb&#39;</span><span class="p">),</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                <span class="k">length</span><span class="p">(</span><span class="n">attribute</span><span class="p">(</span><span class="err">$</span><span class="n">atlasfeature</span><span class="p">,</span> <span class="s1">&#39;kod_pb&#39;</span><span class="p">))</span>
            <span class="p">),</span>
        <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;_M_00&#39;</span>
    <span class="k">ELSE</span>
        <span class="n">ji</span> <span class="o">||</span> <span class="s1">&#39;_&#39;</span> <span class="o">||</span> <span class="n">attribute</span><span class="p">(</span><span class="err">$</span><span class="n">atlasfeature</span><span class="p">,</span> <span class="s1">&#39;kod_pb&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;-000_M_00&#39;</span>
<span class="k">END</span>
</pre></div>


<h3>Map scale <span class="amp">&amp;</span> variable&nbsp;substitutions</h3>
<p>Different land blocks are of different sizes, thus needing different <strong>scales</strong> to fit in the map. Again, <span class="caps">QGIS</span> handles this <em>might-become-a-nightmare-pretty-easily</em> issue with a single click. You can define the scale&nbsp;as:</p>
<ul>
<li>margin around feature: percentage of the space displayed&nbsp;around</li>
<li>predefined scale (best fit): my choice, sometimes it doesn&#8217;t display the entire land block&nbsp;though</li>
<li>fixed scale: sets the scale the same for all the&nbsp;maps</li>
</ul>
<p>With these settings, I get a map similar to the one below. Notice two interesting&nbsp;things:</p>
<p class='text-center'><a title="QGIS map skeleton" href="/posts/assets/automated-map-creation-with-qgis-postgis-python-svg-and-imagemagick/map_skeleton.png"><img title="QGIS map skeleton" src="/posts/assets/automated-map-creation-with-qgis-postgis-python-svg-and-imagemagick/map_skeleton.png" width=70% class="img-responsive centered"></a></p>

<ul>
<li>Scale uses decimal places, which I find <em>a huge failure</em>. Has anyone ever seen a map with such scale? The worst is there is no easy way to hide these, or at least I didn&#8217;t find&nbsp;one.</li>
<li>You can see a bunch of <code>[something in the brackets]</code> notations. These will be substituted with actual values during the atlas generation. Showing land block <span class="caps">ID</span> with a preceeding label is as easy as <code>[%concat('PB: ', "kod_pb")%]</code> (mind the percentage&nbsp;sign).</li>
</ul>
<h3>Styling the map using atlas&nbsp;features</h3>
<p>Atlas features are a great help for <strong>map customization</strong>. As mentioned earlier, in my case, only one land block label per map should be visible. That can be achieved with a simple label dialog&nbsp;expression:</p>
<div class="highlight"><pre><span></span><span class="k">CASE</span>
    <span class="k">WHEN</span> <span class="err">$</span><span class="n">id</span> <span class="o">=</span> <span class="err">$</span><span class="n">atlasfeatureid</span>
    <span class="k">THEN</span> <span class="ss">&quot;kod_pb&quot;</span>
<span class="k">END</span>
</pre></div>


<p><span class="caps">QGIS</span> keeps reference to each coverage layer feature <span class="caps">ID</span> during atlas generation, so you can use it for comparison. The best part is you can use IDs with <strong>any layer</strong> you&nbsp;need:</p>
<div class="highlight"><pre><span></span><span class="k">CASE</span>
    <span class="k">WHEN</span> <span class="n">attribute</span><span class="p">(</span><span class="err">$</span><span class="n">atlasfeature</span><span class="p">,</span> <span class="s1">&#39;kod_pb&#39;</span><span class="p">)</span> <span class="o">=</span> <span class="ss">&quot;kod_pb&quot;</span>
    <span class="k">THEN</span> <span class="ss">&quot;kod_zp&quot;</span>
<span class="k">END</span>
</pre></div>


<p>With this simple expression, I get labels only for those land parcels that are part of the mapped land block. Even the <strong>layer style</strong> can be controlled with atlas feature. Land parcels inside the land block have blue borders, the rest is yellowish, remember? It&#8217;s a piece of cake with rule-based&nbsp;styling.</p>
<p class='text-center'><a title="Layer style based on atlas feature" href="/posts/assets/automated-map-creation-with-qgis-postgis-python-svg-and-imagemagick/atlas_feature_style.png"><img title="Layer style based on atlas feature" src="/posts/assets/automated-map-creation-with-qgis-postgis-python-svg-and-imagemagick/atlas_feature_style.png" width=70% class="img-responsive centered"></a></p>

<h3>Atlas&nbsp;generation</h3>
<p>When you&#8217;re set, atlas can be created with a single button. I used <span class="caps">SVG</span> as an output format to easily manipulate the map content afterwards. The resulting maps look like the one in <a href="#desired-map">the first picture</a> without the text in the red rectangle. A Python script appends this to each map&nbsp;afterwards.</p>
<p>Roughly speaking, generating 300 maps takes an hour or so, I guess that depends on the map complexity and hardware&nbsp;though.</p>
<h3>Adding textual&nbsp;content</h3>
<p><span class="caps">SVG</span> output is just plain old <span class="caps">XML</span> that you can edit by hand or by script. A simple Python script, part of map post-processing, loads <span class="caps">SVG</span> from the database and adds it to the left pane of each&nbsp;map.</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span>
      <span class="n">ji</span><span class="p">,</span>
      <span class="n">kod_pb</span><span class="p">,</span>
      <span class="n">concat</span><span class="p">(</span>
            <span class="s1">&#39;&amp;lt;g fill=&quot;none&quot; stroke=&quot;#000000&quot; stroke-opacity=&quot;1&quot; stroke-width=&quot;1&quot;</span>
<span class="s1">                  stroke-linecap=&quot;square&quot; stroke-linejoin=&quot;bevel&quot; transform=&quot;matrix(1.18081,0,0,1.18081,270.0,550.0)&quot;</span>
<span class="s1">                  font-family=&quot;Droid Sans&quot; font-size=&quot;35&quot; font-style=&quot;normal&quot;&amp;gt;&#39;</span><span class="p">,</span>
            <span class="n">kultura</span><span class="p">,</span> <span class="n">vymery</span><span class="p">,</span> <span class="n">vymery_hodnoty</span><span class="p">,</span>
            <span class="n">vcs_titul</span><span class="p">,</span> <span class="n">vcs_brk</span><span class="p">,</span> <span class="n">vcs_brs</span><span class="p">,</span> <span class="n">vcs_chmel</span><span class="p">,</span>
            <span class="n">vcs_zvv</span><span class="p">,</span> <span class="n">vcs_zv</span><span class="p">,</span> <span class="n">vcs_ovv</span><span class="p">,</span> <span class="n">vcs_ov</span><span class="p">,</span> <span class="n">vcs_cur</span><span class="p">,</span> <span class="n">vcs_bip</span><span class="p">,</span>
            <span class="n">lfa</span><span class="p">,</span> <span class="n">lfa_h1</span><span class="p">,</span> <span class="n">lfa_h2</span><span class="p">,</span> <span class="n">lfa_h3</span><span class="p">,</span>
            <span class="n">lfa_h4</span><span class="p">,</span> <span class="n">lfa_h5</span><span class="p">,</span> <span class="n">lfa_oa</span><span class="p">,</span> <span class="n">lfa_ob</span><span class="p">,</span> <span class="n">lfa_s</span><span class="p">,</span>
            <span class="n">natura</span><span class="p">,</span> <span class="n">aeo_eafrd_text</span><span class="p">,</span> <span class="n">dv_aeo_eafrd_a1</span><span class="p">,</span>
            <span class="n">dv_aeo_eafrd_a2o</span><span class="p">,</span> <span class="n">dv_aeo_eafrd_a2v</span><span class="p">,</span> <span class="n">dv_aeo_eafrd_b1</span><span class="p">,</span>
            <span class="n">dv_aeo_eafrd_b2</span><span class="p">,</span> <span class="n">dv_aeo_eafrd_b3</span><span class="p">,</span> <span class="n">dv_aeo_eafrd_b4</span><span class="p">,</span>
            <span class="n">dv_aeo_eafrd_b5</span><span class="p">,</span> <span class="n">dv_aeo_eafrd_b6</span><span class="p">,</span> <span class="n">dv_aeo_eafrd_b7</span><span class="p">,</span>
            <span class="n">dv_aeo_eafrd_b8</span><span class="p">,</span> <span class="n">dv_aeo_eafrd_b9</span><span class="p">,</span> <span class="n">dv_aeo_eafrd_c1</span><span class="p">,</span>
            <span class="n">dv_aeo_eafrd_c3</span><span class="p">,</span> <span class="n">aeko_text</span><span class="p">,</span> <span class="n">dv_aeko_a</span><span class="p">,</span> <span class="n">dv_aeko_b</span><span class="p">,</span> <span class="n">dv_aeko_c</span><span class="p">,</span>
            <span class="n">dv_aeko_d1</span><span class="p">,</span> <span class="n">dv_aeko_d2</span><span class="p">,</span> <span class="n">dv_aeko_d3</span><span class="p">,</span> <span class="n">dv_aeko_d4</span><span class="p">,</span> <span class="n">dv_aeko_d5</span><span class="p">,</span>
            <span class="n">dv_aeko_d6</span><span class="p">,</span> <span class="n">dv_aeko_d7</span><span class="p">,</span> <span class="n">dv_aeko_d8</span><span class="p">,</span> <span class="n">dv_aeko_d9</span><span class="p">,</span> <span class="n">dv_aeko_d10</span><span class="p">,</span>
            <span class="n">dv_aeko_e</span><span class="p">,</span> <span class="n">dv_aeko_f</span><span class="p">,</span> <span class="n">ez</span><span class="p">,</span> <span class="n">dzes_text</span><span class="p">,</span> <span class="n">rep</span><span class="p">,</span> <span class="n">obi</span><span class="p">,</span> <span class="n">seop</span><span class="p">,</span> <span class="n">meop</span><span class="p">,</span> <span class="n">pbz</span><span class="p">,</span> <span class="n">dzes7</span><span class="p">,</span>
            <span class="s1">&#39;&amp;lt;/g&amp;gt;&#39;</span>
      <span class="p">)</span> <span class="n">popis</span>
<span class="k">FROM</span> <span class="p">(...);</span>
</pre></div>


<p>Each column from the previous query is a result of <code>SELECT</code> similar to the one&nbsp;below.</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">concat</span><span class="p">(</span><span class="s1">&#39;&amp;lt;text fill=&quot;#000000&quot; fill-opacity=&quot;1&quot; stroke=&quot;none&quot;&amp;gt;BrK: &#39;</span><span class="p">,</span> <span class="n">dv_brk</span><span class="p">,</span> <span class="s1">&#39; ha / &#39;</span><span class="p">,</span> <span class="ss">&quot;MV_BRK&quot;</span><span class="p">,</span> <span class="s1">&#39; ha;&#39;</span><span class="p">,</span> <span class="n">kod_dpz</span><span class="p">,</span> <span class="s1">&#39;&amp;lt;/text&amp;gt;&#39;</span><span class="p">)</span> <span class="n">vcs_brk</span>
</pre></div>


<p>The <code>transform="matrix(1.18081,0,0,1.18081,270.0,550.0)</code> part puts the text on the right spot. Great finding about <span class="caps">SVG</span> is that it places each <code>&lt;text&gt;</code> element on the new line, so you don&#8217;t need to deal with calculating the position in your&nbsp;script.</p>
<p>Scale adjustment is done with a dirty lambda&nbsp;function.</p>
<div class="highlight"><pre><span></span><span class="n">content</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&amp;gt;(\d{1,3}\.\d{3,5})&amp;lt;/text&amp;gt;&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">m</span> <span class="p">:</span><span class="s2">&quot;&amp;gt;    &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))))</span> <span class="o">+</span> <span class="s2">&quot;&amp;lt;/text&amp;gt;&quot;</span><span class="p">,</span> <span class="n">old_map</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>


<h3><span class="caps">SVG</span> to <span class="caps">JPEG</span>&nbsp;conversion</h3>
<p>We deliver maps as <span class="caps">JPEG</span> files with 150 <span class="caps">DPI</span> on A4 paper format. <a href="http://www.imagemagick.org/script/index.php">ImageMagick</a> converts the formats with a simple shell&nbsp;command:</p>
<div class="highlight"><pre><span></span>convert -density <span class="m">150</span> -resize 1753x1240 input.svg output.jpg
</pre></div>


<h2>Conclusion</h2>
<p>I created pretty efficient semi-automated workflow using several open source technologies that saves me a lot of work. Although <span class="caps">QGIS</span> has some minor pet peeves (scale with decimal places, not showing the entire feature, not substituting variables at times), it definitely makes boring map creation quite amusing. The more I work with big data / on big tasks, the more I find Linux a&nbsp;must-have.</p>
<p>The whole process was done with <span class="caps">QGIS</span> 2.10, PostGIS 2.1, PostgreSQL 9.3, Python 2.7, ImageMagick&nbsp;6.7.</p>
</article>
<aside id="pagination">
            <a href="https://www.zimmi.cz/posts/tag/python.html">&laquo; Previous page</a>
            <a href="https://www.zimmi.cz/posts/tag/python3.html">Next page &raquo;</a>
</aside>    </main>
    <footer>
        Written by <a href="//www.zimmi.cz">Michal Zimmermann</a>.
        Proudly powered by <a href="//getpelican.com/">Pelican</a>,
        which takes great advantage of <a href="//python.org">Python</a>.
    </footer>
<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-43432739-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments)};
  gtag('js', new Date());

  gtag('config', 'UA-43432739-2');
</script>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NW8R37N');</script>
<!-- End Google Tag Manager -->
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NW8R37N"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<script src="https://www.zimmi.cz/posts/theme/js/echo.min.js"></script>
<script>
echo.init({
  offset: 200,
  throttle: 250,
  unload: false
});
</script>
</body>
</html>