<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
        <title>Michal Zimmermann | tag: QGIS</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed" rel="stylesheet">
        <link href="https://www.zimmi.cz/posts/atom.xml" type="application/atom+xml" rel="alternate" title="Michal Zimmermann Full Atom Feed" />
        <link href="https://www.zimmi.cz/posts/feed.xml" type="application/rss+xml" rel="alternate" title="Michal Zimmermann Full RSS Feed" />
        <link rel="stylesheet" href="https://www.zimmi.cz/posts/theme/css/style.min.css?a4089d0f">
</head>
<body>
    <nav role="navigation">
        <ul>
            <li><a href="https://www.zimmi.cz/posts/categories">Categories</a></li>
            <li><a href="https://www.zimmi.cz/posts/tags">Tags</a></li>
            <li><a href="https://www.zimmi.cz/posts/feed.xml">Subscribe to RSS feed</a></li>
        </ul>
    </nav>
    <header>
        <h1><a href="/posts">Michal Zimmermann<small>Pieces of knowledge from the world of GIS.</small></a></h1>
    </header>
    <main>
<h2 class="text-center">Articles tagged with QGIS tag</h2>

<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/qgis-plugin-development-finding-nearest-neighbors/" rel="bookmark" title="Permalink to QGIS Plugin Development: Finding NearestÂ Neighbors"><span class="caps">QGIS</span> Plugin Development: Finding Nearest&nbsp;Neighbors</a></h1>
    <aside><span>Nov 9, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/python.html">python</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/qgis.html">QGIS</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/qgis.html">QGIS</a></span>
    </aside>
    <p>I described basics of vector layers manipulation in <a href="https://www.zimmi.cz/posts/2017/qgis-plugin-development-using-python-console/">the previous part</a> of the series. With my goal in mind (fully functional custom plugin capable of writing an attribute value from a source layer to a target layer based on a feature distance), I&#8217;d like to discuss <strong>spatial indexing</strong> and <strong>nearest neighbor analysis</strong>.</p>
<div class="text-center"><img data-echo="/posts/assets/qgis-plugin-development-finding-nearest-neighbors/qgis.png"/></div>

<p>The picture above illustrates the task that can be solved solely by using <span class="caps">QGIS</span> <span class="caps">API</span>. Imagine you&#8217;re given a source layer with an attribute filled with values. You&#8217;re given a target layer as well, sadly though, the values in this layer are missing (<em>not so rare in the <span class="caps">GIS</span> world, right?</em>). Yet you know that the missing attribute value of each feature in the target layer can be filled by the value of its nearest neighbor from the source layer. How do you do&nbsp;that?</p>
<h2>Generating dummy&nbsp;data</h2>
<p>Let&#8217;s create two memory data sets with id and value attributes. Both of them will have ten&nbsp;features.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="n">QgsMapLayerRegistry</span><span class="p">,</span> <span class="n">QgsVectorLayer</span><span class="p">,</span> <span class="n">QgsFeature</span><span class="p">,</span> <span class="n">QgsGeometry</span><span class="p">,</span> <span class="n">QgsPoint</span><span class="p">,</span> <span class="n">QgsSpatialIndex</span>
<span class="kn">from</span> <span class="nn">qgis.utils</span> <span class="kn">import</span> <span class="n">iface</span>

<span class="n">source_layer</span> <span class="o">=</span> <span class="n">QgsVectorLayer</span><span class="p">(</span><span class="s2">&quot;point?crs=epsg:4326&amp;field=id:integer&amp;field=value:integer&quot;</span><span class="p">,</span> <span class="s2">&quot;Source layer&quot;</span><span class="p">,</span> <span class="s2">&quot;memory&quot;</span><span class="p">)</span>
<span class="n">target_layer</span> <span class="o">=</span> <span class="n">QgsVectorLayer</span><span class="p">(</span><span class="s2">&quot;point?crs=epsg:4326&amp;field=id:integer&amp;field=value:integer&quot;</span><span class="p">,</span> <span class="s2">&quot;Target layer&quot;</span><span class="p">,</span> <span class="s2">&quot;memory&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_dummy_data</span><span class="p">():</span>

    <span class="n">source_layer</span><span class="o">.</span><span class="n">startEditing</span><span class="p">()</span>
    <span class="n">target_layer</span><span class="o">.</span><span class="n">startEditing</span><span class="p">()</span>

    <span class="n">feature</span> <span class="o">=</span> <span class="n">QgsFeature</span><span class="p">(</span><span class="n">source_layer</span><span class="o">.</span><span class="n">pendingFields</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">QgsPoint</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">source_layer</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

    <span class="n">feature</span> <span class="o">=</span> <span class="n">QgsFeature</span><span class="p">(</span><span class="n">source_layer</span><span class="o">.</span><span class="n">pendingFields</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">QgsPoint</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">target_layer</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

    <span class="n">source_layer</span><span class="o">.</span><span class="n">commitChanges</span><span class="p">()</span>
    <span class="n">target_layer</span><span class="o">.</span><span class="n">commitChanges</span><span class="p">()</span>

    <span class="n">QgsMapLayerRegistry</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="n">source_layer</span><span class="p">)</span>
    <span class="n">QgsMapLayerRegistry</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="n">target_layer</span><span class="p">)</span>

<span class="n">create_dummy_data</span><span class="p">()</span>
</pre></div>


<h2>Writing values from the nearest&nbsp;neighbor</h2>
<p>The actual nearest neighbor analysis can be done in ten lines of code! First, the <code>qgis.core.QgsSpatialIndex</code> is built from all the <code>source_layer</code> features. Then, you iterate over the <code>target_layer</code> features and for each of them, gets only one (<code>nearestNeighbor(f.geometry().asPoint(), 1)[0]</code>) nearest neighbor. At last, you just write the nearest neighbor&#8217;s attribute value to the target layer and commit changes. Just use the following code with the code&nbsp;above.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">write_values_from_nn</span><span class="p">():</span>
    <span class="n">source_layer_index</span> <span class="o">=</span> <span class="n">QgsSpatialIndex</span><span class="p">(</span><span class="n">source_layer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">())</span>
    <span class="n">source_layer_features</span> <span class="o">=</span> <span class="p">{</span><span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">():</span> <span class="n">feature</span> <span class="k">for</span> <span class="p">(</span><span class="n">feature</span><span class="p">)</span> <span class="ow">in</span> <span class="n">source_layer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">()}</span>
    <span class="n">target_layer_features</span> <span class="o">=</span> <span class="n">target_layer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">()</span>

    <span class="n">target_layer</span><span class="o">.</span><span class="n">startEditing</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">target_layer_features</span><span class="p">:</span>
        <span class="n">nearest</span> <span class="o">=</span> <span class="n">source_layer_index</span><span class="o">.</span><span class="n">nearestNeighbor</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">asPoint</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">source_layer_features</span><span class="p">[</span><span class="n">nearest</span><span class="p">]</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
        <span class="n">target_layer</span><span class="o">.</span><span class="n">changeAttributeValue</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="n">target_layer</span><span class="o">.</span><span class="n">commitChanges</span><span class="p">()</span>

<span class="n">write_values_from_nn</span><span class="p">()</span>
</pre></div>


<h2>Missing pieces or what&#8217;s&nbsp;next</h2>
<p>I&#8217;m one step closer to my goal. What&#8217;s&nbsp;missing?</p>
<ul>
<li>capabilities checks: does the target layer support edits? Check the layer data provider capabilities to find&nbsp;out.</li>
<li>user logging: notices, warnings or errors are completely missing. It will be great to have them shown inside <code>qgis.gui.QgsMessageBar</code>.</li>
<li>custom attributes: this version expects both layers to have the same attribute with the same data&nbsp;type.</li>
<li><span class="caps">GUI</span>: a very simple PyQt widget will turn this console-based script into a custom plugin. That&#8217;s what&#8217;s going to be&nbsp;next.</li>
</ul>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/qgis-plugin-development-using-python-console/" rel="bookmark" title="Permalink to QGIS Plugin Development: Using PythonÂ Console"><span class="caps">QGIS</span> Plugin Development: Using Python&nbsp;Console</a></h1>
    <aside><span>Nov 2, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/python.html">python</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/qgis.html">QGIS</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/qgis.html">QGIS</a></span>
    </aside>
    <p>As mentioned in <a href="https://www.zimmi.cz/posts/2017/qgis-plugin-development-getting-started/">previous part</a> of the series, the <span class="caps">QGIS</span> Python console is an entry point to <span class="caps">GIS</span> workflow automation within <span class="caps">QGIS</span>. Remember there&#8217;s an <code>iface</code> object representing <code>qgis.gui.QgisInterface</code> instance within the console that gives you access to the whole <span class="caps">QGIS</span> <span class="caps">GUI</span>. Let&#8217;s see what we can do inside the&nbsp;console.</p>
<h2>Loading vector layers&nbsp;folder</h2>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="n">QgsMapLayerRegistry</span><span class="p">,</span> <span class="n">QgsVectorLayer</span>

<span class="k">def</span> <span class="nf">load_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
    <span class="n">VALID_EXTENSIONS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;.geojson&#39;</span><span class="p">,</span> <span class="s1">&#39;.gpkg&#39;</span><span class="p">,</span> <span class="s1">&#39;.shp&#39;</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;{}/*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">VALID_EXTENSIONS</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">QgsVectorLayer</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;ogr&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">layer</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
            <span class="n">iface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushCritical</span><span class="p">(</span><span class="s2">&quot;Failed to load:&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">QgsMapLayerRegistry</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

<span class="n">load_folder</span><span class="p">(</span><span class="s2">&quot;path/to/your/vector/files/folder&quot;</span><span class="p">)</span>
</pre></div>


<ul>
<li><code>QgsMapLayerRegistry</code> represents <em>Layers Panel</em> as present in the <span class="caps">QGIS</span> <span class="caps">GUI</span></li>
<li><code>iface.messageBar()</code> returns the message bar of the main app and lets you notify the user of what&#8217;s going on under the&nbsp;hood</li>
<li><code>QgsVectorLayer</code> represents a vector layer with its underlying vector data&nbsp;sets</li>
</ul>
<h2>Editing active layer attribute&nbsp;table</h2>
<p>The following code demonstrates the possibility to edit vector layer attribute table via&nbsp;console.</p>
<ul>
<li>Any attribute to be written has to come in form of a <code>qgis.core.QgsField</code> - this is more or less an encapsulation of an attribute name and its type (<code>PyQt4.QtCore.QVariant</code> to be&nbsp;precise)</li>
<li>The underlying data provider has to be capable of attribute addition (<code>caps &amp; QgsVectorDataProvider.AddAttributes</code>)</li>
<li><code>QgsVectorLayer.addAttribute</code> method returns boolean rather than throwing an&nbsp;exception</li>
</ul>
<!-- -->

<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="n">QgsField</span>
<span class="kn">from</span> <span class="nn">qgis.gui</span> <span class="kn">import</span> <span class="n">QgsMessageBar</span>
<span class="kn">from</span> <span class="nn">PyQt4.QtCore</span> <span class="kn">import</span> <span class="n">QVariant</span>


<span class="k">def</span> <span class="nf">edit_active_layer</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_type</span><span class="p">):</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">iface</span><span class="o">.</span><span class="n">activeLayer</span><span class="p">()</span>
    <span class="n">caps</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">dataProvider</span><span class="p">()</span><span class="o">.</span><span class="n">capabilities</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">caps</span> <span class="o">&amp;</span> <span class="n">QgsVectorDataProvider</span><span class="o">.</span><span class="n">AddAttributes</span><span class="p">:</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">startEditing</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">QgsField</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_type</span><span class="p">)):</span>
            <span class="n">iface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushMessage</span><span class="p">(</span><span class="s2">&quot;Attribute {0} was successfully added to the active layer.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr_name</span><span class="p">),</span> <span class="n">QgsMessageBar</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">)</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">commitChanges</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushMessage</span><span class="p">(</span><span class="s2">&quot;Attribute {0} was not added. Does it already exist?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr_name</span><span class="p">),</span> <span class="n">QgsMessageBar</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">rollBack</span><span class="p">()</span>

<span class="n">edit_active_layer</span><span class="p">(</span><span class="s2">&quot;new_string_attribute&quot;</span><span class="p">,</span> <span class="n">QVariant</span><span class="o">.</span><span class="n">String</span><span class="p">)</span>
</pre></div>


<p>The whole series aims to present a plugin capable of writing a new attribute and its value to an existing layer. Thus, this code might come handy in the&nbsp;future.</p>
<h2>Creating a new vector&nbsp;layer</h2>
<p>It&#8217;s possible to create a whole new vector layer with <span class="caps">QGIS</span> Python console. I present a very simple <code>create_new_layer</code> function, yet I hope you can imagine the ways it can be&nbsp;tweaked.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="n">QgsField</span><span class="p">,</span> <span class="n">QgsFields</span><span class="p">,</span> <span class="n">QgsVectorLayer</span><span class="p">,</span> <span class="n">QgsFeature</span><span class="p">,</span> <span class="n">QgsGeometry</span><span class="p">,</span> <span class="n">QgsPoint</span>
<span class="kn">from</span> <span class="nn">PyQt4.QtCore</span> <span class="kn">import</span> <span class="n">QVariant</span>

<span class="k">def</span> <span class="nf">create_new_layer</span><span class="p">():</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;/path/to/your/vector/file.gpkg&quot;</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="n">QgsFields</span><span class="p">()</span>
    <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">QgsField</span><span class="p">(</span><span class="s2">&quot;attr1&quot;</span><span class="p">,</span> <span class="n">QVariant</span><span class="o">.</span><span class="n">String</span><span class="p">))</span>
    <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">QgsField</span><span class="p">(</span><span class="s2">&quot;attr2&quot;</span><span class="p">,</span> <span class="n">QVariant</span><span class="o">.</span><span class="n">Int</span><span class="p">))</span>

    <span class="nb">file</span> <span class="o">=</span> <span class="n">QgsVectorFileWriter</span><span class="p">(</span>
        <span class="n">filename</span><span class="p">,</span>
        <span class="s2">&quot;UTF8&quot;</span><span class="p">,</span>
        <span class="n">fields</span><span class="p">,</span>
        <span class="n">QGis</span><span class="o">.</span><span class="n">WKBPoint</span><span class="p">,</span>
        <span class="n">QgsCoordinateReferenceSystem</span><span class="p">(</span><span class="mi">4326</span><span class="p">),</span>
        <span class="s2">&quot;GPKG&quot;</span>
    <span class="p">)</span>

    <span class="n">layer</span> <span class="o">=</span> <span class="n">QgsVectorLayer</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;ogr&quot;</span><span class="p">)</span>
    <span class="n">QgsMapLayerRegistry</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">layer</span><span class="o">.</span><span class="n">dataProvider</span><span class="p">()</span><span class="o">.</span><span class="n">capabilities</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">QgsVectorDataProvider</span><span class="o">.</span><span class="n">AddAttributes</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">feature</span> <span class="o">=</span> <span class="n">QgsFeature</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">pendingFields</span><span class="p">())</span>
    <span class="n">feature</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">QgsGeometry</span><span class="p">()</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">QgsPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="n">feature</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s2">&quot;attr1&quot;</span><span class="p">,</span> <span class="s2">&quot;attr1&quot;</span><span class="p">)</span>
    <span class="n">feature</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s2">&quot;attr2&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">layer</span><span class="o">.</span><span class="n">startEditing</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">commitChanges</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">rollBack</span><span class="p">()</span>
        <span class="n">iface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushMessage</span><span class="p">(</span><span class="s2">&quot;Feature addition failed.&quot;</span><span class="p">,</span> <span class="n">QgsMessageBar</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>

<span class="n">create_new_layer</span><span class="p">()</span>
</pre></div>


<p>Those were just few examples of what can be done with <span class="caps">QGIS</span> <span class="caps">API</span> and Python console. Next time, I&#8217;d like to focus on spatial joins inside <span class="caps">QGIS</span> - another step to the final&nbsp;plugin.</p>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/qgis-plugin-development-getting-started/" rel="bookmark" title="Permalink to QGIS Plugin Development: GettingÂ Started"><span class="caps">QGIS</span> Plugin Development: Getting&nbsp;Started</a></h1>
    <aside><span>Oct 26, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/python.html">python</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/qgis.html">QGIS</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/qgis.html">QGIS</a></span>
    </aside>
    <p><span class="caps">QGIS</span> 2.1x is a brilliant tool for Python-based automation in form of custom scripts or even plugins. The first steps towards writing the custom code might be a bit difficult, as you need to grasp quite complex Python <span class="caps">API</span>. The <em><span class="caps">QGIS</span> Plugin Development</em> series (see the list of other parts at the end of this article) targets pitfalls and traps I&#8217;ve met while learning to use it&nbsp;myself.</p>
<p>The outcome of the series is going to be <strong>a fully functional custom plugin</strong> capable of writing attribute values from a source layer nearest neighbour to a target layer based on their spatial&nbsp;proximity.</p>
<p>In this part, I&#8217;ll mention the basics a.k.a. what is good to know before you&nbsp;start.</p>
<h2>Documentation</h2>
<p>Different <span class="caps">QGIS</span> versions come with different Python <span class="caps">API</span>. The documentation is to be found at <a href="http://qgis.org">https://qgis.org</a>, the latest being <a href="http://qgis.org/api/2.18/">version 2.18</a>. Note that if you come directly to <a href="http://qgis.org/api/">http://qgis.org/api/</a>, you&#8217;ll see the current master&nbsp;docs.</p>
<p>Alternatively, you can <code>apt install qgis-api-doc</code> on your Ubuntu-based system and run <code>python -m SimpleHTTPServer [port]</code> inside <code>/usr/share/qgis/doc/api</code>. You&#8217;ll find the documentation at <a href="http://localhost:8000">http://localhost:8000</a> (if you don&#8217;t provide port number) and it will be available even when you&#8217;re&nbsp;offline.</p>
<h2>Basic <span class="caps">API</span> objects&nbsp;structure</h2>
<p>Before launching <span class="caps">QGIS</span>, take a look at what&#8217;s available inside <span class="caps">API</span>:</p>
<ul>
<li><strong>qgis.core</strong> package brings all the basic objects like QgsMapLayer, QgsDataSourceURI, QgsFeature&nbsp;etc</li>
<li><strong>qgis.gui</strong> package brings <span class="caps">GUI</span> elements that can be used within <span class="caps">QGIS</span> like QgsMessageBar or QgsInterface (very important <span class="caps">API</span> element, exposed to all custom&nbsp;plugins)</li>
<li><strong>qgis.analysis</strong>, <strong>qgis.networkanalysis</strong>, <strong>qgis.server</strong>, and <strong>qgis.testing</strong> packages that won&#8217;t be covered in the&nbsp;series</li>
<li><strong>qgis.utils</strong> module that comes with <code>iface</code> exposed (very handy within <span class="caps">QGIS</span> Python&nbsp;console)</li>
</ul>
<h2><span class="caps">QGIS</span> Python&nbsp;Console</h2>
<p>Using Python console is the easiest way to automate your <span class="caps">QGIS</span> workflow. It can be accessed via pressing <code>Ctrl + Alt + P</code> or navigating to <code>Plugins -&gt; Python Console</code>. Note the above mentioned <code>iface</code> from <strong>qgis.utils</strong> module is exposed by default within the console, letting you interact with <span class="caps">QGIS</span> <span class="caps">GUI</span>. Try out the following&nbsp;examples.</p>
<div class="highlight"><pre><span></span><span class="n">iface</span><span class="o">.</span><span class="n">mapCanvas</span><span class="p">()</span><span class="o">.</span><span class="n">scale</span><span class="p">()</span> <span class="c1"># returns the current map scale</span>
<span class="n">iface</span><span class="o">.</span><span class="n">mapCanvas</span><span class="p">()</span><span class="o">.</span><span class="n">zoomScale</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># zoom to scale of 1:100</span>
<span class="n">iface</span><span class="o">.</span><span class="n">activeLayer</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="c1"># get the active layer name</span>
<span class="n">iface</span><span class="o">.</span><span class="n">activeLayer</span><span class="p">()</span><span class="o">.</span><span class="n">startEditing</span><span class="p">()</span> <span class="c1"># toggle editting</span>
</pre></div>


<p>That was a very brief introduction to <span class="caps">QGIS</span> <span class="caps">API</span>, the next part will walk you through the console more&nbsp;thoroughly.</p>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/mapping-north-america-with-qgis-tips-and-tricks" rel="bookmark" title="Permalink to Mapping North America with QGIS: Tips andÂ Tricks">Mapping North America with <span class="caps">QGIS</span>: Tips and&nbsp;Tricks</a></h1>
    <aside><span>May 21, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/qgis.html">qgis</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/visualization.html">visualization</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/gis.html">GIS</a></span>
    </aside>
    <p>Recently I&#8217;ve bought a book called <em>Maps</em> by Aleksandra Mizielinska and Daniel Mizielinski to my nephew. The book&#8217;s absolutely wonderful and made me want to try crafting a map with similar looks. I don&#8217;t do maps much at <a href="https://clevermaps.cz">CleverMaps</a>, so this was a great opportunity to find out what new features became available during the last months of <span class="caps">QGIS</span>&nbsp;development.</p>
<h2>Result</h2>
<p>A map of North America in scale of 1:22,000,000 featuring the biggest lakes, rivers, mountain ranges and basic administrative units for the North American countries. I aimed for visually appealing overview map rather than perfectly correct topographic&nbsp;one.</p>
<div class="text-center"><a href="/posts/assets/mapping-north-america-with-qgis-tips-and-tricks/map.png" title="Click for the full size (3 MB)"><img data-echo="/posts/assets/mapping-north-america-with-qgis-tips-and-tricks/map.min.png"/></a></div>

<h2>Data</h2>
<p>I used my beloved <a href="http://www.naturalearthdata.com">Natural Earth dataset</a> for both cultural (boundaries, cities) and physical (rivers, lakes) map features. Different scales came to play for different map layers as they seemed a bit too/few simplified for the given&nbsp;scale.</p>
<h2>Fonts</h2>
<p>I usually use built-in system fonts (Ubuntu Condensed or such), but this kind of map needed a more handwritten looking, sort of childish font. After searching <a href="dafont.com">dafont.com</a> I chose <a href="http://www.dafont.com/es/precursive.font">PreCursive by RaseOne Full Time Artists</a> and <a href="http://www.dafont.com/es/kg-primary-penmanship.font"><span class="caps">KG</span> Primary Penmanship by Kimberly Geswein</a>.</p>
<h2>Symbols</h2>
<p>The mountain point symbol was one of the two custom symbols used on the map. It comes from <a href="http://all-free-download.com/free-vector/download/mountains_311829.html">BSGStudio</a>. The ocean wave symbol was made by&nbsp;myself.</p>
<h2><span class="caps">QGIS</span>&nbsp;effects</h2>
<p>I&#8217;ve used several techniques I find interesting enough to be listed&nbsp;here.</p>
<h3>Coastlines</h3>
<p>For a long time I&#8217;ve considered coastlines a field for cartographic invention. They can be emphasized by shading or 3D effects. I chose the set of four parallel coastlines subtly disappearing into the sea, hopefully invoking the feeling of waves coming to the&nbsp;shore.</p>
<div class="text-center"><img data-echo="/posts/assets/mapping-north-america-with-qgis-tips-and-tricks/coastlines.png"/></div>

<p>It&#8217;s done by dissolving all the features and buffering them again and&nbsp;again.</p>
<h3>Buffered&nbsp;labels</h3>
<p>Buffered labels are usually hard to get right, because they fill so much space if the buffer color&#8217;s not corresponding to its surroundings. But choosing the proper color can be a real struggle at&nbsp;times.</p>
<div class="text-center"><img data-echo="/posts/assets/mapping-north-america-with-qgis-tips-and-tricks/qgis_expressions.png"/></div>

<p>On this map, almost all the labels are buffered with the color of its surroundings, which makes them more legible, yet not too expressive. This is possible thanks to <span class="caps">QGIS</span> expression based properties that let you define unique styling to different map&nbsp;features.</p>
<div class="text-center"><img data-echo="/posts/assets/mapping-north-america-with-qgis-tips-and-tricks/buffered_labels.png"/></div>

<p>Where it isn&#8217;t possible (e.g. Bahamas or Honduras) to choose just one buffer color, the label is not buffered at all (or the semi-transparent white buffer is&nbsp;used).</p>
<p>Note the <em>Rocky Mountains</em> label is split on the borders of the <span class="caps">U.S.A.</span> and Canada and its both parts match the background&nbsp;color.</p>
<h3>Tapered&nbsp;rivers</h3>
<p>Rivers are tapered based on the Natural Earth&#8217;s width attribute value for each river&nbsp;segment.</p>
<h3>Labels in separate&nbsp;layers</h3>
<p>I&#8217;m used to put labels into separate layers in more complicated map compositions, especially when you need to draw label along path for areal features (such as countries or&nbsp;states).</p>
<div class="text-center"><img data-echo="/posts/assets/mapping-north-america-with-qgis-tips-and-tricks/labels.png"/></div>

<p>It becomes a bit harder to keep the features in sync with the labels though. I&#8217;d like to use only one layer for all the map layers in the future, as I feel that&#8217;s the way to go for the best&nbsp;labeling.</p>
<h3>Labels wrapped on&nbsp;character</h3>
<p>Some labels just can&#8217;t fit the feature they belong to and <span class="caps">QGIS</span> lets you deal with this by wrapping labels on a special character, <code>\</code> in my&nbsp;case.</p>
<div class="text-center"><img data-echo="/posts/assets/mapping-north-america-with-qgis-tips-and-tricks/wrapped_labels.png"/></div>

<h3>Layer blending&nbsp;mode</h3>
<p>The mechanics behind layer blending modes are still a mystery to me, but they can add that little extra to a map very easily. Thanks to the Overlay blending mode, <em>the Rocky Mountains</em> may remain very subtle on different kinds of&nbsp;background.</p>
<div class="text-center"><img data-echo="/posts/assets/mapping-north-america-with-qgis-tips-and-tricks/blending_mode.png"/></div>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/wifileaks-wi-fi-networks-dataviz/" rel="bookmark" title="Permalink to Wifileaks Wi-Fi NetworksÂ Dataviz">Wifileaks Wi-Fi Networks&nbsp;Dataviz</a></h1>
    <aside><span>May 2, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/qgis.html">qgis</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/visualization.html">visualization</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/gis.html">GIS</a></span>
    </aside>
    <p><a href="http://www.wifileaks.cz">Wifileaks</a> is a project by Jakub ÄÃ­Å¾ek aimed to map the Czech wi-fi networks with Android/iOS app. The data gathered by people using the app <a href="http://download.wifileaks.cz/data/wifileaks_raw_170416.tar.gz">is available to download</a> and features ~&nbsp;90,000,000 records, each representing the position of the cellphone when connecting to the network. Just about perfect to craft some&nbsp;maps!</p>
<div class="text-center"><img data-echo="/posts/assets/wifileaks-wifi-networks-dataviz/cr.png"/></div>

<h2>Using PostgreSQL&nbsp;cstore_fdw</h2>
<p>I ran out of disk space immediately after loading the dataset into the PostgreSQL database. After fiddling around I remembered that columnar store should be a bit space-friendlier than the old fashioned relational database. Thus, I installed the <a href="https://github.com/citusdata/cstore_fdw">cstore_fdw</a> by Citus Data in just few&nbsp;steps.</p>
<div class="highlight"><pre><span></span>sudo apt install libprotobuf-c-dev libprotobuf-c1 protobuf-c-compiler postgresql-server-dev-9.6
git clone git@github.com:citusdata/cstore_fdw.git
<span class="nv">PATH</span><span class="o">=</span>/usr/bin/:<span class="nv">$PATH</span> make
<span class="nv">PATH</span><span class="o">=</span>/usr/bin/:<span class="nv">$PATH</span> make install

<span class="c1"># when the cstore_fdw installation finishes, add the following line to your postgresql.conf and restart the database cluster</span>
<span class="nv">shared_preload_libraries</span> <span class="o">=</span> <span class="s1">&#39;cstore_fdw&#39;</span>
</pre></div>


<p>This makes <a href="https://www.zimmi.cz/posts/2016/testing-postgresql-ogr-fdw/">another <span class="caps">FDW</span> available</a> to you inside the PostgreSQL. The actual foreign server has to be created before loading the data into a foreign&nbsp;table.</p>
<div class="highlight"><pre><span></span>cat <span class="s">&lt;&lt;END | psql -qAt --no-psqlrc</span>
<span class="s">    CREATE SERVER cstore_server FOREIGN DATA WRAPPER cstore_fdw;</span>
<span class="s">    CREATE SCHEMA data_cstore;</span>
<span class="s">    CREATE FOREIGN TABLE data_cstore.wifi (</span>
<span class="s">        id integer,</span>
<span class="s">        mac text,</span>
<span class="s">        ssid text,</span>
<span class="s">        signal_strength numeric,</span>
<span class="s">        security integer,</span>
<span class="s">        lat numeric,</span>
<span class="s">        lon numeric,</span>
<span class="s">        alt numeric,</span>
<span class="s">        unixtime bigint,</span>
<span class="s">        filename text</span>
<span class="s">    )</span>
<span class="s">    SERVER cstore_server</span>
<span class="s">    OPTIONS (compression &#39;pglz&#39;);</span>
<span class="s">END</span>
</pre></div>


<p>The foreign table <strong>is 3&times; smaller</strong> than it&#8217;s standard counterpart. However, this comes with some&nbsp;costs:</p>
<ul>
<li>neither <code>UPDATE</code> nor <code>DELETE</code> can be&nbsp;used</li>
<li>no <code>CREATE INDEX</code></li>
<li>no <code>SERIAL</code></li>
</ul>
<p>To overcome these shortcomings I used <code>COPY</code> statement to spit out the slightly modified table and immediately loaded it back&nbsp;in.</p>
<div class="highlight"><pre><span></span>cat <span class="s">&lt;&lt;END | psql -qAt --no-psqlrc</span>
<span class="s">COPY (</span>
<span class="s">    SELECT</span>
<span class="s">        row_number() OVER (),</span>
<span class="s">        mac,</span>
<span class="s">        ssid,</span>
<span class="s">        signal_strength,</span>
<span class="s">        security,</span>
<span class="s">        split_part(filename, &#39;_&#39;, 2)::integer,</span>
<span class="s">        to_timestamp(unixtime),</span>
<span class="s">        ST_Transform(ST_SetSRID(ST_MakePoint(lon, lat, alt), 4326), 32633)</span>
<span class="s">    FROM data_cstore.wifi</span>
<span class="s">    WHERE lon BETWEEN 0 AND 20</span>
<span class="s">        AND lat BETWEEN 18 AND 84</span>
<span class="s">) TO &#39;/tmp/wifileaks.db&#39; WITH CSV DELIMITER &#39;;&#39;</span>
<span class="s">    DROP SCHEMA IF EXISTS data_cstore CASCADE;</span>

<span class="s">DROP SCHEMA data_cstore;</span>
<span class="s">CREATE SCHEMA data_cstore;</span>
<span class="s">CREATE FOREIGN TABLE data_cstore.wifi (</span>
<span class="s">    id integer,</span>
<span class="s">    mac text,</span>
<span class="s">    ssid text,</span>
<span class="s">    signal_strength numeric,</span>
<span class="s">    security integer,</span>
<span class="s">    userid integer,</span>
<span class="s">    unixtime timestamp without time zone,</span>
<span class="s">    geom geometry(POINTZ, 32633)</span>
<span class="s">)</span>
<span class="s">SERVER cstore_server</span>
<span class="s">OPTIONS (compression &#39;pglz&#39;);</span>
<span class="s">END</span>
</pre></div>


<h2>Putting the networks on the&nbsp;map</h2>
<table>
    <tr>
        <td><a href="/posts/assets/wifileaks-wifi-networks-dataviz/brno.png"><img data-echo="/posts/assets/wifileaks-wifi-networks-dataviz/brno.png"></a></td>
        <td><a href="/posts/assets/wifileaks-wifi-networks-dataviz/praha.png"><img data-echo="/posts/assets/wifileaks-wifi-networks-dataviz/praha.png"></a></td>
        <td><a href="/posts/assets/wifileaks-wifi-networks-dataviz/olomouc.png"><img data-echo="/posts/assets/wifileaks-wifi-networks-dataviz/olomouc.png"></a></td>
    </tr>
    <tr>
        <td><a href="/posts/assets/wifileaks-wifi-networks-dataviz/plzen.png"><img data-echo="/posts/assets/wifileaks-wifi-networks-dataviz/plzen.png"></a></td>
        <td><a href="/posts/assets/wifileaks-wifi-networks-dataviz/ostrava.png"><img data-echo="/posts/assets/wifileaks-wifi-networks-dataviz/ostrava.png"></a></td>
        <td><a href="/posts/assets/wifileaks-wifi-networks-dataviz/hradec_kralove.png"><img data-echo="/posts/assets/wifileaks-wifi-networks-dataviz/hradec_kralove.png"></a></td>
    </tr>
</table>

<p>As mentioned, each row of data represents the cellphone&#8217;s location when connecting to a wi-fi network. To get real wi-fi transmitter position, I calculated the average of location of each cellphone ever connected (although the signal strength should be taken into account here as&nbsp;well).</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="n">UNLOGGED</span> <span class="k">TABLE</span> <span class="n">data_cstore</span><span class="p">.</span><span class="n">wifi_avg_loc</span> <span class="k">AS</span>
<span class="k">SELECT</span>
    <span class="n">row_number</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">()</span> <span class="n">id</span><span class="p">,</span>
    <span class="n">mac</span><span class="p">,</span>
    <span class="n">ST_SetSRID</span><span class="p">(</span><span class="n">ST_MakePoint</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="mi">32633</span><span class="p">)</span> <span class="n">geom</span>
<span class="k">FROM</span> <span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">mac</span><span class="p">,</span>
        <span class="k">AVG</span><span class="p">(</span><span class="n">ST_X</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span> <span class="n">x</span><span class="p">,</span>
        <span class="k">AVG</span><span class="p">(</span><span class="n">ST_Y</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span> <span class="n">y</span>
    <span class="k">FROM</span> <span class="n">data_cstore</span><span class="p">.</span><span class="n">wifi_loc</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span>
<span class="p">)</span> <span class="n">a</span><span class="p">;</span>
</pre></div>
</article>
<aside id="pagination">
            <a href="https://www.zimmi.cz/posts/tag/qgis2.html">Next page &raquo;</a>
</aside>    </main>
    <footer>
        Written by <a href="//www.zimmi.cz">Michal Zimmermann</a>.
        Proudly powered by <a href="//getpelican.com/">Pelican</a>,
        which takes great advantage of <a href="//python.org">Python</a>.
    </footer>
<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-43432739-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments)};
  gtag('js', new Date());

  gtag('config', 'UA-43432739-2');
</script>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NW8R37N');</script>
<!-- End Google Tag Manager -->
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NW8R37N"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<script src="https://www.zimmi.cz/posts/theme/js/echo.min.js"></script>
<script>
echo.init({
  offset: 200,
  throttle: 250,
  unload: false
});
</script>
</body>
</html>