<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
        <title>Michal Zimmermann | tag: postgresql</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed" rel="stylesheet">
        <link href="https://www.zimmi.cz/posts/atom.xml" type="application/atom+xml" rel="alternate" title="Michal Zimmermann Full Atom Feed" />
        <link href="https://www.zimmi.cz/posts/feed.xml" type="application/rss+xml" rel="alternate" title="Michal Zimmermann Full RSS Feed" />
        <link rel="stylesheet" href="https://www.zimmi.cz/posts/theme/css/style.min.css?1ec62741">
</head>
<body>
    <nav role="navigation">
        <ul>
            <li><a href="https://www.zimmi.cz/posts/categories">Categories</a></li>
            <li><a href="https://www.zimmi.cz/posts/tags">Tags</a></li>
            <li><a href="https://www.zimmi.cz/posts/feed.xml">Subscribe to RSS feed</a></li>
        </ul>
    </nav>
    <header>
        <h1><a href="/posts">Michal Zimmermann<small>Pieces of knowledge from the world of GIS.</small></a></h1>
    </header>
    <main>
<h2 class="text-center">Articles tagged with postgresql tag</h2>

<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/postgresql-dollar-quoting-inside-bash-heredoc/" rel="bookmark" title="Permalink to PostgreSQL Dollar Quoting inside Bash Heredoc">PostgreSQL Dollar Quoting inside Bash&nbsp;Heredoc</a></h1>
    <aside><span>Sep 22, 2017</span>
    <span>    <a href="https://www.zimmi.cz/posts/tag/sql.html">sql</a>     <a href="https://www.zimmi.cz/posts/tag/postgresql.html">postgresql</a>     <a href="https://www.zimmi.cz/posts/tag/bash.html">bash</a>    </span>
    <span><a href="https://www.zimmi.cz/posts/category/sql.html">SQL</a></span>
    </aside>
    <p>Yesterday I spent two very unpleasant hours debugging the weirdest <span class="caps">SQL</span> error I&#8217;ve seen in my life, running the below query (simplified for this&nbsp;post).</p>
<div class="highlight"><pre><span></span><span class="n">psql</span> <span class="o">-</span><span class="n">qAt</span> <span class="c1">--no-psqlrc &lt;&lt;BACKUP</span>
<span class="k">DO</span>
<span class="err">$$</span>
<span class="k">DECLARE</span> <span class="n">r</span> <span class="n">record</span><span class="p">;</span>
<span class="k">BEGIN</span>
  <span class="n">RAISE</span> <span class="n">INFO</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">;</span>
<span class="k">END</span>
<span class="err">$$</span><span class="p">;</span>
<span class="n">BACKUP</span>
</pre></div>


<p>Running this in your terminal will result in a nasty syntax&nbsp;error.</p>
<div class="highlight"><pre><span></span>ERROR:  syntax error at or near <span class="s2">&quot;1111&quot;</span>
LINE <span class="m">2</span>: <span class="m">1111</span>
        ^
ERROR:  syntax error at or near <span class="s2">&quot;RAISE&quot;</span>
LINE <span class="m">2</span>:   RAISE INFO <span class="s1">&#39;%&#39;</span>, <span class="s1">&#39;info&#39;</span><span class="p">;</span>
          ^
ERROR:  syntax error at or near <span class="s2">&quot;1111&quot;</span>
LINE <span class="m">2</span>: <span class="m">1111</span><span class="p">;</span>
</pre></div>


<p>You stare on the screen for a while, absolutely sure that number <code>1111</code> is nowhere close to the data you work with. You try again. Another error. You save the code into a file and try again. It works. What the <em>heck</em>? You try again using the bash heredoc. Another&nbsp;failure.</p>
<p>The minute you realize <code>$$</code> is being substituted with the <span class="caps">ID</span> of the current process, you feel like the dumbest person on Earth. Yet the happiest one at the same&nbsp;time.</p>
<p>The solution is&nbsp;trivial.</p>
<div class="highlight"><pre><span></span><span class="n">psql</span> <span class="o">-</span><span class="n">qAt</span> <span class="c1">--no-psqlrc &lt;&lt;BACKUP</span>
<span class="k">DO</span>
<span class="err">\$\$</span>
<span class="k">DECLARE</span> <span class="n">r</span> <span class="n">record</span><span class="p">;</span>
<span class="k">BEGIN</span>
  <span class="n">RAISE</span> <span class="n">INFO</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">;</span>
<span class="k">END</span>
<span class="err">\$\$</span><span class="p">;</span>
<span class="n">BACKUP</span>
</pre></div>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/postgresql-development-history-revealed-with-postgresql/" rel="bookmark" title="Permalink to PostgreSQL Development History Revealed with PostgreSQL">PostgreSQL Development History Revealed with&nbsp;PostgreSQL</a></h1>
    <aside><span>Aug 9, 2017</span>
    <span>    <a href="https://www.zimmi.cz/posts/tag/postgresql.html">postgresql</a>     <a href="https://www.zimmi.cz/posts/tag/python.html">python</a>    </span>
    <span><a href="https://www.zimmi.cz/posts/category/sql.html">SQL</a></span>
    </aside>
    <p>I spend a lot of time reading <a href="https://www.postgresql.org/docs/manuals/">PostgreSQL docs</a>. It occurred to me just a few weeks ago that those versioned manuals are great opportunity to get an insight into PostgreSQL development history. Using PostgreSQL, of&nbsp;course.</p>
<h2><span class="caps">TOP</span> 5 functions with the most verbose docs in each&nbsp;version</h2>
<div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="k">version</span><span class="p">,</span>
    <span class="n">string_agg</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39; | &#39;</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">letter_count</span> <span class="k">DESC</span><span class="p">)</span>
<span class="k">FROM</span> <span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="k">version</span><span class="p">,</span>
        <span class="n">func</span><span class="p">,</span>
        <span class="n">letter_count</span><span class="p">,</span>
        <span class="n">row_number</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="k">version</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">letter_count</span> <span class="k">DESC</span><span class="p">)</span>
    <span class="k">FROM</span> <span class="n">postgresql_development</span><span class="p">.</span><span class="k">data</span>
<span class="p">)</span> <span class="n">a</span>
<span class="k">WHERE</span> <span class="n">row_number</span> <span class="o">&lt;=</span> <span class="mi">10</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">version</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">version</span> <span class="k">DESC</span>
</pre></div>


<p>Seems like a huge comeback for <code>CREATE TABLE</code>.</p>
<table>
<thead>
<tr>
<th><span class="caps">VERSION</span></th>
<th>1st</th>
<th>2nd</th>
<th>3rd</th>
<th>4th</th>
<th>5th</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.0</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>9.6</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>9.5</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>9.4</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>9.3</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">DEFAULT</span> <span class="caps">PRIVILEGES</span></td>
</tr>
<tr>
<td>9.2</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">DEFAULT</span> <span class="caps">PRIVILEGES</span></td>
</tr>
<tr>
<td>9.1</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">DEFAULT</span> <span class="caps">PRIVILEGES</span></td>
</tr>
<tr>
<td>9.0</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">DEFAULT</span> <span class="caps">PRIVILEGES</span></td>
</tr>
<tr>
<td>8.4</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>8.3</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">COMMENT</span></td>
</tr>
<tr>
<td>8.2</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>8.1</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>8</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
</tr>
<tr>
<td>7.4</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>7.3</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
</tr>
<tr>
<td>7.2</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span> <span class="caps">INTO</span></td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TYPE</span></td>
</tr>
<tr>
<td>7.1</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span> <span class="caps">INTO</span></td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TYPE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
</tr>
<tr>
<td>7.0</td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">SELECT</span> <span class="caps">INTO</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TYPE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">COMMENT</span></td>
</tr>
</tbody>
</table>
<h2>Number of functions available in each&nbsp;version</h2>
<div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="k">version</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="n">func</span><span class="p">),</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">letter_count</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">postgresql_development</span><span class="p">.</span><span class="k">data</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">version</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">version</span><span class="p">;</span>
</pre></div>


<div class="text-center"><img src="https://www.zimmi.cz/posts/assets/postgresql-development-history-revealed-with-postgresql/plot1.png"/></div>

<h2>The most verbose docs in each&nbsp;version</h2>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">ON</span> <span class="p">(</span><span class="k">version</span><span class="p">)</span>
    <span class="k">version</span><span class="p">,</span>
    <span class="n">func</span><span class="p">,</span>
    <span class="n">letter_count</span>
<span class="k">FROM</span> <span class="n">postgresql_development</span><span class="p">.</span><span class="k">data</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">version</span><span class="p">,</span> <span class="n">letter_count</span> <span class="k">DESC</span><span class="p">;</span>
</pre></div>


<p>Poor <code>REVOKE</code>, the defeated&nbsp;champion.</p>
<div class="text-center">
    <table style="margin-left:auto; margin-right: auto">
    <thead>
    <tr>
    <th><span class="caps"><span class="caps">VERSION</span></span></th>
    <th><span class="caps"><span class="caps">FUNCTION</span></span></th>
    <th><span class="caps"><span class="caps">LETTER</span></span> <span class="caps"><span class="caps">COUNT</span></span></th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td>10</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>3142</td>
    </tr>
    <tr>
    <td>9.6</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.5</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.4</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.3</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.2</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.1</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2508</td>
    </tr>
    <tr>
    <td>9</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2502</td>
    </tr>
    <tr>
    <td>8.4</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2105</td>
    </tr>
    <tr>
    <td>8.3</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>1485</td>
    </tr>
    <tr>
    <td>8.2</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>1527</td>
    </tr>
    <tr>
    <td>8.1</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>1312</td>
    </tr>
    <tr>
    <td>8</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>1251</td>
    </tr>
    <tr>
    <td>7.4</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>1075</td>
    </tr>
    <tr>
    <td>7.3</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>929</td>
    </tr>
    <tr>
    <td>7.2</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>929</td>
    </tr>
    <tr>
    <td>7.1</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>871</td>
    </tr>
    <tr>
    <td>7</td>
    <td><span class="caps"><span class="caps">SELECT</span></span></td>
    <td>450</td>
    </tr>
    </tbody>
    </table>
</div>

<h2><span class="caps">CREATE</span> <span class="caps">TABLE</span> docs&nbsp;evolution</h2>
<div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="k">version</span><span class="p">,</span>
    <span class="n">letter_count</span>
<span class="k">FROM</span> <span class="n">postgresql_development</span><span class="p">.</span><span class="k">data</span>
<span class="k">WHERE</span> <span class="n">func</span> <span class="o">=</span> <span class="s1">&#39;CREATE TABLE&#39;</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">func</span><span class="p">,</span> <span class="k">version</span><span class="p">;</span>
</pre></div>


<p>Something&#8217;s going on in an upcoming 10.0&nbsp;version.</p>
<div class="text-center"><img src="https://www.zimmi.cz/posts/assets/postgresql-development-history-revealed-with-postgresql/plot2.png"/></div>

<p>All the data was obtained with the following Python script and processed inside the PostgreSQL database. Plots done with <a href="http://bokeh.pydata.org/en/latest/">Bokeh</a>, though I probably wouldn&#8217;t use it again, the docs site is absurdly sluggish and the info is just all over the&nbsp;place.</p>
<script src="https://gist.github.com/zimmicz/f69a5ce5d3cf3a220e171553c35e0391.js"></script>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/upgrading-postgresql-95-to-postgresql-96-with-postgis/" rel="bookmark" title="Permalink to Upgrading PostgreSQL 9.5 to PostgreSQL 9.6 with PostGIS">Upgrading PostgreSQL 9.5 to PostgreSQL 9.6 with&nbsp;PostGIS</a></h1>
    <aside><span>Mar 1, 2017</span>
    <span>    <a href="https://www.zimmi.cz/posts/tag/sql.html">sql</a>     <a href="https://www.zimmi.cz/posts/tag/postgresql.html">postgresql</a>    </span>
    <span><a href="https://www.zimmi.cz/posts/category/sql.html">SQL</a></span>
    </aside>
    <p>Thanks to <code>pg_upgrade</code> tool the PostgreSQL upgrade on Ubuntu is pretty straightforward. Different PostGIS versions might cause troubles though. This post covers PostgreSQL 9.5, PostGIS 2.2 to PostgreSQL 9.6, PostGIS 2.3&nbsp;migration.</p>
<p>First of all, install the PostgreSQL 9.6 with PostGIS&nbsp;2.3.</p>
<div class="highlight"><pre><span></span>apt install postgresql-9.6 postgresql-9.6-postgis-2.3
</pre></div>


<p>Mind that newly installed database cluster runs on port <code>5433</code>.</p>
<p>If you run <code>pg_upgrade</code> at this stage, it will fail with the following&nbsp;error.</p>
<div class="highlight"><pre><span></span>could not load library <span class="s2">&quot;</span><span class="nv">$libdir</span><span class="s2">/postgis_topology-2.2&quot;</span>:
ERROR:  could not access file <span class="s2">&quot;</span><span class="nv">$libdir</span><span class="s2">/postgis_topology-2.2&quot;</span>: No such file or directory
</pre></div>


<p><code>pg_upgrade</code> can&#8217;t run the upgrade because PostGIS versions don&#8217;t match. Install the PostGIS 2.3 for PostgreSQL 9.5 and update extensions in all your&nbsp;databases.</p>
<div class="highlight"><pre><span></span>apt install postgresql-9.5-postgis-2.3

:::sql
ALTER EXTENSION postgis UPDATE<span class="p">;</span>
</pre></div>


<p>With both clusters using the same PostGIS version, the upgrade can begin. First, stop them&nbsp;with</p>
<div class="highlight"><pre><span></span>service postgresql stop
</pre></div>


<p>Then, run the actual <code>pg_upgrade</code> command as <code>postgres</code> user. Make sure the <code>pg_hba.conf</code> file is set to allow local&nbsp;connections.</p>
<div class="highlight"><pre><span></span>/usr/lib/postgresql/9.6/bin/pg_upgrade <span class="se">\</span>
-b /usr/lib/postgresql/9.5/bin/ <span class="se">\</span>
-B /usr/lib/postgresql/9.6/bin/ <span class="se">\</span>
-d /var/lib/postgresql/9.5/main <span class="se">\</span>
-D /var/lib/postgresql/9.6/main <span class="se">\</span>
-o <span class="s1">&#39; -c config_file=/etc/postgresql/9.5/main/postgresql.conf&#39;</span> <span class="se">\</span>
-O <span class="s1">&#39; -c config_file=/etc/postgresql/9.6/main/postgresql.conf&#39;</span>
</pre></div>


<p>The following result means the upgrade was&nbsp;smooth.</p>
<div class="highlight"><pre><span></span>Performing Consistency Checks
-----------------------------
Checking cluster versions                                   ok
Checking database user is the install user                  ok
Checking database connection settings                       ok
Checking <span class="k">for</span> prepared transactions                          ok
Checking <span class="k">for</span> reg* system OID user data types                ok
Checking <span class="k">for</span> contrib/isn with bigint-passing mismatch       ok
Checking <span class="k">for</span> roles starting with <span class="s1">&#39;pg_&#39;</span>                      ok
Creating dump of global objects                             ok
Creating dump of database schemas
                                                            ok
Checking <span class="k">for</span> presence of required libraries                 ok
Checking database user is the install user                  ok
Checking <span class="k">for</span> prepared transactions                          ok

If pg_upgrade fails after this point, you must re-initdb the
new cluster before continuing.

Performing Upgrade
------------------
Analyzing all rows in the new cluster                       ok
Freezing all rows on the new cluster                        ok
Deleting files from new pg_clog                             ok
Copying old pg_clog to new server                           ok
Setting next transaction ID and epoch <span class="k">for</span> new cluster       ok
Deleting files from new pg_multixact/offsets                ok
Copying old pg_multixact/offsets to new server              ok
Deleting files from new pg_multixact/members                ok
Copying old pg_multixact/members to new server              ok
Setting next multixact ID and offset <span class="k">for</span> new cluster        ok
Resetting WAL archives                                      ok
Setting frozenxid and minmxid counters in new cluster       ok
Restoring global objects in the new cluster                 ok
Restoring database schemas in the new cluster
                                                            ok
Copying user relation files
                                                            ok
Setting next OID <span class="k">for</span> new cluster                            ok
Sync data directory to disk                                 ok
Creating script to analyze new cluster                      ok
Creating script to delete old cluster                       ok

Upgrade Complete
----------------
Optimizer statistics are not transferred by pg_upgrade so,
once you start the new server, consider running:
    ./analyze_new_cluster.sh

Running this script will delete the old cluster<span class="err">&#39;</span>s data files:
    ./delete_old_cluster.sh
</pre></div>


<p>The old cluster can be removed and the new one switched back to port <code>5432</code>. Run <code>/usr/lib/postgresql/9.6/bin/vacuumdb -p 5433 --all --analyze-in-stages</code> to collect&nbsp;statistics.</p>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/executing-dynamic-sql-query-right-away/" rel="bookmark" title="Permalink to Executing dynamic SQL query right away">Executing dynamic <span class="caps">SQL</span> query right&nbsp;away</a></h1>
    <aside><span>Feb 28, 2017</span>
    <span>    <a href="https://www.zimmi.cz/posts/tag/sql.html">sql</a>     <a href="https://www.zimmi.cz/posts/tag/postgresql.html">postgresql</a>    </span>
    <span><a href="https://www.zimmi.cz/posts/category/sql.html">SQL</a></span>
    </aside>
    <p>PostgreSQL 9.6 comes with a handy <code>psql</code> command called <code>\gexec</code> that <em>sends the current query input buffer to the server and treats the result as a <span class="caps">SQL</span> statement to be executed</em> (right, whatever). What that means is that instead of doing&nbsp;this</p>
<div class="highlight"><pre><span></span>psql -c <span class="s2">&quot;SELECT &#39;DROP TABLE &#39; || tablename FROM information_schema.tables WHERE table_name LIKE &#39;%to_be_dropped%&quot;</span> <span class="p">|</span> psql
</pre></div>


<p>you&#8217;ll do&nbsp;that</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="s1">&#39;DROP TABLE &#39;</span> <span class="o">||</span> <span class="n">tablename</span> <span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span> <span class="k">WHERE</span> <span class="k">table_name</span> <span class="k">LIKE</span> <span class="s1">&#39;%to_be_dropped%&#39;</span><span class="err">\</span><span class="n">gexec</span>
</pre></div>


<p>Brilliant.</p>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/subdivide-and-conquer-effective-spatial-indexes-in-postgis/" rel="bookmark" title="Permalink to Subdivide and Conquer: Effective Spatial Indexes in PostGIS">Subdivide and Conquer: Effective Spatial Indexes in&nbsp;PostGIS</a></h1>
    <aside><span>Jan 10, 2017</span>
    <span>    <a href="https://www.zimmi.cz/posts/tag/sql.html">sql</a>     <a href="https://www.zimmi.cz/posts/tag/postgresql.html">postgresql</a>     <a href="https://www.zimmi.cz/posts/tag/postgis.html">postgis</a>    </span>
    <span><a href="https://www.zimmi.cz/posts/category/sql.html">SQL</a></span>
    </aside>
    <p>Spatial indexes are absolutely crucial part of any spatial database and - as I tend to say quite often - only a fool would try to query spatial data without building spatial indexes&nbsp;beforehand.</p>
<p>Spatial indexes are based on bounding box comparisons, which are generally very fast. Yet, there are situations when spatial indexes don&#8217;t help much (or they don&#8217;t help as much as they could, if you&nbsp;wish).</p>
<div class="text-center"><img src="https://www.zimmi.cz/posts/assets/subdivide-and-conquer-effective-spatial-indexes-in-postgis/index.svg" /></div>

<p>Bounding box comparisons are effective with lots of small bounding boxes rather then few large ones. Why? See the picture above. The curved line (imagine it&#8217;s a pipeline for example) clearly demonstrates when the spatial index/bounding box comparison might fall short of what you&#8217;d&nbsp;expect.</p>
<p>Once the bounding box gets really big, it intersects so many other geometries&#8217; bounding boxes that the whole comparison starts to slow&nbsp;down.</p>
<p>Luckily, PostGIS 2.2 introduced a <a href="http://postgis.net/docs/ST_Subdivide.html">ST_Subdivide</a> function that can lend a helping hand in&nbsp;here.</p>
<p>Until today, we delivered the parcel geometries into our <a href="https://www.symap.cz">real estate acquisition process system</a> with the following query, that takes all the geometries from the <code>req_geom</code> table (pipelines, remember?) and intersects them with cadastral parcels. The second part of the query adds those parcels that haven&#8217;t been digitalized and were created manually by one of my&nbsp;workmates.</p>
<div class="highlight"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">requested_parcels</span> <span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">par_id</span><span class="p">)</span>
<span class="k">SELECT</span>
    <span class="n">reqs</span><span class="p">.</span><span class="n">uid</span><span class="p">,</span>
    <span class="n">b</span><span class="p">.</span><span class="n">id</span> <span class="n">par_id</span>
 <span class="k">FROM</span>
    <span class="n">running_requests</span> <span class="n">reqs</span>
 <span class="k">JOIN</span>
    <span class="n">req_geom</span> <span class="n">a</span> <span class="k">ON</span> <span class="p">(</span><span class="n">reqs</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">uid</span><span class="p">)</span>
 <span class="k">JOIN</span>
    <span class="n">pargeo</span> <span class="n">b</span> <span class="k">ON</span> <span class="p">(</span><span class="n">ST_Intersects</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span>
 <span class="k">UNION</span>
 <span class="k">SELECT</span>
    <span class="n">reqs</span><span class="p">.</span><span class="n">uid</span><span class="p">,</span>
    <span class="n">a</span><span class="p">.</span><span class="n">idpar</span><span class="p">::</span><span class="nb">numeric</span>
 <span class="k">FROM</span>
    <span class="n">running_requests</span> <span class="n">reqs</span>
 <span class="k">JOIN</span>
     <span class="n">req_man</span> <span class="n">a</span> <span class="k">ON</span> <span class="p">(</span><span class="n">reqs</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">uid</span><span class="p">);</span>
</pre></div>


<p>It&#8217;s a perfectly standard query that intersects several request geometries with ~20M parcels, nothing really fancy. Except that it takes 25 minutes to finish. Why? Pipelines,&nbsp;remember?</p>
<p>Yet, the query below takes only 30 seconds to finish (that&#8217;s a huge time saver considering that the whole process used to take ~40 minutes)! Why? Because the <code>ST_Subdivide</code> effectively shrinks the <code>req_geom</code> geometries until they have 50 vertices each at most. Such small geometries are perfect input for the bounding box comparison. Remember to call <code>DISTINCT</code> when using <code>ST_Subdivide</code>, you&#8217;d probably get duplicate parcel ids&nbsp;otherwise.</p>
<p>I also replaced the <code>UNION</code> with the <a href="https://www.zimmi.cz/posts/2015/postgresql-in-vs-exists/"><code>WHERE NOT EXISTS</code></a> expression, as it&#8217;s reasonable to assume that numeric ids comparison will be&nbsp;faster.</p>
<div class="highlight"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">requested_parcels</span> <span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">par_id</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="k">DISTINCT</span>
    <span class="n">reqs</span><span class="p">.</span><span class="n">uid</span><span class="p">,</span>
    <span class="n">b</span><span class="p">.</span><span class="n">id</span> <span class="n">par_id</span>
 <span class="k">FROM</span>
    <span class="n">running_requests</span> <span class="n">reqs</span>
 <span class="k">JOIN</span>
    <span class="p">(</span>
        <span class="k">SELECT</span>
            <span class="n">uid</span><span class="p">,</span>
            <span class="n">ST_Subdivide</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span> <span class="n">geom</span>
        <span class="k">FROM</span>
            <span class="n">req_geom</span>
     <span class="p">)</span> <span class="n">a</span> <span class="k">ON</span> <span class="p">(</span><span class="n">reqs</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">uid</span><span class="p">)</span>
 <span class="k">JOIN</span>
     <span class="n">pargeo</span> <span class="n">b</span> <span class="k">ON</span> <span class="p">(</span><span class="n">ST_Intersects</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">geom</span><span class="p">));</span>

 <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">requested_parcels</span> <span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">par_id</span><span class="p">)</span>
 <span class="k">SELECT</span>
     <span class="n">reqs</span><span class="p">.</span><span class="n">uid</span><span class="p">,</span>
     <span class="n">a</span><span class="p">.</span><span class="n">idpar</span><span class="p">::</span><span class="nb">numeric</span>
 <span class="k">FROM</span>
     <span class="n">running_requests</span> <span class="n">reqs</span>
 <span class="k">JOIN</span>
     <span class="n">req_man</span> <span class="n">a</span> <span class="k">ON</span> <span class="p">(</span><span class="n">reqs</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">uid</span><span class="p">)</span>
 <span class="k">WHERE</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="p">(</span>
     <span class="k">SELECT</span> <span class="mi">1</span>
     <span class="k">FROM</span> <span class="n">pozadovane_parcely</span> <span class="n">pp</span>
     <span class="k">WHERE</span> <span class="n">pp</span><span class="p">.</span><span class="n">par_id</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">idpar</span>
  <span class="p">);</span>
</pre></div>
</article>
<aside id="pagination">
            <a onclick="javascript:_paq.push(['trackEvent', 'Pagination', 'Next page']);" href="https://www.zimmi.cz/posts/tag/postgresql2.html">Next page &raquo;</a>
</aside>    </main>
    <footer>
        Written by <a href="//www.zimmi.cz">Michal Zimmermann</a>.
        Proudly powered by <a href="//getpelican.com/">Pelican</a>,
        which takes great advantage of <a href="//python.org">Python</a>.
    </footer>
<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-43432739-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments)};
  gtag('js', new Date());

  gtag('config', 'UA-43432739-2');
</script>
</body>
</html>