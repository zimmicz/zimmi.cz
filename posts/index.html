<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
        <title>Michal Zimmermann | Pieces of knowledge from the world of GIS.</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed" rel="stylesheet">
        <link href="https://www.zimmi.cz/posts/atom.xml" type="application/atom+xml" rel="alternate" title="Michal Zimmermann Full Atom Feed" />
        <link href="https://www.zimmi.cz/posts/feed.xml" type="application/rss+xml" rel="alternate" title="Michal Zimmermann Full RSS Feed" />
        <link rel="stylesheet" href="https://www.zimmi.cz/posts/theme/css/style.min.css?38b6b69e">
</head>
<body>
    <nav role="navigation">
        <ul>
            <li><a href="https://www.zimmi.cz/posts/categories">Categories</a></li>
            <li><a href="https://www.zimmi.cz/posts/tags">Tags</a></li>
            <li><a href="https://www.zimmi.cz/posts/feed.xml">Subscribe to RSS feed</a></li>
        </ul>
    </nav>
    <header>
        <h1><a href="/posts">Michal Zimmermann<small>Pieces of knowledge from the world of GIS.</small></a></h1>
    </header>
    <main>

<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/serving-mapbox-vector-tiles-with-postgis-nginx-and-python-backend/" rel="bookmark" title="Permalink to Serving Mapbox Vector Tiles with PostGIS, Nginx and PythonÂ Backend">Serving Mapbox Vector Tiles with PostGIS, Nginx and Python&nbsp;Backend</a></h1>
    <aside><span>Oct 23, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/postgis.html">postgis</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/python.html">python</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/sql.html">SQL</a></span>
    </aside>
    <p><a href="({filename}../2017/postgis-as-a-mapbox-vector-tiles-generator.md)">Since version 2.4.0, PostGIS can serve <span class="caps">MVT</span></a> data directly. <span class="caps">MVT</span> returning queries put heavy workload on the database though. On top of that, each of the query has to be run again every time a client demands the data. This leaves us with plenty of room to optimize the&nbsp;process.</p>
<div class="text-center"><img data-echo="/posts/assets/serving-mapbox-vector-tiles-with-postgis-nginx-and-python-backend/election.gif"/></div>

<p>During the last week, while working on the Czech parlamental election data visualization, I&#8217;ve struggled with the server becoming unresponsive far too often due to the issues mentioned&nbsp;above.</p>
<div class="text-center"><img data-echo="/posts/assets/serving-mapbox-vector-tiles-with-postgis-nginx-and-python-backend/schema.png"/></div>

<p>According to the schema, the first client to come to the&nbsp;server:</p>
<ul>
<li>goes through filesystem unstopped, because there are no cached files&nbsp;yet,</li>
<li>continues to the Flask backend and asks for a file at <code>{z}/{x}/{y}</code>,</li>
<li>Flask backend asks the database to return the <span class="caps">MVT</span> for the given&nbsp;tile,</li>
<li>Flask backend writes the response to the filesystem and sends it to the&nbsp;client.</li>
</ul>
<p>Other clients get tiles directly from the filesystem, leaving the database at&nbsp;ease.</p>
<h2>Nginx</h2>
<p>Nginx is fairly simple to set up, once you know what you&#8217;re doing. The <code>/volby-2017/municipality/</code> location serves static <span class="caps">MVT</span> from the given alias directory. If not found, the request is passed to <code>@postgis</code> location, that asks the Flask backend for the&nbsp;response.</p>
<div class="highlight"><pre><span></span>server election <span class="o">{</span>
    location /volby-2017/municipality <span class="o">{</span>
            <span class="nb">alias</span> /opt/volby-cz-2017/server/cache/<span class="p">;</span>
            try_files <span class="nv">$uri</span> @postgis<span class="p">;</span>
    <span class="o">}</span>

    location @postgis <span class="o">{</span>
            include uwsgi_params<span class="p">;</span>
            uwsgi_pass <span class="m">127</span>.0.0.1:5000<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2>Flask&nbsp;backend</h2>
<script src="https://gist.github.com/zimmicz/46485676e1cf3d6566f0aaa7f93f055b.js"></script>

<h2>Generating static <span class="caps">MVT</span> in&nbsp;advance</h2>
<p>If you&#8217;re going to serve static tiles that don&#8217;t change often, it might be a good idea to use PostGIS to create files in advance and serve them with&nbsp;Nginx.</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">tiles</span> <span class="p">(</span>
    <span class="n">x</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">y</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">z</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">west</span> <span class="nb">numeric</span><span class="p">,</span>
    <span class="n">south</span> <span class="nb">numeric</span><span class="p">,</span>
    <span class="n">east</span> <span class="nb">numeric</span><span class="p">,</span>
    <span class="n">north</span> <span class="nb">numeric</span><span class="p">,</span>
    <span class="n">geom</span> <span class="n">geometry</span><span class="p">(</span><span class="n">POLYGON</span><span class="p">,</span> <span class="mi">3857</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>


<p>Using <a href="https://github.com/mapbox/mercantile">mercantile</a>, you can create the <code>tiles</code> table holding the bounding boxes of the tiles you need. PostGIS them inserts the actual <span class="caps">MVT</span> into the <code>mvt</code> table.</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TEMPORARY</span> <span class="k">TABLE</span> <span class="n">tmp_tiles</span> <span class="k">AS</span>
    <span class="k">SELECT</span>
        <span class="n">muni</span><span class="p">.</span><span class="n">muni_id</span><span class="p">,</span>
        <span class="n">prc</span><span class="p">.</span><span class="k">data</span><span class="p">,</span>
        <span class="n">ST_AsMVTGeom</span><span class="p">(</span>
            <span class="n">muni</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span>
            <span class="n">TileBBox</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span> <span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">3857</span><span class="p">),</span>
            <span class="mi">4096</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="k">false</span>
        <span class="p">)</span> <span class="n">geom</span><span class="p">,</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">y</span><span class="p">,</span>
        <span class="n">z</span>
    <span class="k">FROM</span> <span class="n">muni</span>
    <span class="k">JOIN</span> <span class="p">(</span>
        <span class="k">SELECT</span>
            <span class="n">x</span><span class="p">,</span>
            <span class="n">y</span><span class="p">,</span>
            <span class="n">z</span><span class="p">,</span>
            <span class="n">geom</span>
        <span class="k">FROM</span> <span class="n">tiles</span>
    <span class="p">)</span> <span class="n">bbox</span> <span class="k">ON</span> <span class="p">(</span><span class="n">ST_Intersects</span><span class="p">(</span><span class="n">muni</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">bbox</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span>
    <span class="k">JOIN</span> <span class="n">party_results_cur</span> <span class="n">prc</span> <span class="k">ON</span> <span class="p">(</span><span class="n">muni</span><span class="p">.</span><span class="n">muni_id</span> <span class="o">=</span> <span class="n">prc</span><span class="p">.</span><span class="n">muni_id</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">mvt</span> <span class="p">(</span><span class="n">mvt</span> <span class="n">bytea</span><span class="p">,</span> <span class="n">x</span> <span class="nb">integer</span><span class="p">,</span> <span class="n">y</span> <span class="nb">integer</span><span class="p">,</span> <span class="n">z</span> <span class="nb">integer</span><span class="p">);</span>
<span class="k">DO</span>
<span class="err">$$</span>
<span class="k">DECLARE</span> <span class="n">r</span> <span class="n">record</span><span class="p">;</span>
<span class="k">BEGIN</span>
<span class="k">FOR</span> <span class="n">r</span> <span class="k">in</span> <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="k">FROM</span> <span class="n">tmp_tiles</span> <span class="n">LOOP</span>
    <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">mvt</span>
    <span class="k">SELECT</span> <span class="n">ST_AsMVT</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="s1">&#39;municipality&#39;</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="s1">&#39;geom&#39;</span><span class="p">),</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">z</span>
    <span class="k">FROM</span> <span class="p">(</span>
        <span class="k">SELECT</span>
            <span class="n">muni_id</span><span class="p">,</span>
            <span class="k">data</span><span class="p">,</span>
            <span class="n">geom</span>
        <span class="k">FROM</span> <span class="n">tmp_tiles</span>
        <span class="k">WHERE</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="p">)</span> <span class="n">q</span><span class="p">;</span>
    <span class="n">RAISE</span> <span class="n">INFO</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
<span class="k">END</span> <span class="n">LOOP</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$$</span><span class="p">;</span>
</pre></div>


<p>Once filled, the table rows can be written to the filesystem with the simple piece of Python&nbsp;code.</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">text</span>

<span class="n">CACHE_PATH</span><span class="o">=</span><span class="s2">&quot;cache/&quot;</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;postgresql:///&#39;</span><span class="p">)</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="n">sql</span><span class="o">=</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT mvt, x, y, z FROM mvt&quot;</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="n">cachefile</span> <span class="o">=</span> <span class="s2">&quot;{}/{}/{}/{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CACHE_PATH</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">print</span><span class="p">(</span><span class="n">cachefile</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;{}/{}/{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CACHE_PATH</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;{}/{}/{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CACHE_PATH</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cachefile</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>


<h2>Conclusion</h2>
<p>PostGIS is a brilliant tool for generating Mapbox vector tiles. Combined with Python powered static file generator and Nginx, it seems to become the only tool needed to get you&nbsp;going.</p>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/postgresql-dollar-quoting-inside-bash-heredoc/" rel="bookmark" title="Permalink to PostgreSQL Dollar Quoting inside BashÂ Heredoc">PostgreSQL Dollar Quoting inside Bash&nbsp;Heredoc</a></h1>
    <aside><span>Sep 22, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/sql.html">sql</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/postgresql.html">postgresql</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/bash.html">bash</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/sql.html">SQL</a></span>
    </aside>
    <p>Yesterday I spent two very unpleasant hours debugging the weirdest <span class="caps">SQL</span> error I&#8217;ve seen in my life, running the below query (simplified for this&nbsp;post).</p>
<div class="highlight"><pre><span></span><span class="n">psql</span> <span class="o">-</span><span class="n">qAt</span> <span class="c1">--no-psqlrc &lt;&lt;BACKUP</span>
<span class="k">DO</span>
<span class="err">$$</span>
<span class="k">DECLARE</span> <span class="n">r</span> <span class="n">record</span><span class="p">;</span>
<span class="k">BEGIN</span>
  <span class="n">RAISE</span> <span class="n">INFO</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">;</span>
<span class="k">END</span>
<span class="err">$$</span><span class="p">;</span>
<span class="n">BACKUP</span>
</pre></div>


<p>Running this in your terminal will result in a nasty syntax&nbsp;error.</p>
<div class="highlight"><pre><span></span>ERROR:  syntax error at or near <span class="s2">&quot;1111&quot;</span>
LINE <span class="m">2</span>: <span class="m">1111</span>
        ^
ERROR:  syntax error at or near <span class="s2">&quot;RAISE&quot;</span>
LINE <span class="m">2</span>:   RAISE INFO <span class="s1">&#39;%&#39;</span>, <span class="s1">&#39;info&#39;</span><span class="p">;</span>
          ^
ERROR:  syntax error at or near <span class="s2">&quot;1111&quot;</span>
LINE <span class="m">2</span>: <span class="m">1111</span><span class="p">;</span>
</pre></div>


<p>You stare on the screen for a while, absolutely sure that number <code>1111</code> is nowhere close to the data you work with. You try again. Another error. You save the code into a file and try again. It works. What the <em>heck</em>? You try again using the bash heredoc. Another&nbsp;failure.</p>
<p>The minute you realize <code>$$</code> is being substituted with the <span class="caps">ID</span> of the current process, you feel like the dumbest person on Earth. Yet the happiest one at the same&nbsp;time.</p>
<p>The solution is&nbsp;trivial.</p>
<div class="highlight"><pre><span></span><span class="n">psql</span> <span class="o">-</span><span class="n">qAt</span> <span class="c1">--no-psqlrc &lt;&lt;BACKUP</span>
<span class="k">DO</span>
<span class="err">\$\$</span>
<span class="k">DECLARE</span> <span class="n">r</span> <span class="n">record</span><span class="p">;</span>
<span class="k">BEGIN</span>
  <span class="n">RAISE</span> <span class="n">INFO</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">;</span>
<span class="k">END</span>
<span class="err">\$\$</span><span class="p">;</span>
<span class="n">BACKUP</span>
</pre></div>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/postgresql-development-history-revealed-with-postgresql/" rel="bookmark" title="Permalink to PostgreSQL Development History Revealed withÂ PostgreSQL">PostgreSQL Development History Revealed with&nbsp;PostgreSQL</a></h1>
    <aside><span>Aug 9, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/postgresql.html">postgresql</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/python.html">python</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/sql.html">SQL</a></span>
    </aside>
    <p>I spend a lot of time reading <a href="https://www.postgresql.org/docs/manuals/">PostgreSQL docs</a>. It occurred to me just a few weeks ago that those versioned manuals are great opportunity to get an insight into PostgreSQL development history. Using PostgreSQL, of&nbsp;course.</p>
<h2><span class="caps">TOP</span> 5 functions with the most verbose docs in each&nbsp;version</h2>
<div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="k">version</span><span class="p">,</span>
    <span class="n">string_agg</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39; | &#39;</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">letter_count</span> <span class="k">DESC</span><span class="p">)</span>
<span class="k">FROM</span> <span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="k">version</span><span class="p">,</span>
        <span class="n">func</span><span class="p">,</span>
        <span class="n">letter_count</span><span class="p">,</span>
        <span class="n">row_number</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="k">version</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">letter_count</span> <span class="k">DESC</span><span class="p">)</span>
    <span class="k">FROM</span> <span class="n">postgresql_development</span><span class="p">.</span><span class="k">data</span>
<span class="p">)</span> <span class="n">a</span>
<span class="k">WHERE</span> <span class="n">row_number</span> <span class="o">&lt;=</span> <span class="mi">10</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">version</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">version</span> <span class="k">DESC</span>
</pre></div>


<p>Seems like a huge comeback for <code>CREATE TABLE</code>.</p>
<table>
<thead>
<tr>
<th><span class="caps">VERSION</span></th>
<th>1st</th>
<th>2nd</th>
<th>3rd</th>
<th>4th</th>
<th>5th</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.0</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>9.6</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>9.5</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>9.4</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>9.3</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">DEFAULT</span> <span class="caps">PRIVILEGES</span></td>
</tr>
<tr>
<td>9.2</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">DEFAULT</span> <span class="caps">PRIVILEGES</span></td>
</tr>
<tr>
<td>9.1</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">DEFAULT</span> <span class="caps">PRIVILEGES</span></td>
</tr>
<tr>
<td>9.0</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">DEFAULT</span> <span class="caps">PRIVILEGES</span></td>
</tr>
<tr>
<td>8.4</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>8.3</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">COMMENT</span></td>
</tr>
<tr>
<td>8.2</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>8.1</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>8</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
</tr>
<tr>
<td>7.4</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>7.3</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
</tr>
<tr>
<td>7.2</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span> <span class="caps">INTO</span></td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TYPE</span></td>
</tr>
<tr>
<td>7.1</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span> <span class="caps">INTO</span></td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TYPE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
</tr>
<tr>
<td>7.0</td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">SELECT</span> <span class="caps">INTO</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TYPE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">COMMENT</span></td>
</tr>
</tbody>
</table>
<h2>Number of functions available in each&nbsp;version</h2>
<div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="k">version</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="n">func</span><span class="p">),</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">letter_count</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">postgresql_development</span><span class="p">.</span><span class="k">data</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">version</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">version</span><span class="p">;</span>
</pre></div>


<div class="text-center"><img data-echo="/posts/assets/postgresql-development-history-revealed-with-postgresql/plot1.png"/></div>

<h2>The most verbose docs in each&nbsp;version</h2>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">ON</span> <span class="p">(</span><span class="k">version</span><span class="p">)</span>
    <span class="k">version</span><span class="p">,</span>
    <span class="n">func</span><span class="p">,</span>
    <span class="n">letter_count</span>
<span class="k">FROM</span> <span class="n">postgresql_development</span><span class="p">.</span><span class="k">data</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">version</span><span class="p">,</span> <span class="n">letter_count</span> <span class="k">DESC</span><span class="p">;</span>
</pre></div>


<p>Poor <code>REVOKE</code>, the defeated&nbsp;champion.</p>
<div class="text-center">
    <table style="margin-left:auto; margin-right: auto">
    <thead>
    <tr>
    <th><span class="caps"><span class="caps">VERSION</span></span></th>
    <th><span class="caps"><span class="caps">FUNCTION</span></span></th>
    <th><span class="caps"><span class="caps">LETTER</span></span> <span class="caps"><span class="caps">COUNT</span></span></th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td>10</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>3142</td>
    </tr>
    <tr>
    <td>9.6</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.5</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.4</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.3</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.2</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.1</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2508</td>
    </tr>
    <tr>
    <td>9</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2502</td>
    </tr>
    <tr>
    <td>8.4</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2105</td>
    </tr>
    <tr>
    <td>8.3</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>1485</td>
    </tr>
    <tr>
    <td>8.2</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>1527</td>
    </tr>
    <tr>
    <td>8.1</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>1312</td>
    </tr>
    <tr>
    <td>8</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>1251</td>
    </tr>
    <tr>
    <td>7.4</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>1075</td>
    </tr>
    <tr>
    <td>7.3</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>929</td>
    </tr>
    <tr>
    <td>7.2</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>929</td>
    </tr>
    <tr>
    <td>7.1</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>871</td>
    </tr>
    <tr>
    <td>7</td>
    <td><span class="caps"><span class="caps">SELECT</span></span></td>
    <td>450</td>
    </tr>
    </tbody>
    </table>
</div>

<h2><span class="caps">CREATE</span> <span class="caps">TABLE</span> docs&nbsp;evolution</h2>
<div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="k">version</span><span class="p">,</span>
    <span class="n">letter_count</span>
<span class="k">FROM</span> <span class="n">postgresql_development</span><span class="p">.</span><span class="k">data</span>
<span class="k">WHERE</span> <span class="n">func</span> <span class="o">=</span> <span class="s1">&#39;CREATE TABLE&#39;</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">func</span><span class="p">,</span> <span class="k">version</span><span class="p">;</span>
</pre></div>


<p>Something&#8217;s going on in an upcoming 10.0&nbsp;version.</p>
<div class="text-center"><img data-echo="/posts/assets/postgresql-development-history-revealed-with-postgresql/plot2.png"/></div>

<p>All the data was obtained with the following Python script and processed inside the PostgreSQL database. Plots done with <a href="http://bokeh.pydata.org/en/latest/">Bokeh</a>, though I probably wouldn&#8217;t use it again, the docs site is absurdly sluggish and the info is just all over the&nbsp;place.</p>
<script src="https://gist.github.com/zimmicz/f69a5ce5d3cf3a220e171553c35e0391.js"></script>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/postgis-as-a-mapbox-vector-tiles-generator/" rel="bookmark" title="Permalink to PostGIS as a Mapbox Vector TilesÂ generator">PostGIS as a Mapbox Vector Tiles&nbsp;generator</a></h1>
    <aside><span>Aug 6, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/docker.html">docker</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/postgis.html">postgis</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/javascript.html">javascript</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/sql.html">SQL</a></span>
    </aside>
    <p><a href="http://postgis.net/2017/08/05/postgis-2.4.0alpha/">PostGIS 2.4.0</a> was released recently bringing the possibilities to generate <strong>Mapbox Vector Tiles</strong> without any third party tools. I got a shot at it with Node.js and docker. Even if it&#8217;s not as straightforward as solely using <a href="https://postgis.net/docs/manual-dev/ST_AsMVT.html">ST_AsMVT</a>, it still looks pretty&nbsp;great.</p>
<h2>Docker&nbsp;container</h2>
<p>There are no Ubuntu or Debian based PostGIS 2.4.0 packages as far as I know. As installation from source (especially considering <span class="caps">GIS</span> software) is always a bit risky, I prefer using Docker to stay away from trouble. The image is based on Ubuntu 17.04, has PostgreSQL 9.6 and PostGIS 2.4.0 installed. It exposes port 5432 to the host, so you can access the database from the outside the&nbsp;container.</p>
<div class="highlight"><pre><span></span>FROM ubuntu:17.04
RUN apt update
RUN apt install -y wget less systemd
RUN touch /etc/apt/sources.list.d/pgdg.list
RUN <span class="nb">echo</span> <span class="s2">&quot;deb http://apt.postgresql.org/pub/repos/apt/ zesty-pgdg main&quot;</span> &gt; /etc/apt/sources.list.d/pgdg.list
RUN wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc <span class="p">|</span> apt-key add -
RUN apt update
RUN apt -y install postgresql-9.6 postgresql-server-dev-9.6

USER postgres
RUN /usr/lib/postgresql/9.6/bin/pg_ctl -D /var/lib/postgresql/9.6/main -l /tmp/logfile start

USER root
RUN <span class="nb">echo</span> <span class="s2">&quot;host all  all    0.0.0.0/0  trust&quot;</span> &gt;&gt; /etc/postgresql/9.6/main/pg_hba.conf <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> <span class="s2">&quot;listen_addresses=&#39;*&#39;&quot;</span> &gt;&gt; /etc/postgresql/9.6/main/postgresql.conf


EXPOSE <span class="m">5432</span>
RUN apt install -y netcat build-essential libxml2 libxml2-dev libgeos-3.5.1 libgdal-dev gdal-bin libgdal20 libgeos-dev libprotobuf-c1 libprotobuf-c-dev libprotobuf-dev protobuf-compiler protobuf-c-compiler
RUN wget http://download.osgeo.org/postgis/source/postgis-2.4.0alpha.tar.gz
RUN tar -xvzf postgis-2.4.0alpha.tar.gz
RUN <span class="nb">cd</span> postgis-2.4.0alpha <span class="o">&amp;&amp;</span> ./configure <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make install

USER postgres
RUN service postgresql start <span class="o">&amp;&amp;</span> psql -c <span class="s2">&quot;CREATE EXTENSION postgis&quot;</span>

USER root
COPY start.postgis.sh /start.postgis.sh
RUN chmod <span class="m">0755</span> /start.postgis.sh

CMD <span class="o">[</span><span class="s2">&quot;/start.postgis.sh&quot;</span><span class="o">]</span>
</pre></div>


<p><code>start.postgis.sh</code> file starts the database server and keeps it running&nbsp;forever.</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nv">DATADIR</span><span class="o">=</span><span class="s2">&quot;/var/lib/postgresql/9.6/main&quot;</span>
<span class="nv">CONF</span><span class="o">=</span><span class="s2">&quot;/etc/postgresql/9.6/main/postgresql.conf&quot;</span>
<span class="nv">POSTGRES</span><span class="o">=</span><span class="s2">&quot;/usr/lib/postgresql/9.6/bin/postgres&quot;</span>

su postgres sh -c <span class="s2">&quot;</span><span class="nv">$POSTGRES</span><span class="s2"> -D </span><span class="nv">$DATADIR</span><span class="s2"> -c config_file=</span><span class="nv">$CONF</span><span class="s2">&quot;</span> <span class="p">&amp;</span>
<span class="k">until</span> nc -z localhost <span class="m">5432</span><span class="p">;</span>
<span class="k">do</span>
    <span class="nb">echo</span> ...
    sleep <span class="m">5</span>
<span class="k">done</span>
sleep <span class="m">5</span> <span class="c1"># just for sure</span>
su - postgres -c <span class="s2">&quot;psql -c \&quot;CREATE EXTENSION IF NOT EXISTS postgis\&quot;&quot;</span>
<span class="nb">echo</span> database up and running

<span class="nb">wait</span> <span class="nv">$!</span>
</pre></div>


<h2>Data</h2>
<p>I got a cadastre area dataset of the Czech Republic for testing, which contains ~ 13,000 polygons. The geometries should come in Web Mercator a.k.a. <span class="caps">EPSG</span>:3857 to work with <a href="https://www.mapbox.com/vector-tiles/specification/"><span class="caps">MVT</span></a>.</p>
<h2>Vector&nbsp;tiles</h2>
<p>I got a bit confused by the docs of <a href="https://postgis.net/docs/manual-dev/ST_AsMVT.html">ST_AsMVT</a> and <a href="https://postgis.net/docs/manual-dev/ST_AsMVTGeom.html">ST_AsMVTGeom</a>. Especially the latter one took me a few hours to get it right. What is essential (I guess) about Mapbox Vector Tiles is that you have to abstract from the real world coordinates and start thinking inside the tile coordinates. What PostGIS does with <code>ST_AsMVTGeom</code> (and what any other <span class="caps">MVT</span> implemenation should do for you) is that it takes real world coordinates and put them inside a&nbsp;tile.</p>
<div class="text-center"><img data-echo="/posts/assets/postgis-as-a-mapbox-vector-tiles-generator/mvt.gif"/></div>

<p>To make this work, you need to know every bounding box of every tile on every zoom level in a Web Mercator projection. Or you can use <a href="https://github.com/mapbox/postgis-vt-util/blob/master/src/TileBBox.sql">TileBBox procedure by Mapbox</a>, if you&nbsp;wish.</p>
<p>The <span class="caps">SQL</span> query itself is pretty simple (this comes from an express route I&#8217;ll be discussing&nbsp;shortly).</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_AsMVT</span><span class="p">(</span><span class="s1">&#39;cadastre&#39;</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="s1">&#39;geom&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
<span class="k">FROM</span> <span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">code</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">ST_AsMVTGeom</span><span class="p">(</span>
            <span class="n">geom</span><span class="p">,</span>
            <span class="n">TileBBox</span><span class="p">(</span><span class="err">${</span><span class="n">req</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">z</span><span class="err">}</span><span class="p">,</span> <span class="err">${</span><span class="n">req</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">x</span><span class="err">}</span><span class="p">,</span> <span class="err">${</span><span class="n">req</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">y</span><span class="err">}</span><span class="p">,</span> <span class="mi">3857</span><span class="p">),</span>
            <span class="mi">4096</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="k">false</span>
        <span class="p">)</span> <span class="n">geom</span>
    <span class="k">FROM</span> <span class="n">cadastre_area</span>
    <span class="k">WHERE</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">ST_Transform</span><span class="p">(</span><span class="n">ST_MakeEnvelope</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">5</span><span class="p">),</span> <span class="mi">3857</span><span class="p">)))</span>
<span class="p">)</span> <span class="n">q</span>
</pre></div>


<p>When filled with proper arguments instead of placeholders, it returns a&nbsp;bytea.</p>
<div class="highlight"><pre><span></span><span class="se">\x</span>1aa5dbd0070a047465737412e216120400000101180322d7160987913f8db38e01aa59160e2a010412012a0624060e001410420a1a00203b0a3914190e15085912010a0f0c0f06370804080a0e0e0234090e0
</pre></div>


<p>This can be consumed by a Leaflet map using <a href="https://github.com/Leaflet/Leaflet.VectorGrid">Leaflet.VectorGrid plugin</a>. To keep it short, the frontend code actually boils down to three lines of&nbsp;code.</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:3000/mvt/{x}/{y}/{z}&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">cadastre</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">vectorGrid</span><span class="p">.</span><span class="nx">protobuf</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">cadastre</span><span class="p">);</span>
</pre></div>


<p>The <a href="https://gist.github.com/zimmicz/9e78d9888ab73abc7e87553b77999bc8">server <span class="caps">MVP</span> is available</a> as a GitHub&nbsp;gist.</p>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/fighting-raster-geopackage-with-gdal/" rel="bookmark" title="Permalink to Fighting Raster GeoPackage with GDAL">Fighting Raster GeoPackage with <span class="caps">GDAL</span></a></h1>
    <aside><span>Jul 19, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/bash.html">bash</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/gdal.html">gdal</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/gis.html">GIS</a></span>
    </aside>
    <p>As I&#8217;m still running Ubuntu 16.04 based Linux Mint, I have no access to <span class="caps">GDAL</span> 2.x repositories (except for ubuntugis, that I really don&#8217;t like to use). Provided with a GeoPackage raster file recently, I had to find a way to load it into <span class="caps">QGIS</span>, somehow. The solution is simple: Docker with&nbsp;gdal_translate.</p>
<h2>Preparing the Docker&nbsp;container</h2>
<p>I like using Docker for experiments that might leave the <span class="caps">OS</span> in an <em>unexpected</em> state (which is exactly what happens to me with ubuntugis repository whenever I use it. That&#8217;s why I don&#8217;t anymore.). A very simple Dockerfile keeps the troubles away from&nbsp;you.</p>
<div class="highlight"><pre><span></span>FROM ubuntu:17.04
RUN apt update
RUN apt install -y gdal-bin
</pre></div>


<p><code>cd</code> into the folder and build the image with <code>docker build -t gdal .</code>. Once ready, summon the daemon, run the container, mount the GeoPackage file to the container directory and you&#8217;re ready to&nbsp;rock.</p>
<div class="highlight"><pre><span></span>docker run -v /path/to/geopackage:/home/ -it gdal
</pre></div>


<h2>Raster GeoPackage to GeoTiff&nbsp;translation</h2>
<p>With the container running, the raster GeoPackage to GeoTiff translation can be done easily with <code>gdal_translate</code>. Note I chose to cut the source file into tiles, because the gdal_translate was choking about the resulting&nbsp;size.</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="nv">SIZE</span><span class="o">=</span><span class="m">10000</span>
<span class="nv">ULX</span><span class="o">=</span>-630000
<span class="nv">ULY</span><span class="o">=</span>-1135450
<span class="nv">LRX</span><span class="o">=</span>-560000
<span class="nv">LRY</span><span class="o">=</span>-1172479
<span class="nv">COUNTER_X</span><span class="o">=</span><span class="m">0</span>
<span class="nv">COUNTER_Y</span><span class="o">=</span><span class="m">0</span>

<span class="k">while</span> <span class="o">[[</span> <span class="nv">$ULX</span> -lt <span class="nv">$LRX</span> <span class="o">]]</span>
<span class="k">do</span>
    <span class="k">while</span> <span class="o">[[</span> <span class="nv">$ULY</span> -gt <span class="nv">$LRY</span> <span class="o">]]</span>
    <span class="k">do</span>
        <span class="nb">echo</span> <span class="nv">$ULX</span>, <span class="k">$((</span><span class="nv">$ULX</span><span class="o">+</span><span class="nv">$SIZE</span><span class="k">))</span>, <span class="nv">$ULY</span>, <span class="k">$((</span><span class="nv">$ULY</span><span class="o">-</span><span class="nv">$SIZE</span><span class="k">))</span>

        gdal_translate <span class="se">\</span>
            -co <span class="nv">TILED</span><span class="o">=</span>YES <span class="se">\</span>
            -co <span class="nv">COMPRESS</span><span class="o">=</span>DEFLATE <span class="se">\</span>
            -co <span class="nv">TFW</span><span class="o">=</span>YES <span class="se">\</span>
            -co <span class="nv">NUM_THREADS</span><span class="o">=</span>ALL_CPUS <span class="se">\</span>
            -a_nodata <span class="m">0</span> <span class="se">\</span>
            -of GTiff <span class="se">\</span>
            -projwin <span class="nv">$ULX</span>, <span class="nv">$ULY</span>, <span class="k">$((</span><span class="nv">$ULX</span><span class="o">+</span><span class="nv">$SIZE</span><span class="k">))</span>, <span class="k">$((</span><span class="nv">$ULY</span><span class="o">-</span><span class="nv">$SIZE</span><span class="k">))</span> <span class="se">\</span>
            -projwin_srs EPSG:5514 <span class="se">\</span>
            data/detected.gpkg data/detected_<span class="si">${</span><span class="nv">COUNTER_X</span><span class="si">}</span>_<span class="si">${</span><span class="nv">COUNTER_Y</span><span class="si">}</span>.tiff

        <span class="nv">ULY</span><span class="o">=</span><span class="k">$((</span><span class="nv">$ULY</span><span class="o">-</span><span class="nv">$SIZE</span><span class="k">))</span>
        <span class="nv">COUNTER_Y</span><span class="o">=</span><span class="k">$((</span>COUNTER_Y+1<span class="k">))</span>
    <span class="k">done</span>
    <span class="nv">ULX</span><span class="o">=</span><span class="k">$((</span><span class="nv">$ULX</span><span class="o">+</span><span class="nv">$SIZE</span><span class="k">))</span>
    <span class="nv">ULY</span><span class="o">=</span>-1135450
    <span class="nv">COUNTER_X</span><span class="o">=</span><span class="k">$((</span>COUNTER_X+1<span class="k">))</span>
<span class="k">done</span>
</pre></div>


<h2>Final Touch: Raster to&nbsp;Vector</h2>
<p>After the GeoTiff is written to hard drive, <a href="https://www.zimmi.cz/posts/2015/how-to-use-queue-with-rsync/">inotifywait</a> can be used to generate overviews. And with ease of calling <code>gdal_polygonize.py</code> on each of GeoTiffs&hellip;vector layer, at you&nbsp;service.</p>
</article>
<aside id="pagination">
            <a href="https://www.zimmi.cz/posts/index2.html">Next page &raquo;</a>
</aside>    </main>
    <footer>
        Written by <a href="//www.zimmi.cz">Michal Zimmermann</a>.
        Proudly powered by <a href="//getpelican.com/">Pelican</a>,
        which takes great advantage of <a href="//python.org">Python</a>.
    </footer>
<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-43432739-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments)};
  gtag('js', new Date());

  gtag('config', 'UA-43432739-2');
</script>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NW8R37N');</script>
<!-- End Google Tag Manager -->
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NW8R37N"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<script src="https://www.zimmi.cz/posts/theme/js/echo.min.js"></script>
<script>
echo.init({
  offset: 200,
  throttle: 250,
  unload: false
});
</script>
</body>
</html>