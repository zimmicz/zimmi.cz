<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
        <title>Michal Zimmermann | category: SQL</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed" rel="stylesheet">
        <link href="https://www.zimmi.cz/posts/atom.xml" type="application/atom+xml" rel="alternate" title="Michal Zimmermann Full Atom Feed" />
        <link href="https://www.zimmi.cz/posts/feed.xml" type="application/rss+xml" rel="alternate" title="Michal Zimmermann Full RSS Feed" />
        <link rel="stylesheet" href="https://www.zimmi.cz/posts/theme/css/style.min.css?a4089d0f">
</head>
<body>
    <nav role="navigation">
        <ul>
            <li><a href="https://www.zimmi.cz/posts/categories">Categories</a></li>
            <li><a href="https://www.zimmi.cz/posts/tags">Tags</a></li>
            <li><a href="https://www.zimmi.cz/posts/feed.xml">Subscribe to RSS feed</a></li>
        </ul>
    </nav>
    <header>
        <h1><a href="/posts">Michal Zimmermann<small>Pieces of knowledge from the world of GIS.</small></a></h1>
    </header>
    <main>
<h2 class="text-center">Articles in the SQL category</h2>

<article>
    <h1><a href="https://www.zimmi.cz/posts/2018/postgresql-backup-and-recovery-orchestration-recovery/" rel="bookmark" title="Permalink to PostgreSQL Backup and Recovery Orchestration: Recovery">PostgreSQL Backup and Recovery Orchestration:&nbsp;Recovery</a></h1>
    <aside><span>Feb 16, 2018</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/postgresql.html">postgresql</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/linux.html">linux</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/sql.html">SQL</a></span>
    </aside>
    <p>PostgreSQL continuous backups are very powerful, if you know how to use them for recovery. There&#8217;s nothing else to do to be sure about that other than <strong>actually trying it</strong>. Personally, I see recovery as a single process with two possibly different&nbsp;outcomes:</p>
<ul>
<li>you&#8217;re recovering to the same state your cluster is/was in (because of a hardware failure, provider switch, &hellip;) - it&#8217;s more of a data migration, but you need your backup&nbsp;anyway</li>
<li>you&#8217;re doing a point-in-time-recovery (someone dropped the wrong table, data got corrupted,&nbsp;&hellip;)</li>
</ul>
<p>Both scenarios follow the same steps and differ slighty at the&nbsp;end.</p>
<ol>
<li>Stop the PostgreSQL&nbsp;cluster.</li>
<li>Copy the current <code>PGDATA_DIR</code> somewhere safe, just in case you screw&nbsp;up.</li>
<li>Replace the <code>PGDATA_DIR</code> with the full backup. If you start the cluster right away, it will boot to the last full backup state (in my case, missing a week of <span class="caps">WAL</span> segments&nbsp;tops).</li>
</ol>
<h2>General&nbsp;recovery</h2>
<p>In this case, you&#8217;re trying to recover as far as possible. With previous steps done succesfully, the next&nbsp;follow:</p>
<ul>
<li>Copy all archived <span class="caps">WAL</span> segments created after the last full backup to <code>PGDATA_DIR/pg_xlog</code>. These can be found with <code>find -newer</code> command run against the corresponding <code>.backup</code> file in your <code>wal-archive/u/p</code> directory.</li>
<li>If your full backup strategy includes <code>recovery.conf</code> file creation, you cane safely move it or remove&nbsp;it.</li>
<li>Start the database cluster again. It is going to boot to the last working&nbsp;state.</li>
</ul>
<p>If you&#8217;re about to migrate your data, you might be better off with simple <code>pg_dump</code>, <code>pg_dumpall</code> and <code>pg_restore</code> commands rather than using full backup/<span class="caps">WAL</span> segments&nbsp;combination.</p>
<h2>Point-in-time-recovery</h2>
<p>PostgreSQL&#8217;s <span class="caps">PITR</span> can help you restore your accidentally deleted/corrupted data. After the first three steps mentioned above, you should follow with&nbsp;these:</p>
<ul>
<li>Copy all archived segments created after the last full backup somewhere the PostgreSQL user can read them (<code>/your-wal-recovery-folder/</code> for&nbsp;example).</li>
<li>Set up the <code>recovery.conf</code> file properly. If you know something nasty happened at 2018-01-29 08:00:00, try to recover right to that point (or to any other, as <a href="https://www.postgresql.org/docs/9.6/static/recovery-target-settings.html">described in the documentation</a>).</li>
</ul>
<!-- -->

<div class="highlight"><pre><span></span><span class="nv">restore_command</span> <span class="o">=</span> <span class="s1">&#39;cp /your-wal-recovery-folder/%f &quot;%p&quot;&#39;</span>
<span class="nv">recovery_target_time</span> <span class="o">=</span> <span class="s1">&#39;2018-01-29 08:00:00&#39;</span>
</pre></div>


<ul>
<li>Start the database cluster again. It is going to boot to the last full backup and then play all the <span class="caps">WAL</span> segments until the recovery target. Depending on how many <span class="caps">WAL</span> segments are about to be used, this might take a&nbsp;while.</li>
</ul>
<h2>Pitfalls</h2>
<p>You don&#8217;t want to find yourself in the middle of the biggest database failure of the century just to find out your <strong>backups don&#8217;t work</strong>, and even if they did, you would have <strong>no idea how to use them</strong>. Or, even worse, there are no backups at all, because your <strong>backup strategy has been failing silently</strong> without a single notice for several&nbsp;months.</p>
<h2>Tips</h2>
<p>Try to recover from your backups once in a&nbsp;while.</p>
<p>I forget things and make mistakes. We all do. That&#8217;s why I built an ensemble that takes care of our database automatically. Nothing fancy, just a bunch of good old Bash scripts managed with systemd rathern than cron. Next time, I&#8217;d like to show you the code and walk you through our current&nbsp;setup.</p>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2018/postgresql-backup-and-recovery-orchestration-wal-archiving/" rel="bookmark" title="Permalink to PostgreSQL Backup and Recovery Orchestration: WAL Archiving">PostgreSQL Backup and Recovery Orchestration: <span class="caps">WAL</span>&nbsp;Archiving</a></h1>
    <aside><span>Feb 12, 2018</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/postgresql.html">postgresql</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/linux.html">linux</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/sql.html">SQL</a></span>
    </aside>
    <p>Just a very few of my day-to-day work tasks can be accomplished without PostgreSQL. For years I&#8217;ve been a (power) user of this wonderful relational database, knowing almost nothing about how its internals really work. Faced with the need to build a backup and recovery strategy, I&#8217;ve recently read up <em>a lot</em> on this&nbsp;topic.</p>
<p>As I don&#8217;t find it very odd for a <span class="caps">GIS</span> person to be given such an extraordinary task (nobody wants to lose the priceless spatial data, right?), I hope this series might shed light on how to prepare and manage the backup/recovery process to those, who are up to such a task. I won&#8217;t be discussing backup strategies based on <code>pg_backup</code> tool, as those don&#8217;t offer neither continuous archivation, nor point-in-time-recovery (<span class="caps">PITR</span>) - those two features disqualifies it as <a href="https://www.clevermaps.cz">CleverMaps</a> production backup&nbsp;strategy.</p>
<p><strong>That leaves us with taking periodic base backups combined with continuous <span class="caps">WAL</span> archivation, as described&nbsp;below.</strong></p>
<h2>Taking base&nbsp;backups</h2>
<p>Archived <span class="caps">WAL</span> segments are worthless without a base backup they can be run on. It&#8217;s crucial to have consistent, periodic base backups to keep your data&nbsp;safe.</p>
<p><a href="https://www.postgresql.org/docs/current/static/app-pgbasebackup.html"><code>pg_basebackup</code></a> takes base backup of PostgreSQL cluster. Nothing fancy. Gzipping the output folder once the backup is done is definitely a good&nbsp;idea.</p>
<div class="highlight"><pre><span></span>pg_basebackup <span class="se">\</span>
    --pgdata<span class="o">=</span>/mnt/backup/base/backup_number <span class="se">\</span>
    --format<span class="o">=</span>plain <span class="se">\</span>
    --write-recovery-conf <span class="se">\</span>
    --xlog-method<span class="o">=</span>stream <span class="se">\</span>
    --label<span class="o">=</span><span class="si">${</span><span class="nv">CR_LABEL</span><span class="si">}</span> <span class="se">\</span>
    --checkpoint<span class="o">=</span>fast <span class="se">\</span>
    --progress <span class="se">\</span>
    --verbose
</pre></div>


<p>In our current environment, we take a base backup of each of our clusters once a&nbsp;week.</p>
<h2><span class="caps">WAL</span> archiving&nbsp;configuration</h2>
<p>To properly set <span class="caps">WAL</span> archiving, several <code>postgresql.conf</code> settings has to be&nbsp;adjusted:</p>
<ul>
<li><code>wal_level = replica</code></li>
<li><code>archive_mode = on</code></li>
<li><code>archive_command = test ! -f /backup/wal/%f &amp;&amp; cp %p /backup/wal/%f</code></li>
</ul>
<p>Setting <code>wal_level</code> to <code>replica</code> writes enough information for <span class="caps">WAL</span> archiving. Turning on <code>archive_mode</code> will run <code>archive_command</code> each time a <span class="caps">WAL</span> segment is completed. <code>archive_command</code> might be anything from simple <code>cp</code> to <code>rsync</code> or <code>aws s3 cp</code> commands. It is absolutely critical that the command returns <strong>non-zero exit code</strong> in case of failure (including when a file with the same name already exists in your backup&nbsp;folder).</p>
<p>That&#8217;s it, after reloading PostgreSQL service, new <span class="caps">WAL</span> files should be copied to <code>/backup/wal</code> directory. The PostgreSQL process user (<code>postgres</code> usually) has to be able to write to the&nbsp;location.</p>
<h3>Pitfalls</h3>
<ul>
<li>If <code>archive_command</code> fails, <span class="caps">WAL</span> segment remains on your database drive. If it keeps failing long enough, you&#8217;ll run out of space and the database will&nbsp;crash.</li>
<li>If the backup location fills up, the above-mentioned happens as&nbsp;well.</li>
<li>If you lose or corrupt any of the archived <span class="caps">WAL</span> segments, you won&#8217;t be able to pass through. That&#8217;s why you want to be sure that your <code>archive_command</code> actually does what you think it&nbsp;does.</li>
</ul>
<h3>Tips</h3>
<p>It might be a real <span class="caps">PITA</span> (fiddling around <span class="caps">WAL</span> segments included) to start a crashed database cluster with no space left. Keeping a dummy file in your <code>pg_xlog</code> location might save you a lot of trouble. Create one with following command. If you run out of space, remove this file and you get 300 <span class="caps">MB</span> for free. Don&#8217;t forget to recreate it after you start the&nbsp;cluster.</p>
<div class="highlight"><pre><span></span>dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/path_to_your_database_cluster/pg_xlog/DO_NOT_MOVE_THIS_FILE <span class="nv">bs</span><span class="o">=</span>1MB <span class="nv">count</span><span class="o">=</span><span class="m">300</span>
</pre></div>


<p>There&#8217;s no need to keep archived <span class="caps">WAL</span> segments forever. They&#8217;re only needed until you take another base backup. Again, deleting <span class="caps">WAL</span> segments manually (or using <code>find ! -newer previous_base_backup.tar.gz</code>) might lead to accidental corruption of your backups. It&#8217;s much safer to use <a href="https://www.postgresql.org/docs/9.6/static/pgarchivecleanup.html"><code>pg_archivecleanup</code></a> pointed to your <span class="caps">WAL</span> backup folder, referencing the last <strong>sucessful</strong> full backup. Below is the script we use to keep our <span class="caps">WAL</span> backup folder of reasonable size, keeping the last three full&nbsp;backups.</p>
<div class="highlight"><pre><span></span><span class="c1"># Find base_backup files not older than 3 weeks</span>
<span class="c1"># Sort by date</span>
<span class="c1"># Use the oldest one as a reference</span>
<span class="nv">OLDEST_BASE_BACKUP</span><span class="o">=</span><span class="k">$(</span>basename <span class="k">$(</span>find <span class="si">${</span><span class="nv">CR_WAL_BACKUP_DIR</span><span class="si">}</span>/u/p/ -type f -iname <span class="s2">&quot;*.backup&quot;</span> -mtime -21 -print0 <span class="p">|</span> <span class="se">\</span>
xargs -0 ls -t <span class="p">|</span> <span class="se">\</span>
tail -n <span class="m">1</span><span class="k">))</span>

<span class="c1"># Find all subfolders</span>
<span class="c1"># Except the u/p backup subfolder</span>
<span class="c1"># Execute pg_archivecleanup for each of the subfolders</span>
find <span class="nv">$CR_WAL_BACKUP_DIR</span> <span class="se">\</span>
    -type d <span class="se">\</span>
    -not -path <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CR_WAL_BACKUP_DIR</span><span class="si">}</span><span class="s2">u*&quot;</span> <span class="se">\</span>
    -exec pg_archivecleanup -d <span class="o">{}</span> <span class="nv">$OLDEST_BASE_BACKUP</span> <span class="se">\;</span>
</pre></div>


<p>Functional backups are crucial part of a solid backup/recovery system. They&#8217;re still just one half of that system, though. <strong>If not tested thoroughly</strong>, they&#8217;re even less than that. More on testing backups and recovering from failures next&nbsp;time.</p>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/serving-mapbox-vector-tiles-with-postgis-nginx-and-python-backend/" rel="bookmark" title="Permalink to Serving Mapbox Vector Tiles with PostGIS, Nginx and Python Backend">Serving Mapbox Vector Tiles with PostGIS, Nginx and Python&nbsp;Backend</a></h1>
    <aside><span>Oct 23, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/postgis.html">postgis</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/python.html">python</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/sql.html">SQL</a></span>
    </aside>
    <p><a href="({filename}../2017/postgis-as-a-mapbox-vector-tiles-generator.md)">Since version 2.4.0, PostGIS can serve <span class="caps">MVT</span></a> data directly. <span class="caps">MVT</span> returning queries put heavy workload on the database though. On top of that, each of the query has to be run again every time a client demands the data. This leaves us with plenty of room to optimize the&nbsp;process.</p>
<div class="text-center"><img data-echo="/posts/assets/serving-mapbox-vector-tiles-with-postgis-nginx-and-python-backend/election.gif"/></div>

<p>During the last week, while working on the Czech legislative election data visualization, I&#8217;ve struggled with the server becoming unresponsive far too often due to the issues mentioned&nbsp;above.</p>
<div class="text-center"><img data-echo="/posts/assets/serving-mapbox-vector-tiles-with-postgis-nginx-and-python-backend/schema.png"/></div>

<p>According to the schema, the first client to come to the&nbsp;server:</p>
<ul>
<li>goes through filesystem unstopped, because there are no cached files&nbsp;yet,</li>
<li>continues to the Flask backend and asks for a file at <code>{z}/{x}/{y}</code>,</li>
<li>Flask backend asks the database to return the <span class="caps">MVT</span> for the given&nbsp;tile,</li>
<li>Flask backend writes the response to the filesystem and sends it to the&nbsp;client.</li>
</ul>
<p>Other clients get tiles directly from the filesystem, leaving the database at&nbsp;ease.</p>
<h2>Nginx</h2>
<p>Nginx is fairly simple to set up, once you know what you&#8217;re doing. The <code>/volby-2017/municipality/</code> location serves static <span class="caps">MVT</span> from the given alias directory. If not found, the request is passed to <code>@postgis</code> location, that asks the Flask backend for the&nbsp;response.</p>
<div class="highlight"><pre><span></span>server election <span class="o">{</span>
    location /volby-2017/municipality <span class="o">{</span>
            <span class="nb">alias</span> /opt/volby-cz-2017/server/cache/<span class="p">;</span>
            try_files <span class="nv">$uri</span> @postgis<span class="p">;</span>
    <span class="o">}</span>

    location @postgis <span class="o">{</span>
            include uwsgi_params<span class="p">;</span>
            uwsgi_pass <span class="m">127</span>.0.0.1:5000<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2>Flask&nbsp;backend</h2>
<script src="https://gist.github.com/zimmicz/46485676e1cf3d6566f0aaa7f93f055b.js"></script>

<h2>Generating static <span class="caps">MVT</span> in&nbsp;advance</h2>
<p>If you&#8217;re going to serve static tiles that don&#8217;t change often, it might be a good idea to use PostGIS to create files in advance and serve them with&nbsp;Nginx.</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">tiles</span> <span class="p">(</span>
    <span class="n">x</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">y</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">z</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">west</span> <span class="nb">numeric</span><span class="p">,</span>
    <span class="n">south</span> <span class="nb">numeric</span><span class="p">,</span>
    <span class="n">east</span> <span class="nb">numeric</span><span class="p">,</span>
    <span class="n">north</span> <span class="nb">numeric</span><span class="p">,</span>
    <span class="n">geom</span> <span class="n">geometry</span><span class="p">(</span><span class="n">POLYGON</span><span class="p">,</span> <span class="mi">3857</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>


<p>Using <a href="https://github.com/mapbox/mercantile">mercantile</a>, you can create the <code>tiles</code> table holding the bounding boxes of the tiles you need. PostGIS them inserts the actual <span class="caps">MVT</span> into the <code>mvt</code> table.</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TEMPORARY</span> <span class="k">TABLE</span> <span class="n">tmp_tiles</span> <span class="k">AS</span>
    <span class="k">SELECT</span>
        <span class="n">muni</span><span class="p">.</span><span class="n">muni_id</span><span class="p">,</span>
        <span class="n">prc</span><span class="p">.</span><span class="k">data</span><span class="p">,</span>
        <span class="n">ST_AsMVTGeom</span><span class="p">(</span>
            <span class="n">muni</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span>
            <span class="n">TileBBox</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span> <span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">3857</span><span class="p">),</span>
            <span class="mi">4096</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="k">false</span>
        <span class="p">)</span> <span class="n">geom</span><span class="p">,</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">y</span><span class="p">,</span>
        <span class="n">z</span>
    <span class="k">FROM</span> <span class="n">muni</span>
    <span class="k">JOIN</span> <span class="p">(</span>
        <span class="k">SELECT</span>
            <span class="n">x</span><span class="p">,</span>
            <span class="n">y</span><span class="p">,</span>
            <span class="n">z</span><span class="p">,</span>
            <span class="n">geom</span>
        <span class="k">FROM</span> <span class="n">tiles</span>
    <span class="p">)</span> <span class="n">bbox</span> <span class="k">ON</span> <span class="p">(</span><span class="n">ST_Intersects</span><span class="p">(</span><span class="n">muni</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">bbox</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span>
    <span class="k">JOIN</span> <span class="n">party_results_cur</span> <span class="n">prc</span> <span class="k">ON</span> <span class="p">(</span><span class="n">muni</span><span class="p">.</span><span class="n">muni_id</span> <span class="o">=</span> <span class="n">prc</span><span class="p">.</span><span class="n">muni_id</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">mvt</span> <span class="p">(</span><span class="n">mvt</span> <span class="n">bytea</span><span class="p">,</span> <span class="n">x</span> <span class="nb">integer</span><span class="p">,</span> <span class="n">y</span> <span class="nb">integer</span><span class="p">,</span> <span class="n">z</span> <span class="nb">integer</span><span class="p">);</span>
<span class="k">DO</span>
<span class="err">$$</span>
<span class="k">DECLARE</span> <span class="n">r</span> <span class="n">record</span><span class="p">;</span>
<span class="k">BEGIN</span>
<span class="k">FOR</span> <span class="n">r</span> <span class="k">in</span> <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="k">FROM</span> <span class="n">tmp_tiles</span> <span class="n">LOOP</span>
    <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">mvt</span>
    <span class="k">SELECT</span> <span class="n">ST_AsMVT</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="s1">&#39;municipality&#39;</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="s1">&#39;geom&#39;</span><span class="p">),</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">z</span>
    <span class="k">FROM</span> <span class="p">(</span>
        <span class="k">SELECT</span>
            <span class="n">muni_id</span><span class="p">,</span>
            <span class="k">data</span><span class="p">,</span>
            <span class="n">geom</span>
        <span class="k">FROM</span> <span class="n">tmp_tiles</span>
        <span class="k">WHERE</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="p">)</span> <span class="n">q</span><span class="p">;</span>
    <span class="n">RAISE</span> <span class="n">INFO</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
<span class="k">END</span> <span class="n">LOOP</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$$</span><span class="p">;</span>
</pre></div>


<p>Once filled, the table rows can be written to the filesystem with the simple piece of Python&nbsp;code.</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">text</span>

<span class="n">CACHE_PATH</span><span class="o">=</span><span class="s2">&quot;cache/&quot;</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;postgresql:///&#39;</span><span class="p">)</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="n">sql</span><span class="o">=</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT mvt, x, y, z FROM mvt&quot;</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="n">cachefile</span> <span class="o">=</span> <span class="s2">&quot;{}/{}/{}/{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CACHE_PATH</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">print</span><span class="p">(</span><span class="n">cachefile</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;{}/{}/{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CACHE_PATH</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;{}/{}/{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CACHE_PATH</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cachefile</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>


<h2>Conclusion</h2>
<p>PostGIS is a brilliant tool for generating Mapbox vector tiles. Combined with Python powered static file generator and Nginx, it seems to become the only tool needed to get you&nbsp;going.</p>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/postgresql-dollar-quoting-inside-bash-heredoc/" rel="bookmark" title="Permalink to PostgreSQL Dollar Quoting inside Bash Heredoc">PostgreSQL Dollar Quoting inside Bash&nbsp;Heredoc</a></h1>
    <aside><span>Sep 22, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/sql.html">sql</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/postgresql.html">postgresql</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/bash.html">bash</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/sql.html">SQL</a></span>
    </aside>
    <p>Yesterday I spent two very unpleasant hours debugging the weirdest <span class="caps">SQL</span> error I&#8217;ve seen in my life, running the below query (simplified for this&nbsp;post).</p>
<div class="highlight"><pre><span></span><span class="n">psql</span> <span class="o">-</span><span class="n">qAt</span> <span class="c1">--no-psqlrc &lt;&lt;BACKUP</span>
<span class="k">DO</span>
<span class="err">$$</span>
<span class="k">DECLARE</span> <span class="n">r</span> <span class="n">record</span><span class="p">;</span>
<span class="k">BEGIN</span>
  <span class="n">RAISE</span> <span class="n">INFO</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">;</span>
<span class="k">END</span>
<span class="err">$$</span><span class="p">;</span>
<span class="n">BACKUP</span>
</pre></div>


<p>Running this in your terminal will result in a nasty syntax&nbsp;error.</p>
<div class="highlight"><pre><span></span>ERROR:  syntax error at or near <span class="s2">&quot;1111&quot;</span>
LINE <span class="m">2</span>: <span class="m">1111</span>
        ^
ERROR:  syntax error at or near <span class="s2">&quot;RAISE&quot;</span>
LINE <span class="m">2</span>:   RAISE INFO <span class="s1">&#39;%&#39;</span>, <span class="s1">&#39;info&#39;</span><span class="p">;</span>
          ^
ERROR:  syntax error at or near <span class="s2">&quot;1111&quot;</span>
LINE <span class="m">2</span>: <span class="m">1111</span><span class="p">;</span>
</pre></div>


<p>You stare on the screen for a while, absolutely sure that number <code>1111</code> is nowhere close to the data you work with. You try again. Another error. You save the code into a file and try again. It works. What the <em>heck</em>? You try again using the bash heredoc. Another&nbsp;failure.</p>
<p>The minute you realize <code>$$</code> is being substituted with the <span class="caps">ID</span> of the current process, you feel like the dumbest person on Earth. Yet the happiest one at the same&nbsp;time.</p>
<p>The solution is&nbsp;trivial.</p>
<div class="highlight"><pre><span></span><span class="n">psql</span> <span class="o">-</span><span class="n">qAt</span> <span class="c1">--no-psqlrc &lt;&lt;BACKUP</span>
<span class="k">DO</span>
<span class="err">\$\$</span>
<span class="k">DECLARE</span> <span class="n">r</span> <span class="n">record</span><span class="p">;</span>
<span class="k">BEGIN</span>
  <span class="n">RAISE</span> <span class="n">INFO</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">;</span>
<span class="k">END</span>
<span class="err">\$\$</span><span class="p">;</span>
<span class="n">BACKUP</span>
</pre></div>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/postgresql-development-history-revealed-with-postgresql/" rel="bookmark" title="Permalink to PostgreSQL Development History Revealed with PostgreSQL">PostgreSQL Development History Revealed with&nbsp;PostgreSQL</a></h1>
    <aside><span>Aug 9, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/postgresql.html">postgresql</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/python.html">python</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/sql.html">SQL</a></span>
    </aside>
    <p>I spend a lot of time reading <a href="https://www.postgresql.org/docs/manuals/">PostgreSQL docs</a>. It occurred to me just a few weeks ago that those versioned manuals are great opportunity to get an insight into PostgreSQL development history. Using PostgreSQL, of&nbsp;course.</p>
<h2><span class="caps">TOP</span> 5 functions with the most verbose docs in each&nbsp;version</h2>
<div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="k">version</span><span class="p">,</span>
    <span class="n">string_agg</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39; | &#39;</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">letter_count</span> <span class="k">DESC</span><span class="p">)</span>
<span class="k">FROM</span> <span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="k">version</span><span class="p">,</span>
        <span class="n">func</span><span class="p">,</span>
        <span class="n">letter_count</span><span class="p">,</span>
        <span class="n">row_number</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="k">version</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">letter_count</span> <span class="k">DESC</span><span class="p">)</span>
    <span class="k">FROM</span> <span class="n">postgresql_development</span><span class="p">.</span><span class="k">data</span>
<span class="p">)</span> <span class="n">a</span>
<span class="k">WHERE</span> <span class="n">row_number</span> <span class="o">&lt;=</span> <span class="mi">10</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">version</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">version</span> <span class="k">DESC</span>
</pre></div>


<p>Seems like a huge comeback for <code>CREATE TABLE</code>.</p>
<table>
<thead>
<tr>
<th><span class="caps">VERSION</span></th>
<th>1st</th>
<th>2nd</th>
<th>3rd</th>
<th>4th</th>
<th>5th</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.0</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>9.6</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>9.5</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>9.4</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>9.3</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">DEFAULT</span> <span class="caps">PRIVILEGES</span></td>
</tr>
<tr>
<td>9.2</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">DEFAULT</span> <span class="caps">PRIVILEGES</span></td>
</tr>
<tr>
<td>9.1</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">DEFAULT</span> <span class="caps">PRIVILEGES</span></td>
</tr>
<tr>
<td>9.0</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">DEFAULT</span> <span class="caps">PRIVILEGES</span></td>
</tr>
<tr>
<td>8.4</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>8.3</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">COMMENT</span></td>
</tr>
<tr>
<td>8.2</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>8.1</td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>8</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
</tr>
<tr>
<td>7.4</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">GRANT</span></td>
<td><span class="caps">SELECT</span></td>
</tr>
<tr>
<td>7.3</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">REVOKE</span></td>
<td><span class="caps">GRANT</span></td>
</tr>
<tr>
<td>7.2</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span> <span class="caps">INTO</span></td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TYPE</span></td>
</tr>
<tr>
<td>7.1</td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">SELECT</span> <span class="caps">INTO</span></td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TYPE</span></td>
<td><span class="caps">ALTER</span> <span class="caps">TABLE</span></td>
</tr>
<tr>
<td>7.0</td>
<td><span class="caps">SELECT</span></td>
<td><span class="caps">SELECT</span> <span class="caps">INTO</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TYPE</span></td>
<td><span class="caps">CREATE</span> <span class="caps">TABLE</span></td>
<td><span class="caps">COMMENT</span></td>
</tr>
</tbody>
</table>
<h2>Number of functions available in each&nbsp;version</h2>
<div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="k">version</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="n">func</span><span class="p">),</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">letter_count</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">postgresql_development</span><span class="p">.</span><span class="k">data</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">version</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">version</span><span class="p">;</span>
</pre></div>


<div class="text-center"><img data-echo="/posts/assets/postgresql-development-history-revealed-with-postgresql/plot1.png"/></div>

<h2>The most verbose docs in each&nbsp;version</h2>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">ON</span> <span class="p">(</span><span class="k">version</span><span class="p">)</span>
    <span class="k">version</span><span class="p">,</span>
    <span class="n">func</span><span class="p">,</span>
    <span class="n">letter_count</span>
<span class="k">FROM</span> <span class="n">postgresql_development</span><span class="p">.</span><span class="k">data</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">version</span><span class="p">,</span> <span class="n">letter_count</span> <span class="k">DESC</span><span class="p">;</span>
</pre></div>


<p>Poor <code>REVOKE</code>, the defeated&nbsp;champion.</p>
<div class="text-center">
    <table style="margin-left:auto; margin-right: auto">
    <thead>
    <tr>
    <th><span class="caps"><span class="caps">VERSION</span></span></th>
    <th><span class="caps"><span class="caps">FUNCTION</span></span></th>
    <th><span class="caps"><span class="caps">LETTER</span></span> <span class="caps"><span class="caps">COUNT</span></span></th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td>10</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>3142</td>
    </tr>
    <tr>
    <td>9.6</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.5</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.4</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.3</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.2</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2856</td>
    </tr>
    <tr>
    <td>9.1</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2508</td>
    </tr>
    <tr>
    <td>9</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2502</td>
    </tr>
    <tr>
    <td>8.4</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>2105</td>
    </tr>
    <tr>
    <td>8.3</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>1485</td>
    </tr>
    <tr>
    <td>8.2</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>1527</td>
    </tr>
    <tr>
    <td>8.1</td>
    <td><span class="caps"><span class="caps">REVOKE</span></span></td>
    <td>1312</td>
    </tr>
    <tr>
    <td>8</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>1251</td>
    </tr>
    <tr>
    <td>7.4</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>1075</td>
    </tr>
    <tr>
    <td>7.3</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>929</td>
    </tr>
    <tr>
    <td>7.2</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>929</td>
    </tr>
    <tr>
    <td>7.1</td>
    <td><span class="caps"><span class="caps">CREATE</span></span> <span class="caps"><span class="caps">TABLE</span></span></td>
    <td>871</td>
    </tr>
    <tr>
    <td>7</td>
    <td><span class="caps"><span class="caps">SELECT</span></span></td>
    <td>450</td>
    </tr>
    </tbody>
    </table>
</div>

<h2><span class="caps">CREATE</span> <span class="caps">TABLE</span> docs&nbsp;evolution</h2>
<div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="k">version</span><span class="p">,</span>
    <span class="n">letter_count</span>
<span class="k">FROM</span> <span class="n">postgresql_development</span><span class="p">.</span><span class="k">data</span>
<span class="k">WHERE</span> <span class="n">func</span> <span class="o">=</span> <span class="s1">&#39;CREATE TABLE&#39;</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">func</span><span class="p">,</span> <span class="k">version</span><span class="p">;</span>
</pre></div>


<p>Something&#8217;s going on in an upcoming 10.0&nbsp;version.</p>
<div class="text-center"><img data-echo="/posts/assets/postgresql-development-history-revealed-with-postgresql/plot2.png"/></div>

<p>All the data was obtained with the following Python script and processed inside the PostgreSQL database. Plots done with <a href="http://bokeh.pydata.org/en/latest/">Bokeh</a>, though I probably wouldn&#8217;t use it again, the docs site is absurdly sluggish and the info is just all over the&nbsp;place.</p>
<script src="https://gist.github.com/zimmicz/f69a5ce5d3cf3a220e171553c35e0391.js"></script>
</article>
<aside id="pagination">
            <a href="https://www.zimmi.cz/posts/category/sql2.html">Next page &raquo;</a>
</aside>    </main>
    <footer>
        Written by <a href="//www.zimmi.cz">Michal Zimmermann</a>.
        Proudly powered by <a href="//getpelican.com/">Pelican</a>,
        which takes great advantage of <a href="//python.org">Python</a>.
    </footer>
<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-43432739-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments)};
  gtag('js', new Date());

  gtag('config', 'UA-43432739-2');
</script>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NW8R37N');</script>
<!-- End Google Tag Manager -->
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NW8R37N"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<script src="https://www.zimmi.cz/posts/theme/js/echo.min.js"></script>
<script>
echo.init({
  offset: 200,
  throttle: 250,
  unload: false
});
</script>
</body>
</html>